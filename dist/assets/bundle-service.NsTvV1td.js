import{c as v,e as T,s as m,q as D,f as I,g as A,l as N,h as Q,d as B,j as k,u as C,k as $}from"./firebase-vendor.D8xw0AXf.js";import{h as y,v as M}from"./index.B3OoR7j1.js";import"./query-vendor.DpsghfSz.js";import"./react-vendor.CfKEcsXX.js";import"./ui-vendor.D5U9TC-3.js";import"./utils-vendor.B0NEtgzl.js";class E{collection="bundles";productionBundlesCollection="production_bundles";async createBundle(t,e){try{const o={bundleNumber:t.bundleNumber,description:t.description,quantity:t.quantity,unitPrice:t.unitPrice,totalValue:t.quantity*t.unitPrice,status:"planning",priority:t.priority,startDate:null,dueDate:t.dueDate,completionDate:null,assignedOperators:[],currentOperatorId:null,completedQuantity:0,defectQuantity:0,qualityScore:0,estimatedHours:t.estimatedHours,actualHours:0,workSessions:[],qualityChecks:[],createdAt:new Date,updatedAt:new Date,createdBy:e,notes:t.notes||"",attachments:[],tags:t.tags||[]};return(await v(T(y,this.collection),{...o,createdAt:m(),updatedAt:m()})).id}catch(o){throw console.error("Error creating bundle:",o),o}}async getBundles(t){try{let e=D(T(y,this.collection),I("createdAt","desc"));return t?.status&&(e=D(e,A("status","==",t.status))),t?.assignedTo&&(e=D(e,A("assignedOperators","array-contains",t.assignedTo))),t?.priority&&(e=D(e,A("priority","==",t.priority))),t?.limit&&(e=D(e,N(t.limit))),(await Q(e)).docs.map(r=>({id:r.id,...r.data(),createdAt:r.data().createdAt?.toDate()||new Date,updatedAt:r.data().updatedAt?.toDate()||new Date,startDate:r.data().startDate?r.data().startDate.toDate():null,dueDate:r.data().dueDate.toDate(),completionDate:r.data().completionDate?r.data().completionDate.toDate():null}))}catch(e){throw console.error("Error getting bundles:",e),e}}async getBundleLifecycle(t){const e=await this.getBundleById(t);return e?{id:e.id,bundleId:e.bundleNumber,description:e.description,totalQuantity:e.quantity,completedQuantity:Math.floor(e.quantity*.3),currentStage:{id:"stage_1",name:"Cutting",nameNepali:"काट्ने",sequence:1,status:"in_progress",requiredQuantity:e.quantity,completedQuantity:Math.floor(e.quantity*.3)},stages:[{id:"stage_1",name:"Cutting",nameNepali:"काट्ने",sequence:1,status:"in_progress",requiredQuantity:e.quantity,completedQuantity:Math.floor(e.quantity*.3),machineType:"cutting_machine",estimatedHours:8,actualHours:3},{id:"stage_2",name:"Sewing",nameNepali:"सिलाई",sequence:2,status:"pending",requiredQuantity:e.quantity,completedQuantity:0,machineType:"sewing_machine",estimatedHours:16}],priority:e.priority,status:e.status==="planning"?"draft":"active",createdAt:e.createdAt,targetCompletionDate:e.dueDate,estimatedCompletionDate:e.dueDate,assignedOperators:e.assignedTo?[e.assignedTo]:[],notes:`Bundle ${e.bundleNumber} - ${e.description}`,qualityRequirements:[],costBreakdown:{materialCost:e.unitPrice*.6,laborCost:e.unitPrice*.3,overheadCost:e.unitPrice*.1,totalCost:e.unitPrice},attachments:[]}:null}async createBundleLifecycle(t){const e={bundleNumber:t.bundleId||`BDL${Date.now()}`,description:t.description||"New Bundle",quantity:t.totalQuantity||1,unitPrice:t.costBreakdown?.totalCost||0,priority:t.priority||"medium",dueDate:t.targetCompletionDate||new Date},o=await this.createBundle(e,"system");return this.getBundleLifecycle(o)}async updateBundleLifecycle(t,e){const o={description:e.description,quantity:e.totalQuantity,priority:e.priority,status:e.status==="draft"?"planning":"in-progress",dueDate:e.targetCompletionDate};return await this.updateBundle(t,o),this.getBundleLifecycle(t)}async getBundleById(t){try{const e=B(y,this.collection,t),o=await k(e);if(!o.exists())return null;const r=o.data();return{id:o.id,...r,createdAt:r.createdAt?.toDate()||new Date,updatedAt:r.updatedAt?.toDate()||new Date,startDate:r.startDate?r.startDate.toDate():null,dueDate:r.dueDate.toDate(),completionDate:r.completionDate?r.completionDate.toDate():null}}catch(e){throw console.error("Error getting bundle:",e),e}}async updateBundle(t,e){try{const o=B(y,this.collection,t);await C(o,{...e,updatedAt:m(),...e.quantity&&e.unitPrice&&{totalValue:e.quantity*e.unitPrice}})}catch(o){throw console.error("Error updating bundle:",o),o}}async startWork(t,e,o){try{const r=B(y,this.collection,t),l=await this.getBundleById(t);if(!l)throw new Error("Bundle not found");const i={id:`session-${Date.now()}`,operatorId:e,operatorName:o,startTime:new Date,endTime:null,duration:0,quantityCompleted:0,defectQuantity:0,notes:"",isActive:!0},p=[...l.workSessions||[],i],d=Array.from(new Set([...l.assignedOperators,e]));await C(r,{status:"in-progress",startDate:l.startDate||m(),currentOperatorId:e,assignedOperators:d,workSessions:p,updatedAt:m()})}catch(r){throw console.error("Error starting work:",r),r}}async endWork(t,e,o,r=0,l=""){try{const i=await this.getBundleById(t);if(!i)throw new Error("Bundle not found");const p=i.workSessions.map(u=>{if(u.id===e&&u.isActive){const h=new Date,f=Math.round((h.getTime()-u.startTime.getTime())/(1e3*60));return{...u,endTime:h,duration:f,quantityCompleted:o,defectQuantity:r,notes:l,isActive:!1}}return u}),d=i.completedQuantity+o,n=i.defectQuantity+r,a=p.reduce((u,h)=>u+h.duration,0)/60,s=d>=i.quantity?"completed":"in-progress",g=s==="completed"?new Date:null,w=d>0?Math.max(0,100-n/d*100):100,q=B(y,this.collection,t);await C(q,{workSessions:p,completedQuantity:d,defectQuantity:n,actualHours:a,qualityScore:Math.round(w),status:s,completionDate:g?m():null,currentOperatorId:s==="completed"?null:i.currentOperatorId,updatedAt:m()})}catch(i){throw console.error("Error ending work:",i),i}}async deleteBundle(t){try{const e=B(y,this.collection,t);await $(e)}catch(e){throw console.error("Error deleting bundle:",e),e}}async generateBundles(t){try{const e=[],o=t.articles.map(a=>M.getTemplate(a.templateId)),r=await Promise.all(o),l=new Map;for(let a=0;a<r.length;a++){const s=r[a];s.success&&s.data&&l.set(t.articles[a].templateId,s.data)}let i=1;for(const a of t.articles){const s=l.get(a.templateId);if(!s)return{success:!1,error:`Template not found for article ${a.articleNumber}`};for(const g of t.fabricRolls)for(const w of a.sizes){const q=g.layerCount,u=Math.round(w.quantity/t.fabricRolls.reduce((f,S)=>f+S.layerCount,0)),h=q*u;for(let f=0;f<h;f++){const S=`Bundle-${a.articleNumber.replace(/[^A-Za-z0-9]/g,"")}-${w.size}-${String(i).padStart(3,"0")}`,R=s.operations.map((c,P)=>({id:`${S}-OP-${P+1}`,bundleId:"",operationId:c.id,name:c.name,nameNepali:c.nameNepali||"",description:c.description,machineType:c.machineType,sequenceOrder:c.sequenceOrder||P+1,pricePerPiece:c.pricePerPiece,smvMinutes:c.smvMinutes,status:"pending",prerequisites:c.prerequisites||[],isOptional:c.isOptional||!1,qualityCheckRequired:c.qualityCheckRequired||!1,defectTolerance:c.defectTolerance||5,notes:c.notes})),b={id:`bundle_${Date.now()}_${i}`,bundleNumber:S,articleId:a.articleId,articleNumber:a.articleNumber,articleStyle:a.articleStyle,size:w.size,rollId:g.rollId,rollNumber:g.rollNumber,rollColor:g.color,templateId:a.templateId,templateName:s.templateName,templateCode:s.templateCode,status:"created",priority:"normal",operations:R,createdAt:new Date,createdBy:t.createdBy,totalValue:s.totalPricePerPiece||0,totalSMV:s.totalSmv||0,piecesPerBundle:1,sourceRollLayers:q,sizeRatio:u};b.operations.forEach(c=>{c.bundleId=b.id}),e.push(b),i++}}}const p=e.map(async a=>{try{return{success:!0,id:(await v(T(y,this.productionBundlesCollection),{...a,createdAt:m()})).id}}catch(s){return{success:!1,error:s}}}),n=(await Promise.all(p)).filter(a=>!a.success);return n.length>0?{success:!1,error:`Failed to save ${n.length} bundles to database`}:{success:!0,data:e,message:`Successfully generated ${e.length} production bundles`}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Failed to generate bundles"}}}async getBundleAnalytics(){try{const t=await this.getBundles(),e=t.length,o=t.filter(n=>n.status==="completed").length,r=t.filter(n=>n.status==="in-progress").length,l=t.filter(n=>n.status==="completed"&&n.completionDate&&n.startDate),i=l.length>0?l.reduce((n,a)=>{const s=a.completionDate.getTime()-a.startDate.getTime();return n+s/(1e3*60*60*24)},0)/l.length:0,p=t.length>0?t.reduce((n,a)=>n+a.qualityScore,0)/t.length:100,d=t.reduce((n,a)=>n+a.totalValue,0);return{totalBundles:e,completedBundles:o,inProgressBundles:r,averageCompletionTime:Math.round(i*100)/100,averageQualityScore:Math.round(p),totalValue:d}}catch(t){throw console.error("Error getting bundle analytics:",t),t}}}const F=new E;export{F as bundleService};
