import{e as p,h as A,s as m,c as D,d as P,u as f,q as b,f as y,g as h,j as W}from"./firebase-vendor.D8xw0AXf.js";import{h as l}from"./index.B3OoR7j1.js";import"./query-vendor.DpsghfSz.js";import"./react-vendor.CfKEcsXX.js";import"./ui-vendor.D5U9TC-3.js";import"./utils-vendor.B0NEtgzl.js";const v={getWorkBundles:async r=>{try{console.log("ðŸ” Work Assignment Service: Loading production lots (generated bundles)...");const e=p(l,"production_lots");let n=b(e,y("createdAt","desc"));r?.status&&r.status!=="all"&&(n=b(e,h("status","==",r.status),y("createdAt","desc")));const t=await A(n);if(!t.empty){console.log(`âœ… Found ${t.docs.length} production lots`);const i=t.docs.map(u=>{const o=u.data();console.log("ðŸ“¦ Processing production lot for work assignment:",{id:u.id,lotNumber:o.lotNumber,articleNumber:o.articleNumber,totalPieces:o.totalPieces,status:o.status});const g=o.totalPieces||50;console.log(`ðŸ” Production lot ${o.lotNumber}: ${g} pieces`);const k=(o.processSteps||[]).map(a=>({id:a.id||`${u.id}_step_${a.stepNumber}`,name:a.operation||"Operation",description:`${a.operation} - ${a.operationNepali}`,status:a.status==="completed"?"completed":a.assignedOperators?.length>0?"assigned":"pending",operatorId:a.assignedOperators?.[0],machineType:a.machineType||"sewing",timePerPiece:g>0?a.estimatedMinutes/g:3,pricePerPiece:a.pricePerPiece||2,totalPieces:g,completedPieces:a.completedPieces||0,requiredSkill:a.requiredSkill||"basic",stepNumber:a.stepNumber}));return{id:u.id,name:o.lotNumber||`LOT-${u.id.slice(-6)}`,bundleNumber:o.lotNumber||`LOT-${u.id.slice(-6)}`,articleNumber:o.articleNumber||"ART-000",description:o.articleName||"Production Lot",status:o.status==="cutting"?"created":o.status==="in_progress"?"in_progress":o.status==="completed"?"completed":"active",priority:o.priority||"normal",quantity:g,unitPrice:k.reduce((a,w)=>a+w.pricePerPiece,0),totalValue:g*k.reduce((a,w)=>a+w.pricePerPiece,0),garmentType:o.garmentType||"tshirt",colorSizeBreakdown:o.colorSizeBreakdown||[],dueDate:o.dueDate?.toDate?o.dueDate.toDate():new Date(Date.now()+10080*60*1e3),createdAt:o.createdAt?.toDate?o.createdAt.toDate():new Date,workItems:k}});return{success:!0,data:{items:i,total:i.length,page:1,limit:i.length}}}console.log("âš ï¸ No production lots found. Checking WIP entries...");const d=p(l,"production_bundles"),c=b(d,y("createdAt","desc")),s=await A(c);return s.empty?{success:!0,data:{items:[],total:0,page:1,limit:10},message:"No WIP entries or production lots found. Create WIP entries first, then generate bundles using sewing templates."}:(console.log(`ðŸ“¦ Found ${s.docs.length} WIP entries that need bundle generation`),{success:!0,data:{items:[],total:0,page:1,limit:10},message:`Found ${s.docs.length} WIP entries that need to be processed through sewing templates to generate work bundles. Go to Bundle Generation to create production lots first.`})}catch(e){return console.error("âŒ Work Assignment Service: Error loading work bundles:",e),{success:!1,error:e instanceof Error?e.message:"Failed to load work bundles",data:{items:[],total:0,page:1,limit:10}}}},getWorkBundleById:async r=>{try{console.log(`ðŸ” Work Assignment Service: Loading work bundle ${r}...`);const e=P(l,"production_bundles",r),n=await W(e);if(!n.exists())return{success:!1,error:"Work bundle not found"};const t=n.data(),d={id:n.id,name:t.bundleNumber||`WIP-${n.id.slice(-6)}`,bundleNumber:t.bundleNumber||`WIP-${n.id.slice(-6)}`,articleNumber:t.articleNumber||"ART-000",description:t.articleDescription||t.description||"Work Item",status:t.status==="pending"?"created":t.status==="in-progress"?"in_progress":t.status==="completed"?"completed":"active",priority:t.priority||"normal",quantity:t.quantity||0,unitPrice:t.unitPrice||0,totalValue:t.totalValue||0,assignedOperator:t.assignedOperator,dueDate:t.dueDate?.toDate?t.dueDate.toDate():new Date,createdAt:t.createdAt?.toDate?t.createdAt.toDate():new Date,workItems:[{id:`${n.id}_main_work`,name:t.operationName||"Main Operation",description:t.articleDescription||t.description||"Main work item",status:t.assignedOperator?"assigned":"pending",operatorId:t.assignedOperator,machineType:t.machineType||"sewing",timePerPiece:t.timePerPiece||3,pricePerPiece:t.pricePerPiece||t.unitPrice||2,totalPieces:t.quantity||0,completedPieces:t.completedQuantity||0}]};return console.log("âœ… Work Assignment Service: Loaded work bundle:",d.name),{success:!0,data:d}}catch(e){return console.error("âŒ Work Assignment Service: Error loading work bundle:",e),{success:!1,error:e instanceof Error?e.message:"Failed to load work bundle"}}},createWorkBundle:async r=>{try{console.log("ðŸ”§ Work Assignment Service: Creating new work bundle (WIP entry)...");const e={bundleNumber:r.bundleNumber||`WIP-${Date.now()}`,articleNumber:r.articleNumber||"ART-000",articleDescription:r.description||r.name,quantity:r.quantity||0,unitPrice:r.unitPrice||0,totalValue:r.totalValue||r.quantity*r.unitPrice,status:"pending",priority:r.priority||"normal",machineType:r.machineType||"sewing",operationName:r.operationName||"Main Operation",timePerPiece:r.timePerPiece||3,pricePerPiece:r.pricePerPiece||r.unitPrice||0,createdAt:m(),createdBy:r.createdBy||"system",dueDate:r.dueDate||new Date(Date.now()+10080*60*1e3)},n=p(l,"production_bundles"),t=await D(n,e);return console.log("âœ… Work Assignment Service: Created work bundle:",t.id),{success:!0,data:{id:t.id,...e}}}catch(e){return console.error("âŒ Work Assignment Service: Error creating work bundle:",e),{success:!1,error:e instanceof Error?e.message:"Failed to create work bundle"}}},update:async(r,e,n)=>{try{console.log(`ðŸ”§ Work Assignment Service: Updating ${n} ${r}...`);const t=P(l,n,r),d={...e,updatedAt:m()};return await f(t,d),console.log("âœ… Work Assignment Service: Updated document"),{success:!0,data:{id:r,...d}}}catch(t){return console.error("âŒ Work Assignment Service: Error updating document:",t),{success:!1,error:t instanceof Error?t.message:"Failed to update document"}}},getWorkItemsByBundle:async r=>{try{const e=await v.getWorkBundleById(r);return e.success&&e.data?{success:!0,data:e.data.workItems||[]}:{success:!0,data:[]}}catch(e){return console.error("Error getting work items:",e),{success:!1,error:e instanceof Error?e.message:"Failed to get work items",data:[]}}},createWorkItem:async r=>({success:!0,data:{id:"new-work-item-id",...r}}),getAssignments:async r=>{try{console.log("ðŸ” Work Assignment Service: Loading assignments...");const e=p(l,"production_bundles");let n=b(e,y("createdAt","desc"));r?.operatorId&&(n=b(e,h("assignedOperator","==",r.operatorId),y("createdAt","desc")));const t=await A(n);if(t.empty)return{success:!0,data:{items:[],total:0,page:1,limit:10}};const d=t.docs.filter(c=>c.data().assignedOperator).map(c=>{const s=c.data();return{id:`assignment_${c.id}`,workItemId:c.id,operatorId:s.assignedOperator,bundleNumber:s.bundleNumber,articleNumber:s.articleNumber,description:s.articleDescription||s.description,status:s.status==="pending"?"assigned":s.status==="in-progress"?"started":s.status==="completed"?"completed":"assigned",assignedAt:s.assignedAt?.toDate?s.assignedAt.toDate():new Date,dueDate:s.dueDate?.toDate?s.dueDate.toDate():new Date,totalPieces:s.quantity||0,completedPieces:s.completedQuantity||0,timePerPiece:s.timePerPiece||3,pricePerPiece:s.pricePerPiece||s.unitPrice||2}});return console.log(`âœ… Work Assignment Service: Loaded ${d.length} assignments`),{success:!0,data:{items:d,total:d.length,page:1,limit:d.length}}}catch(e){return console.error("âŒ Work Assignment Service: Error loading assignments:",e),{success:!0,data:{items:[],total:0,page:1,limit:10}}}},assignWork:async r=>{try{if(console.log("ðŸ”§ Work Assignment Service: Assigning work to operator..."),!r.bundleId||!r.operatorId)throw new Error("Bundle ID and Operator ID are required");const e=P(l,"production_bundles",r.bundleId);return await f(e,{assignedOperator:r.operatorId,assignedAt:m(),status:"in-progress",updatedAt:m()}),console.log("âœ… Work Assignment Service: Work assigned successfully"),{success:!0,data:{id:`assignment_${r.bundleId}`,bundleId:r.bundleId,operatorId:r.operatorId,status:"assigned"}}}catch(e){return console.error("âŒ Work Assignment Service: Error assigning work:",e),{success:!1,error:e instanceof Error?e.message:"Failed to assign work"}}},completeAssignment:async r=>{try{if(console.log("ðŸ”§ Work Assignment Service: Completing assignment..."),!r.bundleId)throw new Error("Bundle ID is required");const e=P(l,"production_bundles",r.bundleId);return await f(e,{status:"completed",completedAt:m(),completedQuantity:r.completedPieces||0,updatedAt:m()}),console.log("âœ… Work Assignment Service: Assignment completed"),{success:!0,data:{id:r.assignmentId,status:"completed",completedAt:new Date}}}catch(e){return console.error("âŒ Work Assignment Service: Error completing assignment:",e),{success:!1,error:e instanceof Error?e.message:"Failed to complete assignment"}}},createAssignmentRequest:async(r,e,n)=>{try{console.log("ðŸ”§ Work Assignment Service: Creating assignment request...");const t={workItemId:r,operatorId:e,reason:n||"Assignment request",status:"pending",createdAt:m(),requestedBy:e},d=p(l,"assignment_requests"),c=await D(d,t);return console.log("âœ… Work Assignment Service: Assignment request created"),{success:!0,data:{id:c.id,workItemId:r,operatorId:e,reason:n,status:"pending"}}}catch(t){return console.error("âŒ Work Assignment Service: Error creating assignment request:",t),{success:!1,error:t instanceof Error?t.message:"Failed to create assignment request"}}},getAssignmentStatistics:async r=>{try{const e=p(l,"production_bundles"),n=await A(e);if(n.empty)return{success:!0,data:{totalAssignments:0,activeAssignments:0,completedAssignments:0,averageEfficiency:0,onTimeCompletion:0}};const t=n.docs.map(i=>i.data()),d=t.filter(i=>i.assignedOperator),c=t.filter(i=>i.status==="completed"),s=t.filter(i=>i.status==="in-progress");return{success:!0,data:{totalAssignments:d.length,activeAssignments:s.length,completedAssignments:c.length,averageEfficiency:c.length>0?c.reduce((i,u)=>i+(u.completedQuantity||0),0)/c.reduce((i,u)=>i+(u.quantity||0),0)*100:0,onTimeCompletion:c.length>0?c.filter(i=>i.completedAt&&i.dueDate&&i.completedAt<=i.dueDate).length/c.length*100:0}}}catch(e){return console.error("âŒ Work Assignment Service: Error getting statistics:",e),{success:!0,data:{totalAssignments:0,activeAssignments:0,completedAssignments:0,averageEfficiency:0,onTimeCompletion:0}}}}};export{v as workAssignmentService};
