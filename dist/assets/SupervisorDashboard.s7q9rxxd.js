import{j as e}from"./query-vendor.DpsghfSz.js";import{c as Y,r as i}from"./react-vendor.CfKEcsXX.js";import{s as U,n as P}from"./index.CvlZStFR.js";import{p as c,P as h}from"./permission-service.Cx3ms_AT.js";import{L as y}from"./LoadingSpinner.DUO60hBS.js";import{B as d,a as p,C as n}from"./index.CUWf0ERd.js";import{B as M,C as $,S as K,U as J,T as X,I as z,a as Z,b as q,c as ee}from"./ui-vendor.D450QVBF.js";import"./firebase-vendor.D8xw0AXf.js";import"./operator-types.IC8C56sJ.js";import"./notification-service.DEoZgDf9.js";import"./damage-report-service.CW7byCe-.js";import"./operator-wallet-service.BNyduHk2.js";import"./work-assignment-service.uP3JWO5o.js";import"./utils-vendor.B0NEtgzl.js";const Ne=Y.memo(({supervisorId:r})=>{const[g,T]=i.useState(null),[f,I]=i.useState(!0),[O,V]=i.useState(null),[b,k]=i.useState(null),[v,u]=i.useState([]),[se,ae]=i.useState(null),[j,S]=i.useState(null),[A,D]=i.useState(null),[o,C]=i.useState({canViewDashboard:!1,canViewTeam:!1,canAssignWork:!1,canApproveAssignments:!1,canViewTeamPerformance:!1,canManageSchedule:!1,canManageTeamMembers:!1});i.useEffect(()=>{L(),N();let s;return(async()=>{s=await H()})(),()=>{s&&s()}},[r]);const L=async()=>{try{await c.loadUserPermissions(r),C({canViewDashboard:c.hasPermission(r,h.SUPERVISOR_VIEW_DASHBOARD.id),canViewTeam:c.hasPermission(r,h.SUPERVISOR_VIEW_TEAM.id),canAssignWork:c.hasPermission(r,h.SUPERVISOR_ASSIGN_WORK.id),canApproveAssignments:c.hasPermission(r,h.SUPERVISOR_APPROVE_ASSIGNMENTS.id),canViewTeamPerformance:c.hasPermission(r,h.SUPERVISOR_VIEW_TEAM_PERFORMANCE.id),canManageSchedule:c.hasPermission(r,h.SUPERVISOR_MANAGE_TEAM_SCHEDULE.id),canManageTeamMembers:c.hasPermission(r,h.SUPERVISOR_MANAGE_TEAM_SCHEDULE.id)})}catch(s){console.error("Failed to load permissions:",s),c.setUserRole(r,"SUPERVISOR"),C({canViewDashboard:!0,canViewTeam:!0,canAssignWork:!0,canApproveAssignments:!0,canViewTeamPerformance:!0,canManageSchedule:!0,canManageTeamMembers:!0})}},N=async()=>{try{const s=await U.getDashboard(r);s.success?T(s.data):V(s.error||"Failed to load dashboard data")}catch{V("Error loading dashboard data")}finally{I(!1)}},H=async()=>{try{const t=P.getNotifications({limit:20}).filter(a=>["system","assignment","quality","alert","achievement"].includes(a.type)||a.userId===r).map(a=>({id:a.id,type:a.type,title:a.title,message:a.message,timestamp:a.timestamp,read:a.read,priority:a.priority,userId:a.userId,category:a.category}));return u(t),P.subscribe(`supervisor-${r}`,a=>{(["system","assignment","quality","alert","achievement"].includes(a.type)||a.userId===r)&&u(x=>[{id:a.id,type:a.type,title:a.title,message:a.message,timestamp:a.timestamp,read:a.read,priority:a.priority,userId:a.userId,category:a.category},...x])})}catch(s){console.error("Failed to load notifications:",s),u([])}},W=s=>{u(t=>t.map(l=>l.id===s?{...l,read:!0}:l));try{P.markAsRead(s)}catch(t){console.error("Failed to mark notification as read:",t)}},B=s=>{switch(s){case"achievement":return e.jsx(ee,{className:"w-4 h-4 text-green-600"});case"quality":return e.jsx(q,{className:"w-4 h-4 text-yellow-600"});case"alert":return e.jsx(Z,{className:"w-4 h-4 text-red-600"});case"assignment":return e.jsx(M,{className:"w-4 h-4 text-purple-600"});case"system":return e.jsx(z,{className:"w-4 h-4 text-blue-600"});case"break":return e.jsx($,{className:"w-4 h-4 text-gray-600"});default:return e.jsx(z,{className:"w-4 h-4 text-blue-600"})}},F=s=>{const l=new Date().getTime()-s.getTime(),a=Math.floor(l/(1e3*60));if(a<60)return`${a}m ago`;const x=Math.floor(a/60);return x<24?`${x}h ago`:`${Math.floor(x/24)}d ago`},_=async(s,t,l)=>{try{k(s);const a=await U.processAssignmentApproval(s,r,t,l);a.success?(await N(),alert(`Assignment ${t}d successfully!`)):alert(`Failed to ${t} assignment: ${a.error}`)}catch{alert(`Error processing ${t}`)}finally{k(null)}},G=async(s,t)=>{if(!j){S(s);return}try{if(D(s),console.log(`Removing operator ${s} from supervisor ${r}'s team`),await new Promise(a=>setTimeout(a,1e3)),Math.random()>.1){if(g?.teamOperators){const a=g.teamOperators.filter(x=>x.id!==s);T({...g,teamOperators:a})}alert(`${t} has been removed from the team successfully`),setTimeout(()=>N(),500)}else throw new Error("Simulated failure")}catch{alert(`Error removing ${t} from team. Please try again.`)}finally{S(null),D(null)}},Q=s=>{console.log("Edit operator:",s),alert("Edit operator functionality - to be implemented")};if(f&&!g)return e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(y,{size:"lg"})});if(!o.canViewDashboard)return e.jsx("div",{className:"text-center py-8",children:e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-red-800 mb-2",children:"Access Denied"}),e.jsx("p",{className:"text-red-600",children:"You don't have permission to access the Supervisor Dashboard."}),e.jsx("p",{className:"text-sm text-red-500 mt-2",children:"Please contact your administrator for access."})]})});if(O)return e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-red-600",children:O}),e.jsx(d,{onClick:N,className:"mt-4",children:"Retry"})]});if(!g)return null;const{supervisor:w,teamProductivity:m,pendingApprovals:E,teamOperators:R=[]}=g;return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"bg-green-50 border-l-4 border-green-500 p-6 rounded-lg shadow",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"flex items-center gap-2 mb-1",children:e.jsx(p,{variant:"default",className:"bg-green-100 text-green-800",children:"👥 SUPERVISOR DASHBOARD"})}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:w.name}),e.jsxs("p",{className:"text-gray-600",children:[w.supervisorLevel," Supervisor • Team Size: ",R.length]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(d,{onClick:N,disabled:f,size:"sm",variant:"outline",children:f?e.jsx(y,{size:"sm"}):"🔄 Refresh"}),e.jsx(p,{variant:"success",children:"Active"})]}),e.jsxs("p",{className:"text-sm text-gray-500 mt-1",children:["Lines: ",w.responsibleLines?.length||0]})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs(n,{className:"p-4",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-500",children:"Team Efficiency"}),e.jsxs("p",{className:"text-2xl font-bold text-green-600",children:[Math.round(m.teamEfficiency*100),"%"]})]}),e.jsxs(n,{className:"p-4",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-500",children:"Average Quality"}),e.jsxs("p",{className:"text-2xl font-bold text-blue-600",children:[Math.round(m.averageQuality*100),"%"]})]}),e.jsxs(n,{className:"p-4",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-500",children:"Team Health"}),e.jsx("p",{className:"text-2xl font-bold text-purple-600",children:m.teamHealthScore})]}),e.jsxs(n,{className:"p-4",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-500",children:"Pending Approvals"}),e.jsx("p",{className:"text-2xl font-bold text-orange-600",children:E.length})]})]}),e.jsxs(n,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(M,{className:"w-5 h-5 text-gray-600"}),e.jsx("h2",{className:"text-lg font-semibold",children:"Notifications"}),e.jsx(p,{variant:"destructive",className:"px-2 py-0.5 text-xs",children:v.filter(s=>!s.read).length})]}),e.jsx(d,{variant:"ghost",size:"sm",onClick:()=>{u(s=>s.map(t=>({...t,read:!0})))},className:"text-sm",children:"Mark all read"})]}),v.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(M,{className:"w-12 h-12 mx-auto mb-3 opacity-30"}),e.jsx("p",{children:"No notifications"})]}):e.jsx("div",{className:"space-y-3 max-h-64 overflow-y-auto",children:v.map(s=>e.jsx("div",{className:`p-4 rounded-lg border transition-colors cursor-pointer ${s.read?"bg-gray-50 border-gray-200 hover:bg-gray-100":"bg-blue-50 border-blue-200 hover:bg-blue-100"}`,onClick:()=>W(s.id),children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("div",{className:"flex-shrink-0 mt-1",children:B(s.type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:`text-sm font-medium ${s.read?"text-gray-700":"text-gray-900"}`,children:s.title}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(p,{variant:s.priority==="critical"||s.priority==="high"?"destructive":s.priority==="medium"?"default":"secondary",className:"text-xs",children:s.priority}),!s.read&&e.jsx("div",{className:"w-2 h-2 bg-blue-600 rounded-full"})]})]}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:s.message}),e.jsxs("div",{className:"flex items-center mt-2",children:[e.jsx($,{className:"w-3 h-3 text-gray-400 mr-1"}),e.jsx("span",{className:"text-xs text-gray-400",children:F(s.timestamp)})]})]})]})},s.id))})]}),o.canViewTeam&&e.jsxs(n,{className:"p-6",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Team Members"}),R.length===0?e.jsx("p",{className:"text-gray-500 text-center py-8",children:"No team members assigned"}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:R.map(s=>e.jsxs("div",{className:"border rounded-lg p-4 relative",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium",children:s.name}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(p,{variant:s.currentStatus==="working"?"success":"secondary",children:s.currentStatus}),o.canManageTeamMembers&&e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(d,{variant:"ghost",size:"sm",onClick:()=>Q(s.id),className:"h-7 w-7 p-0 text-blue-600 hover:text-blue-700",title:"Edit operator",children:e.jsx(K,{className:"w-3 h-3"})}),e.jsx(d,{variant:"ghost",size:"sm",onClick:()=>G(s.id,s.name),disabled:A===s.id,className:`h-7 w-7 p-0 ${j===s.id?"text-red-700 bg-red-100":"text-red-600 hover:text-red-700"}`,title:A===s.id?"Removing...":j===s.id?"Click again to confirm removal":"Remove from team",children:A===s.id?e.jsx(y,{size:"sm"}):j===s.id?e.jsx(J,{className:"w-3 h-3"}):e.jsx(X,{className:"w-3 h-3"})}),j===s.id&&e.jsx(d,{variant:"ghost",size:"sm",onClick:()=>S(null),className:"h-7 w-7 p-0 text-gray-600 hover:text-gray-700",title:"Cancel",children:"×"})]})]})]}),e.jsxs("p",{className:"text-sm text-gray-600 mb-2",children:[s.skillLevel," • ",s.primaryMachine]}),o.canViewTeamPerformance&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Efficiency:"}),e.jsxs("span",{className:"font-medium",children:[Math.round(s.averageEfficiency*100),"%"]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Quality:"}),e.jsxs("span",{className:"font-medium",children:[Math.round(s.qualityScore*100),"%"]})]})]})]},s.id))})]}),o.canApproveAssignments&&e.jsxs(n,{className:"p-6",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Pending Assignment Approvals"}),E.length===0?e.jsx("p",{className:"text-gray-500 text-center py-8",children:"No pending approvals"}):e.jsx("div",{className:"space-y-4",children:E.map(s=>e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium",children:"Work Assignment Request"}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Operator: ",s.operatorName||s.operatorId]})]}),e.jsx(p,{variant:"warning",children:"Pending"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"Work Item:"})," ",s.workItemId]}),e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"Requested:"})," ",new Date(s.requestedAt?.seconds*1e3).toLocaleString()]}),s.reason&&e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"Reason:"})," ",s.reason]})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(d,{size:"sm",onClick:()=>_(s.id,"approve"),disabled:b===s.id,className:"bg-green-600 hover:bg-green-700",children:b===s.id?e.jsx(y,{size:"sm"}):"Approve"}),e.jsx(d,{size:"sm",variant:"outline",onClick:()=>{const t=prompt("Rejection reason (optional):");_(s.id,"reject",t||void 0)},disabled:b===s.id,className:"text-red-600 border-red-600 hover:bg-red-50",children:"Reject"})]})]},s.id))})]}),o.canViewTeamPerformance&&m.recommendedActions.length>0&&e.jsxs(n,{className:"p-6",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Performance Recommendations"}),e.jsx("div",{className:"space-y-2",children:m.recommendedActions.map((s,t)=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full"}),e.jsx("p",{className:"text-sm",children:s})]},t))})]}),o.canViewTeamPerformance&&m.teamHealthScore<60&&e.jsxs(n,{className:"p-6 bg-red-50 border-red-200",children:[e.jsx("h2",{className:"text-lg font-semibold text-red-800 mb-2",children:"⚠️ Team Health Alert"}),e.jsxs("p",{className:"text-red-700 mb-4",children:["Your team health score is ",m.teamHealthScore,". Immediate attention required."]}),e.jsx("div",{className:"space-y-1",children:m.recommendedActions.slice(0,3).map((s,t)=>e.jsxs("p",{className:"text-sm text-red-600",children:["• ",s]},t))})]})]})});export{Ne as SupervisorDashboard};
