import{j as s}from"./query-vendor.DpsghfSz.js";import{r as T}from"./react-vendor.CfKEcsXX.js";import{o as L,w as Z,b as M,a as Y}from"./index.CvlZStFR.js";import{p as P,P as F}from"./permission-service.Cx3ms_AT.js";import{L as ee}from"./LoadingSpinner.DUO60hBS.js";import{h as u,g as p,x as J,r as C,l as V,R as E,y as se,o as X,B as G,a as q,C as j}from"./index.CUWf0ERd.js";import{j as z,d as S,q as v,e as R,g as w,f as U,l as I,h as k,r as H,s as b,o as te}from"./firebase-vendor.D8xw0AXf.js";import"./operator-types.IC8C56sJ.js";import"./notification-service.DEoZgDf9.js";import"./damage-report-service.CW7byCe-.js";import"./operator-wallet-service.BNyduHk2.js";import"./work-assignment-service.uP3JWO5o.js";import"./ui-vendor.D450QVBF.js";import"./utils-vendor.B0NEtgzl.js";class re{static async createOperator(t){try{const e=L.validateOperatorCreation(t);if(!e.isValid)return{success:!1,error:e.errors.join(", "),code:"VALIDATION_FAILED",metadata:{warnings:e.warnings}};const r=await Z.startWorkflow("operator_onboarding",{operatorData:t},"normal");return r.success?{success:!0,data:{operatorId:r.workflowId},workflowId:r.workflowId,metadata:{warnings:e.warnings}}:{success:!1,error:r.error,code:"WORKFLOW_FAILED"}}catch(e){return console.error("Error creating operator:",e),{success:!1,error:e instanceof Error?e.message:"Failed to create operator",code:"OPERATOR_CREATION_FAILED"}}}static async getOperatorWithAnalysis(t){try{const e=await z(S(u,p.OPERATORS,t));if(!e.exists())return{success:!1,error:"Operator not found",code:"NOT_FOUND"};const r={id:e.id,...e.data()},n=(await J(C(V,`${E.OPERATOR_STATUS}/${t}`))).val(),i=L.analyzePerformance(r),m=L.evaluatePromotion(r),l=L.recommendTraining(r),a=v(R(u,p.WORK_COMPLETIONS),w("operatorId","==",t),U("completedAt","desc"),I(10)),d=(await k(a)).docs.map(O=>({id:O.id,...O.data()})),A=v(R(u,p.OPERATOR_WALLETS),w("operatorId","==",t),I(1)),h=(await k(A)).docs[0]?.data();return{success:!0,data:{operator:{...r,realtimeStatus:n},performance:i,promotionEligibility:m,trainingRecommendations:l,recentWork:d,wallet:h,analysisTimestamp:new Date().toISOString()}}}catch(e){return console.error("Error getting operator analysis:",e),{success:!1,error:e instanceof Error?e.message:"Failed to get operator analysis",code:"OPERATOR_ANALYSIS_FAILED"}}}static async getWorkRecommendations(t){try{const e=await this.getOperatorWithAnalysis(t);if(!e.success)return e;const r=e.data?.operator,c=v(R(u,p.WORK_ITEMS),w("status","==","available"),U("createdAt","desc"),I(50)),i=(await k(c)).docs.map(l=>({id:l.id,...l.data()})),m=i.map(l=>{const a=M.recommendationEngine.generateRecommendations(l,r),g=M.workAssignmentLogic.calculateMatchScore(l,r);return{workItem:l,recommendation:a,matchScore:g,aiScore:a.match,reasons:a.reasons,canSelfAssign:g.totalScore>=70}});return m.sort((l,a)=>a.aiScore-l.aiScore),{success:!0,data:{operatorId:t,recommendations:m.slice(0,10),totalAvailable:i.length,generatedAt:new Date().toISOString(),operator:{name:r.name,skillLevel:r.skillLevel,machineTypes:r.machineTypes,efficiency:r.averageEfficiency,quality:r.qualityScore}}}}catch(e){return console.error("Error getting work recommendations:",e),{success:!1,error:e instanceof Error?e.message:"Failed to get recommendations",code:"RECOMMENDATIONS_FAILED"}}}static async processSelfAssignment(t,e,r){try{return await H(u,async c=>{const n=S(u,p.WORK_ITEMS,t),i=S(u,p.OPERATORS,e),[m,l]=await Promise.all([c.get(n),c.get(i)]);if(!m.exists()||!l.exists())throw new Error("Work item or operator not found");const a=m.data(),g=l.data(),d=L.validateWorkAssignment(g,{machineType:a?.machineType,estimatedDuration:a?.estimatedDuration||30,skillRequired:a?.requiredSkillLevel||"beginner",priority:a?.priority||"normal"});if(!d.canAssign)throw new Error(d.reason||"Cannot assign work");if(a?.status!=="available")throw new Error("Work item is no longer available");c.update(n,{status:"assigned",operatorId:e,assignedAt:b(),assignmentType:"self_assigned",assignmentReason:r,validation:d}),c.update(i,{currentStatus:"working","realtimeStatus.currentWorkItems":(g.realtimeStatus?.currentWorkItems||0)+1,"realtimeStatus.lastUpdated":b()});const A={workItemId:t,operatorId:e,assignedAt:b(),assignmentType:"self_assigned",status:"active",validation:d,reason:r},x=S(R(u,p.WORK_ASSIGNMENTS));c.set(x,A);const h={[`${E.OPERATOR_STATUS}/${e}/status`]:"working",[`${E.OPERATOR_STATUS}/${e}/currentWorkItems`]:(g.realtimeStatus?.currentWorkItems||0)+1,[`${E.OPERATOR_STATUS}/${e}/lastUpdated`]:Date.now(),[`${E.AVAILABLE_WORK}/${t}`]:null};return setTimeout(()=>{se(C(V),h)},100),{success:!0,data:{assignmentId:x.id,workItemId:t,operatorId:e,validation:d,workItem:{bundleNumber:a?.bundleNumber,operation:a?.operation,estimatedDuration:a?.estimatedDuration}}}})}catch(c){return console.error("Error processing self-assignment:",c),{success:!1,error:c instanceof Error?c.message:"Assignment failed",code:"SELF_ASSIGNMENT_FAILED"}}}static async processDamageReport(t){try{return await H(u,async e=>{const r=S(u,p.WORK_ITEMS,t.workItemId),c=S(u,p.OPERATORS,t.operatorId),n=S(u,p.SUPERVISORS,t.supervisorId),[i,m,l]=await Promise.all([e.get(r),e.get(c),e.get(n)]);if(!i.exists()||!m.exists()||!l.exists())throw new Error("Required entities not found");const a=i.data(),g=m.data(),d=l.data(),A=M.qualityLogic.calculateDefectImpact(t.damageType,t.affectedPieces,a?.totalPieces||100),x=Y.evaluateQualityIssue(d,{bundleId:a?.bundleId,operatorId:t.operatorId,defectType:t.damageType,severity:t.severity,affectedPieces:t.affectedPieces,totalPieces:a?.totalPieces||100,customerOrder:a?.isCustomerOrder||!1}),h=M.paymentLogic.calculateDamageAwarePayment({rate:a?.ratePerPiece||10,totalPieces:a?.totalPieces||100},{piecesCompleted:a?.completedPieces||0,efficiency:g.averageEfficiency,qualityScore:g.qualityScore},[t]),O={...t,damageImpact:A,qualityDecision:x,paymentCalculation:h,status:"reported",reportedAt:b(),resolved:!1},D=S(R(u,p.DAMAGE_REPORTS));e.set(D,O);const W=M.qualityLogic.calculateQualityMetrics(a?.completedPieces||0,[t]);if(e.update(r,{qualityScore:W.qualityScore,defectRate:W.defectRate,qualityMetrics:W,lastDamageReport:D.id,updatedAt:b()}),t.operatorFault&&h.penalties>0){const N=v(R(u,p.OPERATOR_WALLETS),w("operatorId","==",t.operatorId),I(1));e.update(c,{"paymentStatus.held":!0,"paymentStatus.heldAmount":h.penalties,"paymentStatus.reason":"damage_reported",updatedAt:b()})}return{success:!0,data:{damageReportId:D.id,damageImpact:A,qualityDecision:x,paymentCalculation:h,actionTaken:x.action,paymentHeld:t.operatorFault&&h.penalties>0}}})}catch(e){return console.error("Error processing damage report:",e),{success:!1,error:e instanceof Error?e.message:"Failed to process damage report",code:"DAMAGE_PROCESSING_FAILED"}}}static async getSupervisorDashboard(t){try{const e=await z(S(u,p.SUPERVISORS,t));if(!e.exists())return{success:!1,error:"Supervisor not found",code:"NOT_FOUND"};const r={id:e.id,...e.data()};if(!r.teamMembers||r.teamMembers.length===0)return{success:!0,data:{supervisor:r,teamProductivity:{teamEfficiency:0,averageQuality:0,completionRate:0,onTimeDelivery:0,recommendedActions:["No team members assigned"],teamHealthScore:0},pendingApprovals:[],teamSize:0,dashboardGeneratedAt:new Date().toISOString()}};const c=r.teamMembers.map(d=>z(S(u,p.OPERATORS,d))),i=(await Promise.all(c)).filter(d=>d.exists()).map(d=>({id:d.id,...d.data()})),m=v(R(u,p.WORK_ASSIGNMENTS),w("supervisorId","==",t),w("status","==","pending"),U("requestedAt","desc"),I(20)),a=(await k(m)).docs.map(d=>({id:d.id,...d.data()})),g=Y.analyzeTeamProductivity(r,i,{completedWork:[],qualityIncidents:[],onTimeDeliveries:Math.floor(Math.random()*50)+40,totalDeliveries:50});return{success:!0,data:{supervisor:r,teamProductivity:g,pendingApprovals:a,teamOperators:i,teamSize:i.length,dashboardGeneratedAt:new Date().toISOString()}}}catch(e){return console.error("Error getting supervisor dashboard:",e),{success:!1,error:e instanceof Error?e.message:"Failed to get dashboard",code:"DASHBOARD_FETCH_FAILED"}}}static async processAssignmentApproval(t,e,r,c){try{return await H(u,async n=>{const i=S(u,p.WORK_ASSIGNMENTS,t),m=await n.get(i);if(!m.exists())throw new Error("Assignment request not found");const l=m.data();if(n.update(i,{status:r==="approve"?"approved":"rejected",processedBy:e,processedAt:b(),processingNotes:c,finalDecision:r}),r==="approve"){const a=S(u,p.WORK_ITEMS,l.workItemId),g=S(u,p.OPERATORS,l.operatorId);n.update(a,{status:"assigned",supervisorApproved:!0,approvedBy:e,approvedAt:b()}),n.update(g,{currentStatus:"working",updatedAt:b()})}return{success:!0,data:{requestId:t,decision:r,processedBy:e,notes:c,workItemId:l.workItemId,operatorId:l.operatorId}}})}catch(n){return console.error("Error processing assignment approval:",n),{success:!1,error:n instanceof Error?n.message:"Failed to process approval",code:"APPROVAL_PROCESSING_FAILED"}}}static subscribeToOperatorStatus(t,e){const r=C(V,`${E.OPERATOR_STATUS}/${t}`);return X(r,n=>{const i=n.val();e(i)})}static subscribeToAvailableWork(t){const e=C(V,E.AVAILABLE_WORK);return X(e,c=>{const n=c.val(),i=n?Object.keys(n).map(m=>({id:m,...n[m]})):[];t(i)})}static subscribeToNotifications(t,e){const r=v(R(u,p.NOTIFICATIONS),w("recipientId","==",t),w("read","==",!1),U("createdAt","desc"),I(50));return te(r,n=>{const i=n.docs.map(m=>({id:m.id,...m.data()}));e(i)})}static async getSystemHealth(){try{const e=(await k(R(u,p.OPERATORS))).size,c=(await J(C(V,E.OPERATOR_STATUS))).val()||{},n=Object.values(c).filter(x=>x.status==="working"||x.status==="idle").length,i=v(R(u,p.WORK_ITEMS),w("status","==","available")),l=(await k(i)).size,a=new Date;a.setHours(0,0,0,0);const g=v(R(u,p.WORK_COMPLETIONS),w("completedAt",">=",a)),A=(await k(g)).size;return{success:!0,data:{operators:{total:e,active:n,utilizationRate:e>0?n/e:0},work:{pendingItems:l,completedToday:A},system:{status:"operational",lastCheck:new Date().toISOString()}}}}catch(t){return console.error("Error getting system health:",t),{success:!1,error:t instanceof Error?t.message:"Failed to get system health",code:"SYSTEM_HEALTH_FAILED"}}}}const B=re,xe=({operatorId:f})=>{const[t,e]=T.useState(null),[r,c]=T.useState([]),[n,i]=T.useState(!0),[m,l]=T.useState(null),[a,g]=T.useState(null),[d,A]=T.useState({canViewDashboard:!1,canViewWorkAssignments:!1,canSelfAssignWork:!1,canViewPerformance:!1,canUpdateStatus:!1});T.useEffect(()=>{x(),h(),O(),D()},[f]);const x=async()=>{try{await P.loadUserPermissions(f),A({canViewDashboard:P.hasPermission(f,F.OPERATOR_VIEW_DASHBOARD.id),canViewWorkAssignments:P.hasPermission(f,F.OPERATOR_VIEW_WORK_ASSIGNMENTS.id),canSelfAssignWork:P.hasPermission(f,F.OPERATOR_SELF_ASSIGN_WORK.id),canViewPerformance:P.hasPermission(f,F.OPERATOR_VIEW_PERFORMANCE.id),canUpdateStatus:P.hasPermission(f,F.OPERATOR_UPDATE_STATUS.id)})}catch(o){console.error("Failed to load permissions:",o),P.setUserRole(f,"OPERATOR"),A({canViewDashboard:!0,canViewWorkAssignments:!0,canSelfAssignWork:!0,canViewPerformance:!0,canUpdateStatus:!0})}},h=async()=>{try{const o=await B.getOperatorWithAnalysis(f);o.success?e(o.data):l(o.error||"Failed to load operator data")}catch{l("Error loading operator data")}finally{i(!1)}},O=async()=>{try{const o=await B.getWorkRecommendations(f);o.success&&c(o.data?.recommendations||[])}catch(o){console.error("Error loading recommendations:",o)}},D=()=>{const o=B.subscribeToOperatorStatus(f,y=>{g(y)});return()=>o()},W=async(o,y)=>{try{i(!0);const _=await B.processSelfAssignment(o,f,y);_.success?(await h(),await O(),alert("Work assigned successfully!")):alert(`Assignment failed: ${_.error}`)}catch{alert("Error processing assignment")}finally{i(!1)}};if(n&&!t)return s.jsx("div",{className:"flex items-center justify-center h-64",children:s.jsx(ee,{size:"lg"})});if(!d.canViewDashboard)return s.jsx("div",{className:"text-center py-8",children:s.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-6",children:[s.jsx("h2",{className:"text-xl font-semibold text-red-800 mb-2",children:"Access Denied"}),s.jsx("p",{className:"text-red-600",children:"You don't have permission to access the Operator Dashboard."}),s.jsx("p",{className:"text-sm text-red-500 mt-2",children:"Please contact your administrator for access."})]})});if(m)return s.jsxs("div",{className:"text-center py-8",children:[s.jsx("p",{className:"text-red-600",children:m}),s.jsx(G,{onClick:h,className:"mt-4",children:"Retry"})]});if(!t)return null;const{operator:N,performance:K,promotionEligibility:Q,wallet:$}=t;return s.jsxs("div",{className:"space-y-6",children:[s.jsx("div",{className:"bg-blue-50 border-l-4 border-blue-500 p-6 rounded-lg shadow",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("div",{className:"flex items-center gap-2 mb-1",children:s.jsx(q,{variant:"default",className:"bg-blue-100 text-blue-800",children:"👤 OPERATOR DASHBOARD"})}),s.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:N.name}),s.jsxs("p",{className:"text-gray-600",children:[N.employeeId," • ",N.skillLevel]})]}),s.jsxs("div",{className:"text-right",children:[s.jsx(q,{variant:a?.status==="working"?"success":"secondary",children:a?.status||N.currentStatus}),s.jsxs("p",{className:"text-sm text-gray-500 mt-1",children:["Current Work Items: ",a?.currentWorkItems||0]})]})]})}),d.canViewPerformance&&s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[s.jsxs(j,{className:"p-4",children:[s.jsx("h3",{className:"text-sm font-medium text-gray-500",children:"Efficiency"}),s.jsxs("p",{className:"text-2xl font-bold text-green-600",children:[Math.round(N.averageEfficiency*100),"%"]})]}),s.jsxs(j,{className:"p-4",children:[s.jsx("h3",{className:"text-sm font-medium text-gray-500",children:"Quality Score"}),s.jsxs("p",{className:"text-2xl font-bold text-blue-600",children:[Math.round(N.qualityScore*100),"%"]})]}),s.jsxs(j,{className:"p-4",children:[s.jsx("h3",{className:"text-sm font-medium text-gray-500",children:"Productivity"}),s.jsx("p",{className:"text-2xl font-bold text-purple-600",children:K.productivityScore})]}),s.jsxs(j,{className:"p-4",children:[s.jsx("h3",{className:"text-sm font-medium text-gray-500",children:"Available Balance"}),s.jsxs("p",{className:"text-2xl font-bold text-indigo-600",children:["₹",$?.availableAmount||0]}),$?.heldAmount>0&&s.jsxs("p",{className:"text-sm text-red-500",children:["₹",$.heldAmount," held"]})]})]}),d.canViewWorkAssignments&&s.jsxs(j,{className:"p-6",children:[s.jsxs("div",{className:"flex items-center justify-between mb-4",children:[s.jsx("h2",{className:"text-lg font-semibold",children:"AI Work Recommendations"}),s.jsx(G,{onClick:O,size:"sm",variant:"outline",children:"Refresh"})]}),r.length===0?s.jsx("p",{className:"text-gray-500 text-center py-8",children:"No work recommendations available"}):s.jsx("div",{className:"space-y-4",children:r.slice(0,5).map(o=>s.jsxs("div",{className:"border rounded-lg p-4",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsxs("div",{children:[s.jsx("h3",{className:"font-medium",children:o.workItem.bundleNumber}),s.jsx("p",{className:"text-sm text-gray-600",children:o.workItem.operation})]}),s.jsx("div",{className:"text-right",children:s.jsxs(q,{variant:o.aiScore>=80?"success":o.aiScore>=60?"warning":"secondary",children:[o.aiScore,"% Match"]})})]}),s.jsx("div",{className:"flex flex-wrap gap-1 mb-3",children:o.reasons.map((y,_)=>s.jsx(q,{variant:"secondary",className:"text-xs",children:y},_))}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"text-sm text-gray-500",children:["Est. Duration: ",o.workItem.estimatedDuration,"min • Machine: ",o.workItem.machineType]}),o.canSelfAssign&&d.canSelfAssignWork&&s.jsx(G,{size:"sm",onClick:()=>{const y=prompt("Why do you want this work?");y&&W(o.workItem.id,y)},className:"bg-brand-500 hover:bg-brand-600",children:"Self Assign"})]})]},o.workItem.id))})]}),d.canViewPerformance&&K.recommendedActions.length>0&&s.jsxs(j,{className:"p-6",children:[s.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Performance Recommendations"}),s.jsx("div",{className:"space-y-2",children:K.recommendedActions.map((o,y)=>s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full"}),s.jsx("p",{className:"text-sm",children:o})]},y))})]}),d.canViewPerformance&&Q.eligible&&s.jsxs(j,{className:"p-6 bg-green-50 border-green-200",children:[s.jsx("h2",{className:"text-lg font-semibold text-green-800 mb-2",children:"🎉 Promotion Eligible!"}),s.jsxs("p",{className:"text-green-700 mb-4",children:["You're eligible for promotion to ",Q.nextLevel]}),s.jsx("div",{className:"space-y-1",children:Q.requirements.map((o,y)=>s.jsxs("p",{className:"text-sm text-green-600",children:["• ",o]},y))})]})]})};export{xe as OperatorDashboard};
