import{j as e}from"./query-vendor.NFs8Lf8Y.js";import{r as f}from"./react-vendor.BcnQP8kQ.js";import{B as g,c as m,t as h,I as K,v as I,w as b,D as M,b as T}from"./index.B__xpDQO.js";import{t as y}from"./index.wyP5CHuk.js";import{a as B,ae as C,ac as w,af as L,U as H,h as $,q as _,s as q,l as J,T as P,b as U,ad as Z}from"./ui-vendor.BnTQXQPs.js";import"./utils-vendor.B0NEtgzl.js";import"./firebase-vendor.m6WcKfT_.js";class G{storageKey="tsaerp_trusted_devices";deviceKey="tsaerp_device_id";minLoginCount=5;maxTrustedDevices=3;trustExpireDays=30;generateDeviceFingerprint(){return{userAgent:navigator.userAgent,screenResolution:`${screen.width}x${screen.height}`,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,language:navigator.language,platform:navigator.platform,cookieEnabled:navigator.cookieEnabled,localStorage:typeof Storage<"u"}}generateDeviceId(r){const t=Object.values(r).join("|");let n=0;for(let a=0;a<t.length;a++){const i=t.charCodeAt(a);n=(n<<5)-n+i,n=n&n}return Math.abs(n).toString(16)}getCurrentDeviceId(){let r=localStorage.getItem(this.deviceKey);if(!r){const t=this.generateDeviceFingerprint();r=this.generateDeviceId(t),localStorage.setItem(this.deviceKey,r)}return r}getTrustedDevices(){try{const r=localStorage.getItem(this.storageKey);return r?JSON.parse(r):[]}catch(r){return console.error("Error loading trusted devices:",r),[]}}saveTrustedDevices(r){try{localStorage.setItem(this.storageKey,JSON.stringify(r))}catch(t){console.error("Error saving trusted devices:",t)}}isDeviceTrusted(r){const t=this.getCurrentDeviceId(),a=this.getTrustedDevices().find(l=>l.deviceId===t&&l.operatorId===r&&l.isTrusted&&l.isActive);return a?(Date.now()-new Date(a.lastLoginDate).getTime())/(1e3*60*60*24)>this.trustExpireDays?(this.revokeTrust(r,t),!1):!0:!1}getTrustedDevice(r){const t=this.getCurrentDeviceId();return this.getTrustedDevices().find(a=>a.deviceId===t&&a.operatorId===r)||null}recordLoginAttempt(r,t,n){const a=this.getCurrentDeviceId(),i=this.generateDeviceFingerprint(),l=this.getTrustedDevices();let o=l.find(D=>D.deviceId===a&&D.operatorId===r);const d={timestamp:new Date,success:n,ipAddress:this.getApproximateIP()};o?(o.loginCount++,n&&(o.successfulLogins++,o.lastLoginDate=new Date),o.loginHistory.push(d),o.loginHistory.length>50&&(o.loginHistory=o.loginHistory.slice(-50)),!o.isTrusted&&o.successfulLogins>=this.minLoginCount&&(o.isTrusted=!0,console.log(`ðŸ”’ Device ${a} is now trusted for ${t}`),typeof window<"u"&&"Notification"in window&&Notification.permission==="granted"&&new Notification("Device Trusted! ðŸ”’",{body:"This device is now trusted. Next time you can login automatically.",icon:"/icons/trust.png"}))):(o={deviceId:a,operatorId:r,operatorName:t,fingerprint:i,loginCount:1,successfulLogins:n?1:0,lastLoginDate:new Date,firstLoginDate:new Date,loginHistory:[d],isTrusted:!1,isActive:!0},l.push(o)),this.cleanupDevicesForOperator(r,l),this.saveTrustedDevices(l)}cleanupDevicesForOperator(r,t){const n=t.filter(i=>i.operatorId===r);n.length>this.maxTrustedDevices&&(n.sort((i,l)=>new Date(l.lastLoginDate).getTime()-new Date(i.lastLoginDate).getTime()),n.slice(this.maxTrustedDevices).forEach(i=>{i.isActive=!1,i.isTrusted=!1}));const a=new Date;a.setDate(a.getDate()-90),n.forEach(i=>{new Date(i.lastLoginDate)<a&&(i.isActive=!1,i.isTrusted=!1)})}revokeTrust(r,t){const n=t||this.getCurrentDeviceId(),a=this.getTrustedDevices(),i=a.find(l=>l.deviceId===n&&l.operatorId===r);i&&(i.isTrusted=!1,i.isActive=!1,this.saveTrustedDevices(a))}getDeviceStats(r){const t=this.getTrustedDevice(r);if(!t)return null;const n=Math.floor((Date.now()-new Date(t.firstLoginDate).getTime())/(1e3*60*60*24));return{loginCount:t.loginCount,successfulLogins:t.successfulLogins,isTrusted:t.isTrusted,daysSinceFirst:n,recentLogins:t.loginHistory.slice(-10)}}getTrustedDevicesForOperator(r){return this.getTrustedDevices().filter(t=>t.operatorId===r&&t.isTrusted&&t.isActive)}getApproximateIP(){return"local"}clearAllTrustedDevices(){localStorage.removeItem(this.storageKey),localStorage.removeItem(this.deviceKey)}getSecuritySummary(){const r=this.getTrustedDevices(),t=r.filter(i=>i.isTrusted&&i.isActive),n=[...new Set(r.map(i=>i.operatorName))];let a=null;return t.length>0&&(a=t.reduce((i,l)=>{const o=new Date(l.firstLoginDate);return!i||o<i?o:i},null)),{totalDevices:r.length,trustedDevices:t.length,operators:n,oldestTrust:a}}}const N=new G,re=()=>{const[x,r]=f.useState([]),[t,n]=f.useState(""),[a,i]=f.useState(new Set),[l,o]=f.useState("all"),[d,D]=f.useState(null);f.useEffect(()=>{p(),j()},[]);const p=()=>{const s=JSON.parse(localStorage.getItem("tsaerp_trusted_devices")||"[]");r(s)},j=()=>{const s=N.getSecuritySummary();D(s)},S=()=>{let s=x;return l==="trusted"?s=s.filter(c=>c.isTrusted&&c.isActive):l==="inactive"&&(s=s.filter(c=>!c.isActive||!c.isTrusted)),t&&(s=s.filter(c=>c.operatorName.toLowerCase().includes(t.toLowerCase())||c.operatorId.toLowerCase().includes(t.toLowerCase())||c.deviceId.toLowerCase().includes(t.toLowerCase()))),s.sort((c,u)=>new Date(u.lastLoginDate).getTime()-new Date(c.lastLoginDate).getTime())},A=async(s,c,u)=>{try{N.revokeTrust(c,s),p(),j(),y.success(`ðŸ”’ Revoked trust for ${u}'s device`)}catch{y.error("Failed to revoke device trust")}},k=async()=>{if(a.size===0)return;const s=x.filter(c=>a.has(c.deviceId));for(const c of s)N.revokeTrust(c.operatorId,c.deviceId);p(),j(),i(new Set),y.success(`ðŸ”’ Revoked trust for ${s.length} devices`)},E=(s,c)=>{const u=new Set(a);c?u.add(s):u.delete(s),i(u)},F=s=>{if(s){const c=S();i(new Set(c.map(u=>u.deviceId)))}else i(new Set)},O=s=>{const c=s.userAgent?.toLowerCase()||"";return c.includes("mobile")||c.includes("android")||c.includes("iphone")?e.jsx(Z,{className:"w-4 h-4"}):e.jsx(L,{className:"w-4 h-4"})},R=s=>s.isTrusted&&s.isActive?e.jsx(T,{className:"bg-green-100 text-green-800",children:"Trusted"}):s.isActive?e.jsx(T,{className:"bg-yellow-100 text-yellow-800",children:"Building Trust"}):e.jsx(T,{className:"bg-gray-100 text-gray-800",children:"Inactive"}),z=s=>{const c=Math.floor((Date.now()-new Date(s).getTime())/864e5);return c===0?"Today":`${c} days ago`},v=S();return e.jsxs("div",{className:"p-6 space-y-6 max-w-7xl mx-auto",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Trusted Device Management"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Manage operator devices and security settings"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(g,{variant:"outline",leftIcon:e.jsx(B,{className:"w-4 h-4"}),onClick:()=>p(),children:"Refresh"}),a.size>0&&e.jsxs(g,{variant:"danger",leftIcon:e.jsx(C,{className:"w-4 h-4"}),onClick:k,children:["Revoke Selected (",a.size,")"]})]})]}),d&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx(m,{children:e.jsx(h,{className:"flex items-center p-6",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(w,{className:"w-8 h-8 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:d.trustedDevices}),e.jsx("p",{className:"text-sm text-gray-500",children:"Trusted Devices"})]})]})})}),e.jsx(m,{children:e.jsx(h,{className:"flex items-center p-6",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(L,{className:"w-8 h-8 text-blue-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:d.totalDevices}),e.jsx("p",{className:"text-sm text-gray-500",children:"Total Devices"})]})]})})}),e.jsx(m,{children:e.jsx(h,{className:"flex items-center p-6",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(H,{className:"w-8 h-8 text-purple-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:d.operators.length}),e.jsx("p",{className:"text-sm text-gray-500",children:"Active Operators"})]})]})})}),e.jsx(m,{children:e.jsx(h,{className:"flex items-center p-6",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx($,{className:"w-8 h-8 text-orange-600"}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-bold text-gray-900",children:[d.oldestTrust?Math.floor((Date.now()-new Date(d.oldestTrust).getTime())/(1e3*60*60*24)):0," days"]}),e.jsx("p",{className:"text-sm text-gray-500",children:"Oldest Trust"})]})]})})})]}),e.jsx(m,{children:e.jsx(h,{className:"space-y-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsx(K,{leftIcon:e.jsx(_,{className:"w-4 h-4"}),placeholder:"Search by operator name, ID, or device...",value:t,onChange:s=>n(s.target.value),clearable:!0,onClear:()=>n("")})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(g,{variant:l==="all"?"primary":"outline",size:"sm",onClick:()=>o("all"),children:["All (",x.length,")"]}),e.jsxs(g,{variant:l==="trusted"?"primary":"outline",size:"sm",onClick:()=>o("trusted"),children:["Trusted (",x.filter(s=>s.isTrusted&&s.isActive).length,")"]}),e.jsxs(g,{variant:l==="inactive"?"primary":"outline",size:"sm",onClick:()=>o("inactive"),children:["Inactive (",x.filter(s=>!s.isActive||!s.isTrusted).length,")"]})]})]})})}),e.jsxs(m,{children:[e.jsx(I,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(b,{className:"flex items-center gap-2",children:[e.jsx(w,{className:"w-5 h-5"}),"Device List (",v.length,")"]}),v.length>0&&e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:a.size===v.length&&v.length>0,onChange:s=>F(s.target.checked),className:"rounded border-gray-300"}),e.jsx("span",{className:"text-sm text-gray-600",children:"Select All"})]})]})}),e.jsx(h,{children:v.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(w,{className:"w-12 h-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-lg font-medium",children:"No devices found"}),e.jsx("p",{className:"text-sm",children:"No trusted devices match your current filters."})]}):e.jsx("div",{className:"space-y-3",children:v.map(s=>e.jsxs("div",{className:M("flex items-center gap-4 p-4 border rounded-lg transition-all duration-200",a.has(s.deviceId)?"border-blue-300 bg-blue-50":"border-gray-200 hover:border-gray-300"),children:[e.jsx("input",{type:"checkbox",checked:a.has(s.deviceId),onChange:c=>E(s.deviceId,c.target.checked),className:"rounded border-gray-300"}),e.jsx("div",{className:"flex-shrink-0",children:O(s.fingerprint)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h3",{className:"font-medium text-gray-900 truncate",children:s.operatorName}),R(s),s.isTrusted&&s.isActive&&e.jsx(q,{className:"w-4 h-4 text-green-600"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2 text-sm text-gray-500",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"ID:"})," ",s.operatorId]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Logins:"})," ",s.successfulLogins,"/",s.loginCount]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(J,{className:"w-3 h-3"}),z(s.lastLoginDate)]})]}),e.jsxs("div",{className:"text-xs text-gray-400 mt-1 font-mono truncate",children:["Device: ",s.deviceId," â€¢ ",s.fingerprint.platform]})]}),e.jsx("div",{className:"flex items-center gap-2",children:s.isTrusted&&s.isActive&&e.jsx(g,{variant:"outline",size:"sm",onClick:()=>A(s.deviceId,s.operatorId,s.operatorName),leftIcon:e.jsx(C,{className:"w-3 h-3"}),className:"text-red-600 hover:text-red-700 hover:bg-red-50",children:"Revoke"})})]},s.deviceId))})})]}),e.jsxs(m,{children:[e.jsx(I,{children:e.jsxs(b,{className:"flex items-center gap-2 text-red-600",children:[e.jsx(P,{className:"w-5 h-5"}),"Security Actions"]})}),e.jsxs(h,{children:[e.jsx("div",{className:"flex gap-4",children:e.jsx(g,{variant:"outline",leftIcon:e.jsx(U,{className:"w-4 h-4"}),onClick:()=>{confirm("Are you sure you want to clear ALL trusted devices? This will require all operators to build trust again.")&&(N.clearAllTrustedDevices(),p(),j(),y.success("ðŸ”’ All trusted devices cleared"))},className:"text-red-600 hover:text-red-700 hover:bg-red-50",children:"Clear All Trusted Devices"})}),e.jsx("div",{className:"mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:e.jsxs("p",{className:"text-sm text-yellow-800",children:[e.jsx("strong",{children:"Security Note:"})," Revoking device trust will require the operator to login normally 5 more times before automatic login is re-enabled."]})})]})]})]})};export{re as default};
