import{s as g,c as U,e as P,j as $,d as w,w as te,u as ue,i as de,r as se,q as ie,g as Q,l as pe,h as me,p as B,t as he}from"./firebase-vendor.D8xw0AXf.js";import{g as f,h as m,s as re,r as L,l as A,R as W,u as H,y as fe,o as j,K as X,L as ge,M as Z,N as ye}from"./index.CLAiwwTT.js";import{M as z,a as k}from"./operator-types.IC8C56sJ.js";import{E as R,N as ve}from"./notification-service.CTW6eT3Y.js";import"./react-vendor.CfKEcsXX.js";import"./damage-report-service.Nrvveh5s.js";import"./permission-service.Bw3z8bJ_.js";import"./work-assignment-service._pWjxpTL.js";import"./operator-wallet-service.C-WlAMLy.js";class x{static validateOperatorCreation(e){const t=[],s=[];e.username.length<3&&t.push("Username must be at least 3 characters long"),/^TSA-\d{4}$/.test(e.employeeId)||t.push("Employee ID must follow format: TSA-XXXX (e.g., TSA-0001)"),e.machineTypes.includes(e.primaryMachine)||t.push("Primary machine must be included in machine types list");const r=z.find(c=>c.machineType===e.primaryMachine);if(r){const c=k.findIndex(d=>d.value===e.skillLevel),u=k.findIndex(d=>d.value===r.requiredSkillLevel);c<u&&t.push(`Operator skill level (${e.skillLevel}) is insufficient for primary machine ${r.displayName}`)}(Date.now()-new Date(e.hiredDate).getTime())/(1e3*60*60*24*30)<3&&e.skillLevel==="expert"&&s.push("Expert skill level assigned to recently hired operator (< 3 months)");const a=k.find(c=>c.value===e.skillLevel),o=a?.value==="beginner"?2:a?.value==="intermediate"?4:a?.value==="advanced"?6:8;return e.maxConcurrentWork>o&&s.push(`Max concurrent work (${e.maxConcurrentWork}) exceeds recommended for skill level (${o})`),e.email&&!e.email.endsWith("@tsa.com")&&!e.email.endsWith("@contractor.tsa.com")&&s.push("Email domain should be @tsa.com for employees or @contractor.tsa.com for contractors"),{isValid:t.length===0,errors:t,warnings:s}}static validateWorkAssignment(e,t){if(!(e.machineTypes.includes(t.machineType)||e.primaryMachine===t.machineType))return{canAssign:!1,reason:`Operator cannot work on ${t.machineType}`,machineIncompatible:!0};const i=k.findIndex(o=>o.value===e.skillLevel),r=k.findIndex(o=>o.value===t.skillRequired);return i<r?{canAssign:!1,reason:"Operator skill level insufficient for required work",skillMismatch:!0}:("realtimeStatus"in e&&e.realtimeStatus?.currentWorkItems||0)>=e.maxConcurrentWork?{canAssign:!1,reason:`Operator at maximum concurrent work capacity (${e.maxConcurrentWork})`,maxConcurrentExceeded:!0}:("realtimeStatus"in e?e.realtimeStatus?.status==="idle"||e.realtimeStatus?.status==="working":e.currentStatus==="idle"||e.currentStatus==="working")?{canAssign:!0}:{canAssign:!1,reason:`Operator not available (status: ${"realtimeStatus"in e?e.realtimeStatus?.status:e.currentStatus})`}}static analyzePerformance(e){const t=[];let s=0;const i=e.averageEfficiency;let r="stable";i<.7?(r="declining",t.push("Consider additional training or mentoring"),t.push("Review current work assignments for complexity")):i>.9&&(r="improving",t.push("Consider for advanced projects"),t.push("Potential candidate for team lead role"));const n=e.qualityScore;let a="stable";return n<.8?(a="declining",t.push("Quality control training needed"),t.push("Implement peer review process")):n>.95&&(a="improving",t.push("Consider for quality assurance role")),s=Math.round((i*.6+n*.4)*100),e.totalWorkingDays/22>12&&e.skillLevel==="intermediate"&&t.push("Consider promotion to advanced skill level"),e.completedBundles>100&&i>.85&&t.push("High performer - consider for complex assignments"),{efficiencyTrend:r,qualityTrend:a,productivityScore:s,recommendedActions:t}}static validateShiftAssignment(e,t,s){const i=[],r=[];e.shift!==t&&r.push(`Operator regular shift is ${e.shift}, requesting ${t}`),t==="night"&&e.totalWorkingDays/22<6&&i.push("Operators with less than 6 months experience cannot work night shifts");const n=s.getDay();return(n===0||n===6)&&e.skillLevel==="beginner"&&r.push("Beginner operators should avoid weekend shifts without supervision"),{isValid:i.length===0,errors:i,warnings:r}}static validateMachineAssignment(e,t,s){const i=[],r=[];e.machineTypes.includes(s)||i.push(`Operator not certified for machine type: ${s}`),e.primaryMachine===s?r.push("Assigning to primary machine - optimal performance expected"):r.push("Assigning to secondary machine - monitor performance closely");const n=z.find(a=>a.machineType===s);if(n){const a=k.findIndex(c=>c.value===e.skillLevel),o=k.findIndex(c=>c.value===n.requiredSkillLevel);a<o&&i.push(`Insufficient skill level for machine type: ${s}`)}return{isValid:i.length===0,errors:i,warnings:r}}static validateLeaveRequest(e,t,s,i){const r=[],n=[],a=Math.ceil((i.getTime()-s.getTime())/864e5),o={sick:15,annual:21,emergency:7,maternity:98};a>o[t]&&r.push(`${t} leave cannot exceed ${o[t]} days`);const c=Math.ceil((s.getTime()-Date.now())/(1e3*60*60*24));return t==="annual"&&c<7&&n.push("Annual leave should be requested at least 7 days in advance"),"realtimeStatus"in e&&e.realtimeStatus?.currentWorkItems>0&&n.push("Operator has pending work assignments - consider reassignment"),{isValid:r.length===0,errors:r,warnings:n}}static recommendTraining(e){const t=[];e.averageEfficiency<.7&&(t.push("Efficiency Improvement Workshop"),t.push("Time Management Training")),e.qualityScore<.8&&(t.push("Quality Control Certification"),t.push("Attention to Detail Training"));const s=e.totalWorkingDays/22;s>6&&e.skillLevel==="beginner"&&t.push("Intermediate Skills Certification"),s>18&&e.skillLevel==="intermediate"&&(t.push("Advanced Operations Training"),t.push("Leadership Skills Workshop"));const i=z.filter(r=>!e.machineTypes.includes(r.machineType));return i.length>0&&t.push(`Cross-training on ${i[0].displayName}`),t.push("Annual Safety Refresher Course"),t}static evaluatePromotion(e){const t=[],s=[],i=k.findIndex(d=>d.value===e.skillLevel),r=k[i+1];if(!r)return{eligible:!1,nextLevel:"Maximum level reached",requirements:[],blockers:["Already at highest skill level"]};const n=e.totalWorkingDays/22,o={intermediate:6,advanced:18,expert:36}[r.value];n<o&&s.push(`Need ${o-n} more months of experience`),e.averageEfficiency<.8&&s.push("Efficiency must be at least 80%"),e.qualityScore<.85&&s.push("Quality score must be at least 85%");const u={intermediate:50,advanced:200,expert:500}[r.value];return e.completedBundles<u&&s.push(`Need ${u-e.completedBundles} more completed bundles`),t.push(`Complete ${r.label} certification course`),t.push("Pass practical skill assessment"),t.push("Supervisor evaluation"),{eligible:s.length===0,nextLevel:r.label,requirements:t,blockers:s}}}const E={validateOperatorCreation:x.validateOperatorCreation,validateWorkAssignment:x.validateWorkAssignment,analyzePerformance:x.analyzePerformance,validateShiftAssignment:x.validateShiftAssignment,validateMachineAssignment:x.validateMachineAssignment,validateLeaveRequest:x.validateLeaveRequest,recommendTraining:x.recommendTraining,evaluatePromotion:x.evaluatePromotion};class we extends R{constructor(e){super(f.OPERATORS,e)}validate(e){const t=[];return(!e.username||typeof e.username!="string")&&t.push("Username is required and must be a string"),(!e.name||typeof e.name!="string")&&t.push("Name is required and must be a string"),e.role!=="operator"&&t.push('Role must be "operator"'),(!e.skills||!Array.isArray(e.skills))&&t.push("Skills must be provided as an array"),e.efficiencyRating!==void 0&&(typeof e.efficiencyRating!="number"||e.efficiencyRating<0||e.efficiencyRating>100)&&t.push("Efficiency rating must be a number between 0 and 100"),e.qualityScore!==void 0&&(typeof e.qualityScore!="number"||e.qualityScore<0||e.qualityScore>100)&&t.push("Quality score must be a number between 0 and 100"),{valid:t.length===0,errors:t}}async getBySkill(e,t){return this.getWhere("skills","array-contains",e,t)}async getAvailableOperators(e){return this.getWhere("availabilityStatus","==","available",e)}async getByEfficiencyRange(e,t,s){const i=[{field:"efficiencyRating",operator:">=",value:e},{field:"efficiencyRating",operator:"<=",value:t}];return this.query({...s,where:i})}async updateAvailabilityStatus(e,t,s){return this.update(e,{availabilityStatus:t,lastActiveTime:new Date},s)}async updateStatistics(e,t,s){const i={};return t.piecesCompleted!==void 0&&(i.totalPiecesCompleted=t.piecesCompleted),t.earnings!==void 0&&(i.totalEarnings=t.earnings),t.efficiencyRating!==void 0&&(i.efficiencyRating=t.efficiencyRating),t.qualityScore!==void 0&&(i.qualityScore=t.qualityScore),this.update(e,i,s)}async getTopPerformers(e=10){return this.query({orderByField:"efficiencyRating",orderDirection:"desc",limit:e,where:[{field:"active",operator:"==",value:!0}]})}async searchOperators(e,t){const s=await this.query({...t,where:[{field:"name",operator:">=",value:e},{field:"name",operator:"<=",value:e+""}]}),i=await this.query({...t,where:[{field:"username",operator:">=",value:e},{field:"username",operator:"<=",value:e+""}]});if(s.success&&i.success){const n=[...s.data||[],...i.data||[]].filter((a,o,c)=>c.findIndex(u=>u.id===a.id)===o);return{success:!0,data:n,metadata:{totalCount:n.length}}}return s.success?s:i}async getOperatorDashboardData(e){try{const t=await this.getById(e);if(!t.success)return t;const s=new Date().toISOString().split("T")[0];return{success:!0,data:{operator:t.data,todayStats:{piecesCompleted:0,earnings:0,hoursWorked:0,efficiency:0},weeklyStats:{totalPieces:0,totalEarnings:0,averageEfficiency:0,workingDays:0},currentAssignments:[],recentCompletions:[]}}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to get dashboard data"}}}async updateMultipleStatuses(e,t){const s=e.map(i=>({id:i.operatorId,data:{availabilityStatus:i.status,lastActiveTime:new Date}}));return this.batchUpdate(s,t)}async getByDepartment(e,t){return this.getWhere("department","==",e,t)}async getByMachineType(e,t){return this.getWhere("machineType","==",e,t)}async getOperatorsOnShift(e,t){return this.getWhere("shiftPreference","==",e,t)}shouldAudit(){return!0}}class Se extends R{constructor(e){super(f.SUPERVISORS,e)}validate(e){const t=[];return(!e.username||typeof e.username!="string")&&t.push("Username is required and must be a string"),(!e.name||typeof e.name!="string")&&t.push("Name is required and must be a string"),e.role!=="supervisor"&&t.push('Role must be "supervisor"'),(!e.supervisorLevel||!["junior","senior","lead"].includes(e.supervisorLevel))&&t.push("Supervisor level must be junior, senior, or lead"),(!e.responsibleLines||!Array.isArray(e.responsibleLines))&&t.push("Responsible lines must be provided as an array"),(!e.teamMembers||!Array.isArray(e.teamMembers))&&t.push("Team members must be provided as an array"),{valid:t.length===0,errors:t}}async getBySupervisorLevel(e,t){return this.getWhere("supervisorLevel","==",e,t)}async getByResponsibleLine(e,t){return this.getWhere("responsibleLines","array-contains",e,t)}async getSupervisorForOperator(e,t){return this.getWhere("teamMembers","array-contains",e,t)}async addOperatorToTeam(e,t,s){const i=await this.getById(e);if(!i.success||!i.data)return i;const r=[...i.data.teamMembers||[]];return r.includes(t)||r.push(t),this.update(e,{teamMembers:r,managedOperatorCount:r.length},s)}async removeOperatorFromTeam(e,t,s){const i=await this.getById(e);if(!i.success||!i.data)return i;const r=(i.data.teamMembers||[]).filter(n=>n!==t);return this.update(e,{teamMembers:r,managedOperatorCount:r.length},s)}async assignLineResponsibility(e,t,s){const i=await this.getById(e);if(!i.success||!i.data)return i;const r=[...i.data.responsibleLines||[]];return r.includes(t)||r.push(t),this.update(e,{responsibleLines:r},s)}async removeLineResponsibility(e,t,s){const i=await this.getById(e);if(!i.success||!i.data)return i;const r=(i.data.responsibleLines||[]).filter(n=>n!==t);return this.update(e,{responsibleLines:r},s)}async getSupervisorWorkload(e){try{const t=await this.getById(e);return!t.success||!t.data?t:{success:!0,data:{supervisor:t.data,totalOperators:t.data.teamMembers?.length||0,activeOperators:0,totalLines:t.data.responsibleLines?.length||0,pendingTasks:0,todayAssignments:0}}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to get workload data"}}}async getSupervisorsWithCapacity(e=20,t){return this.query({...t,where:[{field:"managedOperatorCount",operator:"<",value:e},{field:"active",operator:"==",value:!0}]})}async getSeniorSupervisors(e){return this.query({...e,where:[{field:"supervisorLevel",operator:"in",value:["senior","lead"]},{field:"active",operator:"==",value:!0}]})}async bulkReassignOperators(e,t,s,i){try{const r=[{type:"read",collection:this.collectionName,id:e},{type:"read",collection:this.collectionName,id:t}],n=await this.transaction(r,i);if(!n.success)return{success:!1,error:"Failed to read supervisors for reassignment"};const a=n.results[e],o=n.results[t];if(!a||!o)return{success:!1,error:"One or both supervisors not found"};const c=(a.teamMembers||[]).filter(h=>!s.includes(h)),u=[...o.teamMembers||[],...s],d=[{type:"update",collection:this.collectionName,id:e,data:{teamMembers:c,managedOperatorCount:c.length}},{type:"update",collection:this.collectionName,id:t,data:{teamMembers:u,managedOperatorCount:u.length}}];return(await this.transaction(d,i)).success?{success:!0,data:{fromSupervisor:{...a,teamMembers:c,managedOperatorCount:c.length},toSupervisor:{...o,teamMembers:u,managedOperatorCount:u.length},reassignedCount:s.length}}:{success:!1,error:"Failed to update supervisor assignments"}}catch(r){return{success:!1,error:r instanceof Error?r.message:"Bulk reassignment failed"}}}async getSupervisorDashboardData(e){try{const t=await this.getById(e);return!t.success||!t.data?t:{success:!0,data:{supervisor:t.data,teamStats:{totalOperators:t.data.teamMembers?.length||0,activeOperators:0,efficiency:0,qualityScore:0},lineStatus:{totalLines:t.data.responsibleLines?.length||0,activeLines:0,targetEfficiency:0,actualEfficiency:0},pendingApprovals:[],todayActivities:[]}}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to get dashboard data"}}}async searchSupervisors(e,t){const s=[{field:"name",operator:">=",value:e},{field:"name",operator:"<=",value:e+""},...t?[{field:"supervisorLevel",operator:"==",value:t}]:[]];return this.query({where:s})}shouldAudit(){return!0}}class be extends R{constructor(e){super(f.WORK_ITEMS,e)}validate(e){const t=[];return(!e.bundleNumber||typeof e.bundleNumber!="string")&&t.push("Bundle number is required and must be a string"),(!e.operation||typeof e.operation!="string")&&t.push("Operation is required and must be a string"),(!e.pieces||typeof e.pieces!="number"||e.pieces<=0)&&t.push("Pieces must be a positive number"),(!e.rate||typeof e.rate!="number"||e.rate<=0)&&t.push("Rate must be a positive number"),e.status&&!["pending","assigned","self_assigned","in_progress","completed","cancelled","on_hold"].includes(e.status)&&t.push("Invalid status value"),e.paymentStatus&&!["PENDING","HELD_FOR_DAMAGE","RELEASED","PAID"].includes(e.paymentStatus)&&t.push("Invalid payment status value"),{valid:t.length===0,errors:t}}async getByStatus(e,t){return this.getWhere("status","==",e,t)}async getAssignedToOperator(e,t){return this.getWhere("operatorId","==",e,{...t,where:[{field:"operatorId",operator:"==",value:e},{field:"status",operator:"in",value:["assigned","self_assigned","in_progress"]}]})}async getByBundle(e,t){return this.getWhere("bundleNumber","==",e,t)}async getPendingWorkItems(e){return this.getWhere("status","==","pending",e)}async getByOperation(e,t){return this.getWhere("operation","==",e,t)}async getByPaymentStatus(e,t){return this.getWhere("paymentStatus","==",e,t)}async getWorkItemsRequiringRework(e){return this.getWhere("reworkRequired","==",!0,e)}async selfAssignWorkItem(e,t,s){const i=await this.getById(e);return!i.success||!i.data?i:i.data.status!=="pending"?{success:!1,error:"Work item is not available for self-assignment",errorCode:"WORK_ITEM_NOT_AVAILABLE"}:this.update(e,{operatorId:t,status:"self_assigned",assignedAt:new Date},s)}async startWork(e,t,s){const i=await this.getById(e);return!i.success||!i.data?i:i.data.operatorId!==t?{success:!1,error:"Work item is not assigned to this operator",errorCode:"WORK_ITEM_NOT_ASSIGNED"}:["assigned","self_assigned"].includes(i.data.status)?this.update(e,{status:"in_progress",startedAt:new Date},s):{success:!1,error:"Work item cannot be started in current status",errorCode:"INVALID_STATUS_TRANSITION"}}async completeWorkItem(e,t,s){const i=await this.getById(e);if(!i.success||!i.data)return i;if(i.data.operatorId!==t.operatorId)return{success:!1,error:"Work item is not assigned to this operator",errorCode:"WORK_ITEM_NOT_ASSIGNED"};if(i.data.status!=="in_progress")return{success:!1,error:"Work item is not in progress",errorCode:"INVALID_STATUS_TRANSITION"};const r={status:"completed",completedAt:new Date,completedPieces:t.piecesCompleted,qualityScore:t.qualityScore,actualTimeMinutes:t.timeSpentMinutes,defects:t.defects,paymentStatus:"RELEASED",canWithdraw:!0},n=t.piecesCompleted*i.data.rate;return r.totalValue=n,this.update(e,r,s)}async holdPaymentForDamage(e,t,s,i){return this.update(e,{paymentStatus:"HELD_FOR_DAMAGE",canWithdraw:!1,reworkRequired:!0,reworkReason:`Payment held due to damage report: ${t}`},i)}async releaseHeldPayment(e,t){const s=await this.getById(e);return!s.success||!s.data?s:s.data.paymentStatus!=="HELD_FOR_DAMAGE"?{success:!1,error:"Payment is not currently held",errorCode:"PAYMENT_NOT_HELD"}:this.update(e,{paymentStatus:"RELEASED",canWithdraw:!0,reworkRequired:!1,reworkReason:void 0},t)}async getByDifficulty(e,t){return this.getWhere("difficulty","==",e,t)}async getWorkItemsByDateRange(e,t,s){return this.query({...s,where:[{field:"createdAt",operator:">=",value:e},{field:"createdAt",operator:"<=",value:t}]})}async getCompletedWorkItemsByDateRange(e,t,s){return this.query({...s,where:[{field:"completedAt",operator:">=",value:e},{field:"completedAt",operator:"<=",value:t},{field:"status",operator:"==",value:"completed"}]})}async getWorkItemStatistics(e){try{const t=[];e?.operatorId&&t.push({field:"operatorId",operator:"==",value:e.operatorId}),e?.bundleNumber&&t.push({field:"bundleNumber",operator:"==",value:e.bundleNumber}),e?.operation&&t.push({field:"operation",operator:"==",value:e.operation}),e?.dateFrom&&t.push({field:"createdAt",operator:">=",value:e.dateFrom}),e?.dateTo&&t.push({field:"createdAt",operator:"<=",value:e.dateTo});const s=await this.query({where:t,limit:1e4});if(!s.success||!s.data)return{success:!1,error:"Failed to fetch work items for statistics"};const i=s.data;return{success:!0,data:{totalItems:i.length,completedItems:i.filter(n=>n.status==="completed").length,pendingItems:i.filter(n=>n.status==="pending").length,inProgressItems:i.filter(n=>n.status==="in_progress").length,totalPieces:i.reduce((n,a)=>n+a.pieces,0),completedPieces:i.reduce((n,a)=>n+(a.completedPieces||0),0),totalEarnings:i.reduce((n,a)=>n+(a.totalValue||0),0),averageQuality:i.length>0?i.reduce((n,a)=>n+(a.qualityScore||0),0)/i.length:0,averageEfficiency:0}}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to calculate statistics"}}}async bulkUpdateStatus(e,t,s){const i=e.map(r=>({id:r,data:{status:t}}));return this.batchUpdate(i,s)}async getWorkItemsSummary(e){try{const t=e?[{field:"operatorId",operator:"==",value:e}]:[],s=await this.query({where:t,limit:1e4});if(!s.success||!s.data)return{success:!1,error:"Failed to fetch work items summary"};const i=s.data;return{success:!0,data:{pending:i.filter(n=>n.status==="pending").length,assigned:i.filter(n=>["assigned","self_assigned"].includes(n.status)).length,inProgress:i.filter(n=>n.status==="in_progress").length,completed:i.filter(n=>n.status==="completed").length,onHold:i.filter(n=>n.status==="on_hold").length}}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to get summary"}}}shouldAudit(){return!0}}class ke extends R{constructor(e){super(f.BUNDLES,e)}validate(e){const t=[];return(!e.bundleNumber||typeof e.bundleNumber!="string")&&t.push("Bundle number is required and must be a string"),(!e.articleNumber||typeof e.articleNumber!="string")&&t.push("Article number is required and must be a string"),(!e.customerPO||typeof e.customerPO!="string")&&t.push("Customer PO is required and must be a string"),(!e.orderQuantity||typeof e.orderQuantity!="number"||e.orderQuantity<=0)&&t.push("Order quantity must be a positive number"),e.deliveryDate||t.push("Delivery date is required"),(!e.sizes||!Array.isArray(e.sizes)||e.sizes.length===0)&&t.push("Sizes must be provided as a non-empty array"),e.priority&&!["low","normal","high","urgent"].includes(e.priority)&&t.push("Priority must be low, normal, high, or urgent"),e.status&&!["pending","in_progress","completed","on_hold","cancelled"].includes(e.status)&&t.push("Invalid status value"),{valid:t.length===0,errors:t}}async getByStatus(e,t){return this.getWhere("status","==",e,t)}async getByPriority(e,t){return this.getWhere("priority","==",e,t)}async getByCustomerPO(e,t){return this.getWhere("customerPO","==",e,t)}async getByArticleNumber(e,t){return this.getWhere("articleNumber","==",e,t)}async getByDeliveryDateRange(e,t,s){return this.query({...s,where:[{field:"deliveryDate",operator:">=",value:e},{field:"deliveryDate",operator:"<=",value:t}]})}async getUrgentBundles(e){const t=new Date;return t.setDate(t.getDate()+3),this.query({...e,where:[{field:"priority",operator:"in",value:["high","urgent"]}]})}async getOverdueBundles(e){const t=new Date;return this.query({...e,where:[{field:"deliveryDate",operator:"<",value:t},{field:"status",operator:"!=",value:"completed"}]})}async updateProgress(e,t,s){const i=await this.getById(e);if(!i.success||!i.data)return i;const r=i.data.totalPieces,n=Math.max(0,r-t),a={completedPieces:t,remainingPieces:n};return t===0&&i.data.status==="pending"||(t>0&&t<r?a.status="in_progress":t>=r&&(a.status="completed",a.actualCompletion=new Date)),this.update(e,a,s)}async setPriority(e,t,s){return this.update(e,{priority:t},s)}async holdBundle(e,t,s){return this.update(e,{status:"on_hold"},s)}async resumeBundle(e,t){const s=await this.getById(e);if(!s.success||!s.data)return s;const i=s.data.completedPieces>0?"in_progress":"pending";return this.update(e,{status:i},t)}async cancelBundle(e,t,s){return this.update(e,{status:"cancelled"},s)}async getBundleStatistics(e){try{const t=[];e?.status&&t.push({field:"status",operator:"==",value:e.status}),e?.priority&&t.push({field:"priority",operator:"==",value:e.priority}),e?.articleNumber&&t.push({field:"articleNumber",operator:"==",value:e.articleNumber}),e?.dateFrom&&t.push({field:"createdAt",operator:">=",value:e.dateFrom}),e?.dateTo&&t.push({field:"createdAt",operator:"<=",value:e.dateTo});const s=await this.query({where:t,limit:1e4});if(!s.success||!s.data)return{success:!1,error:"Failed to fetch bundles for statistics"};const i=s.data,r=new Date;return{success:!0,data:{totalBundles:i.length,completedBundles:i.filter(a=>a.status==="completed").length,inProgressBundles:i.filter(a=>a.status==="in_progress").length,pendingBundles:i.filter(a=>a.status==="pending").length,onHoldBundles:i.filter(a=>a.status==="on_hold").length,overdueBundles:i.filter(a=>new Date(a.deliveryDate)<r&&a.status!=="completed").length,totalPieces:i.reduce((a,o)=>a+o.totalPieces,0),completedPieces:i.reduce((a,o)=>a+o.completedPieces,0),averageCompletionRate:i.length>0?i.reduce((a,o)=>{const c=o.totalPieces>0?o.completedPieces/o.totalPieces*100:0;return a+c},0)/i.length:0,averageDelayDays:0}}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to calculate statistics"}}}async getBundleTimeline(e){try{return{success:!0,data:[{timestamp:new Date,event:"Bundle Created",description:"Bundle was created in the system",type:"info"}]}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to get timeline"}}}async searchBundles(e,t){const s=await this.query({...t,where:[{field:"bundleNumber",operator:">=",value:e},{field:"bundleNumber",operator:"<=",value:e+""}]}),i=await this.query({...t,where:[{field:"articleNumber",operator:">=",value:e},{field:"articleNumber",operator:"<=",value:e+""}]});if(s.success&&i.success){const n=[...s.data||[],...i.data||[]].filter((a,o,c)=>c.findIndex(u=>u.id===a.id)===o);return{success:!0,data:n,metadata:{totalCount:n.length}}}return s.success?s:i}async getBundleDashboardSummary(){try{const e=await this.getAll({limit:1e4});if(!e.success||!e.data)return{success:!1,error:"Failed to fetch bundles for summary"};const t=e.data,s=new Date,i=new Date(s.getFullYear(),s.getMonth(),s.getDate());return{success:!0,data:{totalBundles:t.length,activeBundles:t.filter(n=>["pending","in_progress"].includes(n.status)).length,completedToday:t.filter(n=>n.status==="completed"&&n.actualCompletion&&new Date(n.actualCompletion)>=i).length,overdue:t.filter(n=>new Date(n.deliveryDate)<s&&n.status!=="completed").length,highPriority:t.filter(n=>["high","urgent"].includes(n.priority)).length}}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Failed to get summary"}}}shouldAudit(){return!0}}new we({cache:{enabled:!0,ttl:600*1e3,maxSize:500,strategy:"lru",invalidateOnUpdate:!0},retry:{enabled:!0,maxAttempts:3,backoffStrategy:"exponential",baseDelay:1e3,maxDelay:1e4},performance:{enabled:!0,trackLatency:!0,trackThroughput:!0,trackErrors:!0,sampleRate:1}});new Se({cache:{enabled:!0,ttl:900*1e3,maxSize:200,strategy:"lru",invalidateOnUpdate:!0}});new be({cache:{enabled:!0,ttl:300*1e3,maxSize:1e3,strategy:"lru",invalidateOnUpdate:!0},retry:{enabled:!0,maxAttempts:5,backoffStrategy:"exponential",baseDelay:500,maxDelay:5e3}});new ke({cache:{enabled:!0,ttl:1800*1e3,maxSize:1e3,strategy:"lru",invalidateOnUpdate:!0}});new ve({cache:{enabled:!0,ttl:120*1e3,maxSize:500,strategy:"lru",invalidateOnUpdate:!1},offlineSync:!1});class Ae extends R{constructor(e){super("management",e)}validate(e){return{valid:!0,errors:[]}}}class Ee extends R{constructor(e){super("workAssignments",e)}validate(e){return{valid:!0,errors:[]}}}class Re extends R{constructor(e){super("productionStats",e)}validate(e){return{valid:!0,errors:[]}}}class xe extends R{constructor(e){super("qualityIssues",e)}validate(e){return{valid:!0,errors:[]}}}class Oe extends R{constructor(e){super("systemSettings",e)}validate(e){return{valid:!0,errors:[]}}}new Ae;new Ee;new Re;new xe;new Oe;class O{static validateSupervisorCreation(e){const t=[],s=[],i=e;(!i.username||i.username.length<3)&&t.push("Username must be at least 3 characters long"),(!e.supervisorLevel||!["junior","senior","lead"].includes(e.supervisorLevel))&&t.push("Supervisor level must be junior, senior, or lead");const r=e.experienceMonths||0,a={junior:12,senior:36,lead:60}[e.supervisorLevel];a&&r<a&&t.push(`${e.supervisorLevel} supervisor requires at least ${a} months of experience`);const c={junior:8,senior:15,lead:25}[e.supervisorLevel];e.teamMembers&&e.teamMembers.length>c&&s.push(`Team size (${e.teamMembers.length}) exceeds recommended maximum for ${e.supervisorLevel} supervisor (${c})`),(!e.responsibleLines||!Array.isArray(e.responsibleLines)||e.responsibleLines.length===0)&&t.push("Supervisor must be assigned to at least one production line");const d={junior:2,senior:4,lead:8}[e.supervisorLevel];return e.responsibleLines&&e.responsibleLines.length>d&&s.push(`Line responsibility (${e.responsibleLines.length}) exceeds recommended for ${e.supervisorLevel} supervisor (${d})`),{isValid:t.length===0,errors:t,warnings:s}}static evaluateWorkAssignment(e,t,s,i){const r=[],n=[];let a="low";if(!e.teamMembers.includes(t.id))return{canAssign:!1,reason:"Operator is not under your supervision",alternativeSuggestions:["Contact operator's direct supervisor"],requiredApprovals:[],riskLevel:"high"};if(i.currentWorkload>=t.maxConcurrentWork)return{canAssign:!1,reason:"Operator at maximum workload capacity",alternativeSuggestions:["Wait for current work completion","Reassign lower priority work","Find alternative operator"],requiredApprovals:[],riskLevel:"medium"};const o=["beginner","intermediate","advanced","expert"],c=o.indexOf(i.operatorSkillLevel),u=o.indexOf(s.requiredSkillLevel||"beginner");c<u&&(a="high",r.push("Consider providing additional supervision"),r.push("Pair with experienced operator for mentoring"),e.supervisorLevel==="junior"&&n.push("Senior supervisor approval required for skill mismatch assignments"));const d=(i.deadline.getTime()-Date.now())/(1e3*60*60);return d<24&&(a=a==="high"?"high":"medium",r.push("Monitor progress closely due to tight deadline"),d<4&&n.push("Management approval required for urgent assignments")),i.machineAvailability?(t.qualityScore<.8&&s.priority==="high"&&(a="high",r.push("Implement additional quality checks"),r.push("Consider assigning to higher quality operator"),e.supervisorLevel==="junior"&&n.push("Senior supervisor approval for high-priority work to low-quality operator")),{canAssign:!0,alternativeSuggestions:r,requiredApprovals:n,riskLevel:a}):{canAssign:!1,reason:"Required machine type not available",alternativeSuggestions:["Schedule when machine becomes available","Find operator with alternative machine skills"],requiredApprovals:[],riskLevel:"medium"}}static evaluateAssignmentRequest(e,t,s,i){const r=[],n=[];let a="junior";const o={minEfficiency:.85,minQuality:.9,maxWorkloadUtilization:.8},c=s.averageEfficiency>=o.minEfficiency&&s.qualityScore>=o.minQuality,u=["beginner","intermediate","advanced","expert"],d=u.indexOf(s.skillLevel),p=u.indexOf(i.requiredSkillLevel||"beginner"),h=Math.max(0,p-d);h>0&&(r.push(`Skill level gap: operator is ${s.skillLevel}, work requires ${i.requiredSkillLevel}`),a=h>1?"senior":"junior",n.push("Verify operator training records")),i.complexity>7&&(r.push("High complexity work item"),n.push("Ensure operator has handled similar complexity before"),a="senior");const v=(s.realtimeStatus?.currentWorkItems||0)/s.maxConcurrentWork;v>.9&&(r.push("Operator near maximum capacity"),n.push("Confirm operator can handle additional workload")),s.machineTypes.includes(i.machineType)||(r.push("Machine type not in operator certifications"),a="senior",n.push("Verify cross-training completion")),i.priority==="urgent"&&(r.push("Urgent priority work assignment"),n.push("Confirm deadline feasibility"),c||(a="senior"));const S=c&&h===0&&v<=o.maxWorkloadUtilization&&s.machineTypes.includes(i.machineType)&&i.complexity<=6&&i.priority!=="urgent"&&t.supervisorLevel!=="junior";let y="";return S?y="High-performing operator with perfect skill match and optimal workload":r.length>0?y=`Manual review required due to: ${r.join(", ")}`:y="Standard approval process required",{shouldAutoApprove:S,reason:y,requiredSupervisorLevel:a,additionalValidations:n,riskFactors:r}}static analyzeTeamProductivity(e,t,s){const i=[],r=t.reduce((u,d)=>u+d.averageEfficiency,0)/t.length,n=t.reduce((u,d)=>u+d.qualityScore,0)/t.length,a=s.completedWork.length>0?s.completedWork.filter(u=>u.status==="completed").length/s.completedWork.length:0,o=s.totalDeliveries>0?s.onTimeDeliveries/s.totalDeliveries:0,c=(r*.3+n*.3+a*.2+o*.2)*100;return r<.7&&(i.push("Implement efficiency improvement training"),i.push("Review work allocation strategies"),i.push("Consider process optimization workshops")),n<.85&&(i.push("Increase quality control measures"),i.push("Implement peer review processes"),i.push("Schedule quality training sessions")),o<.9&&(i.push("Improve deadline management"),i.push("Implement better work planning"),i.push("Review resource allocation")),a<.8&&(i.push("Investigate workflow bottlenecks"),i.push("Review task complexity assignments"),i.push("Consider team restructuring")),e.supervisorLevel==="junior"&&c<70&&(i.push("Seek senior supervisor mentoring"),i.push("Attend supervisory skill development training")),t.length>10&&e.supervisorLevel==="junior"&&i.push("Consider team size reduction or promotion to senior level"),{teamEfficiency:r,averageQuality:n,completionRate:a,onTimeDelivery:o,recommendedActions:i,teamHealthScore:Math.round(c)}}static evaluateSupervisorPerformance(e,t,s){const i=[],r=[],n=[],a=s.correctDecisions/s.decisionsMade;a>.9?i.push("Excellent decision-making skills"):a<.7&&r.push("Improve decision-making accuracy through training"),t.teamHealthScore>80?i.push("Strong team leadership and performance management"):t.teamHealthScore<60&&r.push("Focus on team productivity improvement"),s.trainingSessionsConducted>0?i.push("Active in team development and training"):r.push("Increase focus on team training and development"),s.teamSatisfactionScore>4?i.push("High team satisfaction and morale"):s.teamSatisfactionScore<3&&r.push("Improve team communication and relationship building");const o={decisionAccuracy:a*25,teamHealth:t.teamHealthScore/100*30,teamSatisfaction:s.teamSatisfactionScore/5*25,development:Math.min(s.trainingSessionsConducted*5,20)},c=Object.values(o).reduce((d,p)=>d+p,0);let u=!1;return e.supervisorLevel==="junior"&&c>=75?(u=!0,n.push("Complete senior supervisor certification"),n.push("Demonstrate team size management (10+ operators)"),n.push("Lead cross-training initiatives")):e.supervisorLevel==="senior"&&c>=85?(u=!0,n.push("Complete leadership development program"),n.push("Demonstrate multi-line management capability"),n.push("Mentor junior supervisors")):(c<60&&n.push("Improve overall performance score to 60+"),t.teamHealthScore<70&&n.push("Achieve team health score of 70+"),a<.8&&n.push("Improve decision accuracy to 80+")),{overallScore:Math.round(c),strengths:i,improvementAreas:r,promotionEligible:u,nextLevelRequirements:n}}static shouldEscalateDecision(e,t){const{type:s,impact:i,cost:r,affectedOperators:n,customerImpact:a}=t,c={junior:{maxCost:5e3,maxOperators:3,canHandleCustomerImpact:!1},senior:{maxCost:2e4,maxOperators:10,canHandleCustomerImpact:!0},lead:{maxCost:5e4,maxOperators:25,canHandleCustomerImpact:!0}}[e.supervisorLevel];return r>c.maxCost?{shouldEscalate:!0,reason:`Cost (₹${r}) exceeds supervisor authority limit (₹${c.maxCost})`,escalateTo:"management",timeframe:r>c.maxCost*2?"immediate":"within_hour"}:n>c.maxOperators?{shouldEscalate:!0,reason:`Number of affected operators (${n}) exceeds authority limit (${c.maxOperators})`,escalateTo:"senior_supervisor",timeframe:"within_hour"}:a&&!c.canHandleCustomerImpact?{shouldEscalate:!0,reason:"Customer impact decisions require higher authority",escalateTo:"management",timeframe:"immediate"}:s==="quality_issue"&&i==="high"?{shouldEscalate:!0,reason:"High impact quality issues require specialized expertise",escalateTo:"quality_head",timeframe:"immediate"}:s==="disciplinary"&&i==="high"?{shouldEscalate:!0,reason:"Serious disciplinary actions require management approval",escalateTo:"management",timeframe:"within_day"}:{shouldEscalate:!1,reason:"Within supervisor authority limits",escalateTo:"senior_supervisor",timeframe:"immediate"}}static evaluateQualityIssue(e,t){const{severity:s,affectedPieces:i,totalPieces:r,customerOrder:n,defectType:a}=t,o=i/r,c=[];return s==="critical"?(c.push("Immediate supervisor notification"),c.push("Document root cause analysis"),c.push("Implement corrective actions"),{action:"escalate",reasoning:"Critical quality issues require management decision",paymentAction:"hold_payment",additionalSteps:c}):s==="major"&&(o>.1||n)?a.includes("measurement")||a.includes("size")?(c.push("Quality team verification"),c.push("Check measurement tools calibration"),{action:"scrap",reasoning:"Size/measurement defects cannot be reworked effectively",paymentAction:"no_pay",additionalSteps:c}):(c.push("Assign to experienced operator for rework"),c.push("Additional quality inspection after rework"),{action:"rework",reasoning:"Major defects can be corrected through rework",paymentAction:"partial_pay",additionalSteps:c}):s==="minor"?o<.05?{action:"accept_with_discount",reasoning:"Minor defects with low impact rate",paymentAction:"partial_pay",additionalSteps:["Note quality concern in operator record"]}:(c.push("Provide quality feedback to operator"),c.push("Monitor next few bundles closely"),{action:"rework",reasoning:"High rate of minor defects needs correction",paymentAction:"partial_pay",additionalSteps:c}):{action:"escalate",reasoning:"Unable to determine appropriate action",paymentAction:"hold_payment",additionalSteps:["Require senior supervisor review"]}}}const G={validateSupervisorCreation:O.validateSupervisorCreation,evaluateWorkAssignment:O.evaluateWorkAssignment,evaluateAssignmentRequest:O.evaluateAssignmentRequest,analyzeTeamProductivity:O.analyzeTeamProductivity,evaluateSupervisorPerformance:O.evaluateSupervisorPerformance,shouldEscalateDecision:O.shouldEscalateDecision,evaluateQualityIssue:O.evaluateQualityIssue};class M{static evaluateResourceAllocation(e,t,s,i){const r=[],n=[];let a=0;s.sort((u,d)=>{const p=this.calculateBundlePriority(u,i);return this.calculateBundlePriority(d,i)-p}),this.groupOperatorsBySkill(e);for(const u of t){const d=e.filter(y=>y.machineTypes.includes(u.machineType)&&y.currentStatus==="idle");if(d.length===0){r.push(`No available operators for ${u.name}`);continue}const p=Math.min(d.length,u.maxOperators,Math.ceil(u.targetEfficiency*u.maxOperators)),h=d.sort((y,_)=>_.averageEfficiency*_.qualityScore-y.averageEfficiency*y.qualityScore).slice(0,p),v=h.reduce((y,_)=>y+_.averageEfficiency,0)/h.length,S=p*v*u.hoursPerDay*u.averageRatePerHour;n.push({lineId:u.id,allocatedOperators:p,expectedEfficiency:v,predictedOutput:S}),a+=S*u.profitMarginPerPiece}const o=n.filter(u=>u.allocatedOperators<3);return o.length>0&&r.push(`${o.length} production lines under-utilized`),e.filter(u=>u.realtimeStatus?.currentWorkItems>u.maxConcurrentWork*.9).length>e.length*.3&&r.push("Over 30% of operators at maximum capacity"),{canAllocate:n.length>0,optimizedDistribution:n,riskFactors:r,expectedROI:a,timeToBreakeven:a>0?30:void 0}}static evaluateBudgetRequest(e,t,s){const i=[],r=[];let n="medium";if(e.amount>t.remaining)return{approved:!1,approvedAmount:0,conditions:[`Request exceeds available budget by ₹${e.amount-t.remaining}`],paybackPeriod:0,riskAssessment:"high",alternatives:["Request budget reallocation from other departments","Phase the investment over multiple quarters","Seek partial approval for critical components only"]};let a=.7,o=12;switch(e.category){case"equipment":a=.6,o=8,e.amount>1e5&&(i.push("Requires detailed equipment ROI analysis"),i.push("Must include maintenance cost projections"));break;case"training":a=.8,o=18,i.push("Must track skill improvement metrics"),i.push("Require training completion certificates");break;case"technology":a=.7,o=10,e.amount>2e5&&(i.push("Pilot implementation required first"),i.push("Vendor support agreement mandatory"));break;case"infrastructure":a=.5,o=24,i.push("Must improve overall facility efficiency");break;case"expansion":a=.8,o=15,i.push("Market demand analysis required"),i.push("Gradual rollout plan mandatory");break}const c=s.previousRequestsROI.length>0?s.previousRequestsROI.reduce((v,S)=>v+S,0)/s.previousRequestsROI.length:.5;c<.3?(n="high",a+=.2,i.push("Enhanced monitoring and reporting required due to low historical ROI")):c>.8&&(n="low",a-=.1),s.departmentEfficiency<.7&&(i.push("Department must improve efficiency metrics before additional investment"),a+=.15),s.pastBudgetUtilization<.8&&(i.push("Must improve budget utilization (currently "+Math.round(s.pastBudgetUtilization*100)+"%)"),n="medium");const u=e.amount/t.total;u>.3?(n="high",i.push("Large investment requires board approval"),i.push("Phased implementation plan required")):u<.05&&(n="low");const p=(c+s.departmentEfficiency+s.pastBudgetUtilization)/3>=a,h=p?e.amount:Math.min(e.amount*.5,t.remaining*.2);return!p&&h>0&&(r.push(`Partial approval of ₹${h} available`),r.push("Resubmit with improved justification and reduced scope")),{approved:p,approvedAmount:p?e.amount:h,conditions:i,paybackPeriod:o,riskAssessment:n,alternatives:p?void 0:r}}static analyzeCompanyPerformance(e,t,s,i){const r=[],n=[],a=Math.min(t.profitMargin*100,100),o=t.budgetUtilization*100,c=(a+o)/2,u=e.activeOperators/e.totalOperators*100,d=e.averageEfficiency*100,p=e.qualityScore*100,h=e.onTimeDelivery*100,v=(u+d+p+h)/4,S=s.marketShare*100,y=s.competitorAnalysis*100,_=e.customerSatisfactionScore/5*100,oe=s.customerRetentionRate*100,F=(S+y+_+oe)/4,ce=Math.min(s.growthRate*10,100),le=this.calculateTrendScore(i),J=Math.min(ce+le,100);return c<60&&(r.push("Implement cost reduction strategies"),r.push("Review pricing strategy and profit margins"),r.push("Optimize resource allocation"),n.push({metric:"Financial Health",current:Math.round(c),target:75,trend:i.profitabilityTrend})),v<70&&(r.push("Invest in operator training and development"),r.push("Upgrade equipment and technology"),r.push("Implement lean manufacturing principles"),n.push({metric:"Operational Efficiency",current:Math.round(v),target:85,trend:i.efficiencyTrend})),F<65&&(r.push("Enhance customer relationship management"),r.push("Improve product quality and delivery times"),r.push("Develop competitive market strategies"),n.push({metric:"Market Position",current:Math.round(F),target:80,trend:"stable"})),J<50&&(r.push("Explore new market opportunities"),r.push("Invest in innovation and product development"),r.push("Consider strategic partnerships or acquisitions")),e.averageEfficiency<.75&&r.push("Conduct efficiency improvement workshops"),e.qualityScore<.85&&r.push("Implement comprehensive quality management system"),e.onTimeDelivery<.9&&r.push("Improve production planning and scheduling"),{financialHealth:Math.round(c),operationalEfficiency:Math.round(v),marketPosition:Math.round(F),growthPotential:Math.round(J),recommendedActions:r,criticalMetrics:n}}static evaluateExpansionOpportunity(e,t,s){const i=[],r=[],n=[];if(e.investmentRequired>s.availableCapital*.8)return i.push("Investment exceeds 80% of available capital"),r.push("Seek external financing"),r.push("Phase the expansion over multiple periods"),{recommendation:"modify",reasoning:i,alternativeOptions:r,riskMitigation:["Secure financing before proceeding","Reduce initial investment scope"]};if(e.marketDemand<.6)return i.push("Market demand below acceptable threshold (60%)"),r.push("Conduct additional market research"),r.push("Consider different market segments"),{recommendation:"postpone",reasoning:i,alternativeOptions:r,riskMitigation:["Wait for market conditions to improve","Develop demand creation strategies"]};if(e.type==="capacity_expansion"&&t.utilizationRate<.85)return i.push("Current capacity not optimally utilized (less than 85%)"),r.push("Focus on improving current utilization first"),r.push("Optimize existing operations"),{recommendation:"postpone",reasoning:i,alternativeOptions:r,riskMitigation:["Achieve 85% utilization before expanding","Implement efficiency improvements"]};const o=(e.expectedRevenue-e.investmentRequired)/e.investmentRequired/(e.timeToMarket/12);return o<.15?(i.push("Expected ROI below minimum threshold (15% annually)"),r.push("Revise revenue projections"),r.push("Reduce investment costs"),{recommendation:"modify",reasoning:i,alternativeOptions:r,riskMitigation:["Improve cost-benefit analysis","Seek higher-margin opportunities"]}):(e.riskFactors.filter(u=>u.includes("high")||u.includes("critical")||u.includes("uncertain")).length>2&&(i.push("Multiple high-risk factors identified"),n.push("Develop comprehensive risk mitigation plan"),n.push("Create contingency strategies"),n.push("Consider insurance coverage")),s.debtToEquityRatio>.6&&(i.push("High debt-to-equity ratio may limit financing options"),n.push("Consider equity financing over debt"),n.push("Improve debt position before expansion")),i.push(`Strong market demand (${Math.round(e.marketDemand*100)}%)`),i.push(`Good expected ROI (${Math.round(o*100)}% annually)`),i.push("Financial position supports investment"),{recommendation:"approve",reasoning:i,alternativeOptions:[],riskMitigation:n})}static calculateBundlePriority(e,t){const s=t.find(n=>n.articleTypes.includes(e.articleNumber)),i=e.priority==="urgent"?1:e.priority==="high"?.8:e.priority==="normal"?.5:.2,r=s?s.urgency*s.profitMargin:.3;return i*.4+r*.6}static groupOperatorsBySkill(e){return e.reduce((t,s)=>{const i=s.skillLevel;return t[i]||(t[i]=[]),t[i].push(s),t},{})}static calculateTrendScore(e){let t=0;return Object.values(e).forEach(s=>{s==="up"?t+=10:s==="down"&&(t-=5)}),t}}const Ie={evaluateResourceAllocation:M.evaluateResourceAllocation,evaluateBudgetRequest:M.evaluateBudgetRequest,analyzeCompanyPerformance:M.analyzeCompanyPerformance,evaluateExpansionOpportunity:M.evaluateExpansionOpportunity},C={calculateBasePayment:(l,e)=>{const t=parseFloat(l.toString())||0,s=parseInt(e.toString())||0;return t*s},calculateWithEfficiencyBonus:(l,e,t=.9)=>{if(e>=t){let s=0;return e>=1.2?s=.5:e>=1?s=.2+(e-1)/.2*.3:e>=.95?s=.1+(e-.95)/.05*.1:s=(e-t)*2,l*(1+Math.min(s,.5))}return l},calculateQualityBonus:(l,e)=>e>=.98?l*.15:e>=.95?l*.1:e>=.9?l*.05:0,calculateDamageAwarePayment:(l,e,t=[])=>{const s=C.calculateBasePayment(l.rate,e.piecesCompleted),i=t.filter(u=>["stitching_defect","needle_damage","tension_issue","alignment_error","wrong_measurement","missing_operation"].includes(u.damageType)),r=t.filter(u=>["fabric_defect","material_issue","machine_malfunction","design_error"].includes(u.damageType)),n=[];let a=0;i.forEach(u=>{const d=C.calculateDamageDeduction(u,s,l.totalPieces);n.push(d),a+=d.deductionAmount});let o=0;const c={};if(e.efficiency){const u=C.calculateWithEfficiencyBonus(s,e.efficiency)-s;o+=u,c.efficiencyBonus=u}if(e.qualityScore){const u=C.calculateQualityBonus(s,e.qualityScore);o+=u,c.qualityBonus=u}return{basePayment:s,penalties:a,bonuses:o,finalPayment:Math.max(0,s+o-a),operatorFaultDamages:i.length,nonOperatorFaultDamages:r.length,details:{...c,damageDeductions:n}}},calculateDamageDeduction:(l,e,t)=>{if(l.operatorFault===!1)return{damageType:l.damageType,severity:l.severity,affectedPieces:l.affectedPieces,deductionAmount:0,deductionPercentage:0};let s=0;const r={broken_stitch:{minor:.05,major:.15,severe:.25},wrong_measurement:{minor:.1,major:.2,severe:.35},fabric_damage:{minor:.1,major:.25,severe:.4},missing_operation:{minor:.2,major:.3,severe:.5},stitching_defect:{minor:.08,major:.18,severe:.3},needle_damage:{minor:.12,major:.22,severe:.35},tension_issue:{minor:.06,major:.16,severe:.28},alignment_error:{minor:.1,major:.2,severe:.32}}[l.damageType];r?s=r[l.severity]||r.minor:s=l.severity==="major"?.15:l.severity==="severe"?.25:.05;const n=l.affectedPieces||1,a=n/t,o=Math.round(e*s*a);return{damageType:l.damageType,severity:l.severity,affectedPieces:n,deductionAmount:o,deductionPercentage:s}}},Y={calculatePriorityScore:l=>{const t={urgent:5,high:4,normal:3,low:2}[l.priority]||3,s=new Date(l.dueDate),i=new Date,r=Math.ceil((s.getTime()-i.getTime())/(1e3*60*60*24));let n=0;r<=1?n=10:r<=3?n=7:r<=7?n=5:r<=14?n=3:n=1;const a=l.complexity?Math.min(l.complexity,3):0,o=l.customerImportance?l.customerImportance:0;return t*2+n+a+o},calculateMatchScore:(l,e)=>{let t=0;const s=[];let i=0;e.machineTypes?.includes(l.machineType)?(i=50,s.push("Perfect machine compatibility")):Y.getRelatedMachineTypes(l.machineType).some(y=>e.machineTypes?.includes(y))?(i=25,s.push("Related machine experience")):(i=0,s.push("Machine type mismatch")),t+=i;let r=0;const n=["beginner","intermediate","advanced","expert"],a=n.indexOf(l.requiredSkillLevel||"beginner"),o=n.indexOf(e.skillLevel||"beginner");o>=a?(r=30,o===a?(r+=10,s.push("Perfect skill level match")):s.push("Skill level exceeds requirement")):(r=Math.max(0,20-(a-o)*10),s.push("Skill level below requirement")),t+=r;let c=20;const u=e.currentAssignments?.length||0,d=e.maxConcurrentWork||5,p=u/d;p>=1?(c=0,s.push("At maximum capacity")):p>=.8?(c=5,s.push("Near maximum capacity")):p>=.6?(c=15,s.push("Moderate workload")):(c=20,s.push("Light workload")),t+=c;let h=0;return e.averageEfficiency&&e.averageEfficiency>.8&&(h+=8,s.push("High efficiency operator")),e.qualityScore&&e.qualityScore>.9&&(h+=7,s.push("High quality operator")),t+=h,{totalScore:Math.min(t,100),machineCompatibilityScore:i,skillLevelScore:r,workloadScore:c,performanceScore:h,reasons:s.slice(0,3)}},getRelatedMachineTypes:l=>({overlock:["flatlock","serger"],flatlock:["overlock","coverstitch"],singleNeedle:["doubleNeedle","straightStitch"],buttonhole:["buttonAttach","bartack"],cutting:["rotaryCutter","bandKnife"],pressing:["steam","ironPress"]})[l]||[]},ne={calculateQualityScore:(l,e=[])=>{if(l===0)return 1;const t=e.reduce((i,r)=>i+(r.affectedPieces||1),0);return Math.max(0,l-t)/l},calculateQualityMetrics:(l,e=[])=>{const t=ne.calculateQualityScore(l,e),s=l>0?e.reduce((o,c)=>o+(c.affectedPieces||1),0)/l:0,i={minor:0,major:0,severe:0};e.forEach(o=>{const c=o.severity||"minor";i[c]=(i[c]||0)+(o.affectedPieces||1)});let r=0;const n={minor:.3,major:.7,severe:1};Object.entries(i).forEach(([o,c])=>{r+=c/l*(n[o]||.3)});const a=r>.1?"major":r>.05?"minor":"minimal";return{qualityScore:t,defectRate:s,impactScore:r,category:a,severityBreakdown:i}},calculateDefectImpact:(l,e,t)=>{const i={fabric_hole:.9,color_issue:.6,stitching_defect:1,size_issue:.95,alignment_error:.7,broken_stitch:.8,wrong_measurement:.9,missing_operation:1,needle_damage:.75,tension_issue:.65}[l]||.5,r=e/t,n=i*r;return{impactScore:n,category:n>.1?"major":n>.05?"minor":"minimal"}}},ae={calculateEfficiency:(l,e)=>!l||!e||l<=0?0:Math.min(2,e/l),calculateEfficiencyMetrics:(l,e,t,s)=>{const i=ae.calculateEfficiency(l,e),r=l>0?t/(l/60):0,n=s>0?Math.min(1,l/s):0,a=(i*.7+n*.3)*100;return{efficiency:i,piecesPerHour:r,timeUtilization:n,productivityIndex:Math.round(a)}},calculateDailyMetrics:l=>{const e=l.reduce((r,n)=>r+(n.completedPieces||0),0),t=l.reduce((r,n)=>r+(n.timeSpent||0),0),s=l.length>0?l.reduce((r,n)=>r+(n.efficiency||0),0)/l.length:0,i=l.length>0?l.reduce((r,n)=>r+(n.qualityScore||1),0)/l.length:1;return{totalPieces:e,totalTime:t,averageEfficiency:s,bundlesCompleted:l.length,piecesPerHour:t>0?e/(t/60):0,qualityScore:i}},calculateLineEfficiency:l=>l.length===0?0:l.reduce((t,s)=>t+(s.efficiency||0),0)/l.length},Te={generateRecommendations:(l,e)=>{let t=50;const s=[],i=Y.calculateMatchScore(l,e);if(i.machineCompatibilityScore>=50)t+=40,s.push("Perfect machine match");else if(i.machineCompatibilityScore>=25)t+=20,s.push("Related machine experience");else return t=10,s.push("Machine mismatch"),{match:t,reasons:s};return i.skillLevelScore>=30?(t+=15,s.push("Suitable skill level")):i.skillLevelScore>=20&&(t+=10,s.push("Adequate skill level")),i.workloadScore>=15?(t+=10,s.push("Good availability")):i.workloadScore>=5&&(t+=5,s.push("Limited availability")),(l.priority==="urgent"||l.priority==="high")&&(t+=5,s.push("High priority work")),e.averageEfficiency>.85&&e.qualityScore>.9?(t+=10,s.push("Excellent performer")):(e.averageEfficiency>.75||e.qualityScore>.85)&&(t+=5,s.push("Good performer")),(l.estimatedTime||l.standardTime||30)<30&&(t+=5,s.push("Quick work")),{match:Math.min(t,100),reasons:s.slice(0,3)}}},V={TIME_MULTIPLIER:1.9,calculateTimeFromRate:l=>parseFloat((l*V.TIME_MULTIPLIER).toFixed(1)),calculateRateFromTime:l=>parseFloat((l/V.TIME_MULTIPLIER).toFixed(2)),calculateStandardTime:(l,e,t)=>{const s=1+(e-5)*.1,r={manual:1.3,overlock:1,flatlock:1.1,buttonhole:1.2,cutting:.8,pressing:.9}[t]||1;return l*s*r}},b={paymentLogic:C,workAssignmentLogic:Y,qualityLogic:ne,metricsLogic:ae,recommendationEngine:Te,operationRateService:V};class Pe{static async createOperator(e){try{const t=E.validateOperatorCreation(e);if(!t.isValid)return{success:!1,error:t.errors.join(", "),code:"VALIDATION_FAILED"};const s={...e,createdAt:g(),updatedAt:g(),active:!0,realtimeStatus:{status:"idle",currentWorkItems:0,lastUpdated:g()}},i=await U(P(m,f.OPERATORS),s);return await U(P(m,f.OPERATOR_WALLETS),{operatorId:i.id,availableAmount:0,heldAmount:0,totalEarned:0,heldBundles:[],canWithdraw:!0,lastUpdated:g(),createdAt:g()}),await re(L(A,`${W.OPERATOR_STATUS}/${i.id}`),{status:"idle",currentWorkItems:0,lastUpdated:H(),currentLocation:e.defaultStation||"unassigned",machineStatus:"ready"}),{success:!0,data:{id:i.id,...s},metadata:{warnings:t.warnings,validationPassed:!0}}}catch(t){return console.error("Error creating operator:",t),{success:!1,error:t instanceof Error?t.message:"Failed to create operator",code:"CREATION_FAILED"}}}static async getOperatorPerformance(e){try{const t=await $(w(m,f.OPERATORS,e));if(!t.exists())return{success:!1,error:"Operator not found",code:"NOT_FOUND"};const s={id:t.id,...t.data()},i=E.analyzePerformance(s);return{success:!0,data:{operator:s,performance:i,timestamp:new Date().toISOString()}}}catch(t){return console.error("Error getting operator performance:",t),{success:!1,error:t instanceof Error?t.message:"Failed to get performance",code:"PERFORMANCE_FETCH_FAILED"}}}static async updateOperatorStatus(e,t,s){try{const i=te(m),r=w(m,f.OPERATORS,e);if(i.update(r,{...t,updatedAt:g(),updatedBy:s}),t.currentStatus){const n=L(A,`${W.OPERATOR_STATUS}/${e}`);await fe(n,{status:t.currentStatus,lastUpdated:H()})}return await i.commit(),{success:!0,data:{operatorId:e,updates:t}}}catch(i){return console.error("Error updating operator:",i),{success:!1,error:i instanceof Error?i.message:"Failed to update operator",code:"UPDATE_FAILED"}}}}class _e{static async createWorkAssignment(e){try{const t=ie(P(m,f.OPERATORS),Q("active","==",!0),Q("currentStatus","==","idle")),r=(await me(t)).docs.map(o=>({id:o.id,...o.data()})).map(o=>({operator:o,recommendation:b.recommendationEngine.generateRecommendations(e,o),matchScore:b.workAssignmentLogic.calculateMatchScore(e,o)}));r.sort((o,c)=>c.matchScore.totalScore-o.matchScore.totalScore);const n={...e,status:"available",priority:b.workAssignmentLogic.calculatePriorityScore(e),aiRecommendations:r.slice(0,5),createdAt:g(),updatedAt:g()},a=await U(P(m,f.WORK_ITEMS),n);return await re(L(A,`${W.AVAILABLE_WORK}/${a.id}`),{...n,createdAt:H()}),{success:!0,data:{id:a.id,...n,topRecommendations:r.slice(0,3)}}}catch(t){return console.error("Error creating work assignment:",t),{success:!1,error:t instanceof Error?t.message:"Failed to create work assignment",code:"ASSIGNMENT_CREATION_FAILED"}}}static async processSelfAssignment(e,t,s){try{return await se(m,async i=>{const r=w(m,f.WORK_ITEMS,e),n=w(m,f.OPERATORS,t),[a,o]=await Promise.all([i.get(r),i.get(n)]);if(!a.exists()||!o.exists())throw new Error("Work item or operator not found");const c=a.data(),u=o.data();if(c?.status!=="available")throw new Error("Work item is no longer available");const d=E.validateWorkAssignment(u,{machineType:c?.machineType,estimatedDuration:c?.estimatedDuration||30,skillRequired:c?.requiredSkillLevel||"beginner",priority:c?.priority||"normal"});if(!d.canAssign)throw new Error(d.reason||"Cannot assign work");i.update(r,{status:"assigned",operatorId:t,assignedAt:g(),assignmentType:"self_assigned",assignmentReason:s,assignmentValidation:d});const p=u.realtimeStatus?.currentWorkItems||0;i.update(n,{currentStatus:"working","realtimeStatus.currentWorkItems":p+1,"realtimeStatus.lastUpdated":g()});const h={workItemId:e,operatorId:t,assignedAt:g(),assignmentType:"self_assigned",status:"active",validation:d,reason:s},v=w(P(m,f.WORK_ASSIGNMENTS));return i.set(v,h),{success:!0,data:{assignmentId:v.id,workItemId:e,operatorId:t,validation:d}}})}catch(i){return console.error("Error processing self-assignment:",i),{success:!1,error:i instanceof Error?i.message:"Assignment failed",code:"SELF_ASSIGNMENT_FAILED"}}}}class De{static async processDamageReport(e){try{return await se(m,async t=>{const s=w(m,f.WORK_ITEMS,e.workItemId),i=w(m,f.OPERATORS,e.operatorId),[r,n]=await Promise.all([t.get(s),t.get(i)]);if(!r.exists()||!n.exists())throw new Error("Work item or operator not found");const a=r.data(),o=n.data(),c=b.paymentLogic.calculateDamageAwarePayment({rate:a?.ratePerPiece||0,totalPieces:a?.totalPieces||0},{piecesCompleted:a?.completedPieces||0,efficiency:o.averageEfficiency,qualityScore:o.qualityScore},[e]),u={...e,paymentImpact:c,status:"reported",reportedAt:g(),resolved:!1},d=w(P(m,f.DAMAGE_REPORTS));if(t.set(d,u),e.operatorFault&&c.penalties>0){const h=ie(P(m,f.OPERATOR_WALLETS),Q("operatorId","==",e.operatorId),pe(1));t.update(i,{"paymentStatus.held":!0,"paymentStatus.heldAmount":c.penalties,"paymentStatus.reason":"damage_reported",updatedAt:g()})}const p=b.qualityLogic.calculateQualityMetrics(a?.completedPieces||0,[e]);return t.update(s,{qualityScore:p.qualityScore,defectRate:p.defectRate,qualityMetrics:p,lastDamageReport:d.id,updatedAt:g()}),{success:!0,data:{damageReportId:d.id,paymentImpact:c,qualityMetrics:p,actionTaken:e.operatorFault?"payment_held":"no_penalty"}}})}catch(t){return console.error("Error processing damage report:",t),{success:!1,error:t instanceof Error?t.message:"Failed to process damage report",code:"DAMAGE_PROCESSING_FAILED"}}}}class Le{static async processAssignmentApproval(e,t,s,i){try{const r=await $(w(m,f.WORK_ASSIGNMENTS,e));if(!r.exists())return{success:!1,error:"Assignment request not found",code:"NOT_FOUND"};const n=r.data(),a=await $(w(m,f.SUPERVISORS,t));if(!a.exists())return{success:!1,error:"Supervisor not found",code:"UNAUTHORIZED"};const o=a.data(),c={status:s==="approve"?"approved":"rejected",processedBy:t,processedAt:g(),processingNotes:i,finalDecision:s};if(await ue(w(m,f.WORK_ASSIGNMENTS,e),c),s==="approve"){const u=te(m),d=w(m,f.WORK_ITEMS,n.workItemId);u.update(d,{status:"assigned",supervisorApproved:!0,approvedBy:t,approvedAt:g()});const p=w(m,f.OPERATORS,n.operatorId);u.update(p,{currentStatus:"working","realtimeStatus.currentWorkItems":de(1),"realtimeStatus.lastUpdated":g()}),await u.commit()}return{success:!0,data:{requestId:e,decision:s,processedBy:t,notes:i}}}catch(r){return console.error("Error processing assignment approval:",r),{success:!1,error:r instanceof Error?r.message:"Failed to process approval",code:"APPROVAL_PROCESSING_FAILED"}}}}class Ne{static listeners=new Map;static subscribeToOperatorStatus(e,t){const s=L(A,`${W.OPERATOR_STATUS}/${e}`),i=j(s,n=>{const a=n.val();t(a)}),r=`operator_${e}`;return this.listeners.set(r,i),()=>{i(),this.listeners.delete(r)}}static subscribeToAvailableWork(e){const t=L(A,W.AVAILABLE_WORK),s=j(t,r=>{const n=r.val(),a=n?Object.keys(n).map(o=>({id:o,...n[o]})):[];e(a)}),i="available_work";return this.listeners.set(i,s),()=>{s(),this.listeners.delete(i)}}static cleanup(){this.listeners.forEach(e=>{e()}),this.listeners.clear()}}const T={operator:Pe,workAssignment:_e,quality:De,supervisor:Le,realtime:Ne};class Ce{workflows=new Map;transitions=new Map;listeners=new Map;registerWorkflow(e){this.workflows.set(e.id,e)}registerTransitions(e,t){this.transitions.set(e,t)}async startWorkflow(e,t,s="normal"){try{const i=`${e}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,r={id:i,name:this.getWorkflowName(e),type:e,steps:this.getWorkflowSteps(e),currentStep:this.getWorkflowSteps(e)[0]?.id||"",status:"initialized",priority:s,createdAt:new Date,updatedAt:new Date,context:t,notifications:[]};return this.workflows.set(i,r),await this.moveToNextStep(i),{success:!0,workflowId:i}}catch(i){return console.error("Error starting workflow:",i),{success:!1,error:i instanceof Error?i.message:"Failed to start workflow"}}}async moveToNextStep(e){try{const t=this.workflows.get(e);if(!t)return{success:!1,error:"Workflow not found"};const s=t.steps.find(a=>a.id===t.currentStep);if(!s)return{success:!1,error:"Current step not found"};const i=s.dependencies.filter(a=>t.steps.find(c=>c.id===a)?.status!=="completed");if(i.length>0)return{success:!1,error:`Unmet dependencies: ${i.join(", ")}`};const r=await this.executeStep(t,s);if(!r.success)return s.status="failed",t.status="failed",this.addNotification(t,"error",r.error||"Step execution failed"),r;s.status="completed",s.completedAt=new Date,s.startedAt&&(s.actualDuration=s.completedAt.getTime()-s.startedAt.getTime());const n=this.findNextStep(t);return n?(t.currentStep=n.id,n.status="in_progress",n.startedAt=new Date,t.status="running"):(t.status="completed",t.completedAt=new Date,this.addNotification(t,"success","Workflow completed successfully")),t.updatedAt=new Date,this.notifyListeners(e,t),{success:!0}}catch(t){return console.error("Error moving to next step:",t),{success:!1,error:t instanceof Error?t.message:"Failed to move to next step"}}}async executeStep(e,t){try{switch(e.type){case"work_assignment":return await this.executeWorkAssignmentStep(e,t);case"quality_control":return await this.executeQualityControlStep(e,t);case"damage_resolution":return await this.executeDamageResolutionStep(e,t);case"payment_processing":return await this.executePaymentProcessingStep(e,t);case"operator_onboarding":return await this.executeOperatorOnboardingStep(e,t);default:return{success:!1,error:`Unknown workflow type: ${e.type}`}}}catch(s){return console.error(`Error executing step ${t.id}:`,s),{success:!1,error:s instanceof Error?s.message:"Step execution failed"}}}async executeWorkAssignmentStep(e,t){const{context:s}=e;switch(t.id){case"validate_assignment":const i=E.validateWorkAssignment(s.operator,{machineType:s.workItem.machineType,estimatedDuration:s.workItem.estimatedDuration,skillRequired:s.workItem.requiredSkillLevel,priority:s.workItem.priority});return i.canAssign?(e.context.assignmentValidation=i,{success:!0,data:i}):{success:!1,error:i.reason};case"check_supervisor_approval":const r=G.evaluateAssignmentRequest(s.assignmentRequest,s.supervisor,s.operator,s.workItem);return e.context.approvalDecision=r,r.shouldAutoApprove?{success:!0,data:{requiresApproval:!1}}:(this.addNotification(e,"info","Supervisor approval required"),t.assignedTo=s.supervisor.id,{success:!0,data:{requiresApproval:!0}});case"assign_work":const n=await T.workAssignment.processSelfAssignment(s.workItem.id,s.operator.id,s.assignmentRequest.reason);return n.success?(e.context.assignmentResult=n.data,this.addNotification(e,"success","Work assigned successfully"),{success:!0,data:n.data}):{success:!1,error:n.error};case"update_realtime_status":return await T.operator.updateOperatorStatus(s.operator.id,{currentStatus:"working",realtimeStatus:{status:"working",currentWorkItems:(s.operator.realtimeStatus?.currentWorkItems||0)+1,lastUpdated:new Date}});default:return{success:!1,error:`Unknown work assignment step: ${t.id}`}}}async executeQualityControlStep(e,t){const{context:s}=e;switch(t.id){case"assess_damage":const i=b.qualityLogic.calculateDefectImpact(s.damageReport.damageType,s.damageReport.affectedPieces,s.workItem.totalPieces);return e.context.damageImpact=i,{success:!0,data:i};case"determine_supervisor_action":const r=G.evaluateQualityIssue(s.supervisor,{bundleId:s.workItem.bundleId,operatorId:s.operator.id,defectType:s.damageReport.damageType,severity:s.damageReport.severity,affectedPieces:s.damageReport.affectedPieces,totalPieces:s.workItem.totalPieces,customerOrder:s.workItem.isCustomerOrder||!1});return e.context.qualityDecision=r,this.addNotification(e,"info",`Quality action: ${r.action}`),{success:!0,data:r};case"process_payment_impact":const n=b.paymentLogic.calculateDamageAwarePayment({rate:s.workItem.ratePerPiece,totalPieces:s.workItem.totalPieces},{piecesCompleted:s.workItem.completedPieces,efficiency:s.operator.averageEfficiency,qualityScore:s.operator.qualityScore},[s.damageReport]);return e.context.paymentCalculation=n,{success:!0,data:n};case"create_damage_report":return await T.quality.processDamageReport({workItemId:s.workItem.id,operatorId:s.operator.id,supervisorId:s.supervisor.id,damageType:s.damageReport.damageType,severity:s.damageReport.severity,affectedPieces:s.damageReport.affectedPieces,description:s.damageReport.description,operatorFault:s.damageReport.operatorFault});default:return{success:!1,error:`Unknown quality control step: ${t.id}`}}}async executeDamageResolutionStep(e,t){return{success:!0,data:`Damage resolution step ${t.id} executed`}}async executePaymentProcessingStep(e,t){return{success:!0,data:`Payment processing step ${t.id} executed`}}async executeOperatorOnboardingStep(e,t){const{context:s}=e;switch(t.id){case"validate_operator_data":const i=E.validateOperatorCreation(s.operatorData);return i.isValid?(e.context.validation=i,{success:!0,data:i}):{success:!1,error:i.errors.join(", ")};case"create_operator_account":const r=await T.operator.createOperator(s.operatorData);return r.success?(e.context.operatorId=r.data?.id,{success:!0,data:r.data}):{success:!1,error:r.error};case"assign_training_tasks":const n=E.recommendTraining({...s.operatorData,id:e.context.operatorId});return e.context.trainingTasks=n,this.addNotification(e,"info",`${n.length} training tasks assigned`),{success:!0,data:n};default:return{success:!1,error:`Unknown onboarding step: ${t.id}`}}}getWorkflowName(e){return{work_assignment:"Work Assignment Process",quality_control:"Quality Control Process",damage_resolution:"Damage Resolution Process",payment_processing:"Payment Processing",operator_onboarding:"Operator Onboarding"}[e]||e}getWorkflowSteps(e){return{work_assignment:[{id:"validate_assignment",name:"Validate Assignment",status:"pending",dependencies:[],estimatedDuration:1e3},{id:"check_supervisor_approval",name:"Check Supervisor Approval",status:"pending",dependencies:["validate_assignment"],estimatedDuration:5e3},{id:"assign_work",name:"Assign Work",status:"pending",dependencies:["check_supervisor_approval"],estimatedDuration:2e3},{id:"update_realtime_status",name:"Update Realtime Status",status:"pending",dependencies:["assign_work"],estimatedDuration:1e3}],quality_control:[{id:"assess_damage",name:"Assess Damage Impact",status:"pending",dependencies:[],estimatedDuration:2e3},{id:"determine_supervisor_action",name:"Determine Supervisor Action",status:"pending",dependencies:["assess_damage"],estimatedDuration:3e3},{id:"process_payment_impact",name:"Process Payment Impact",status:"pending",dependencies:["determine_supervisor_action"],estimatedDuration:2e3},{id:"create_damage_report",name:"Create Damage Report",status:"pending",dependencies:["process_payment_impact"],estimatedDuration:1e3}],operator_onboarding:[{id:"validate_operator_data",name:"Validate Operator Data",status:"pending",dependencies:[],estimatedDuration:1e3},{id:"create_operator_account",name:"Create Operator Account",status:"pending",dependencies:["validate_operator_data"],estimatedDuration:3e3},{id:"assign_training_tasks",name:"Assign Training Tasks",status:"pending",dependencies:["create_operator_account"],estimatedDuration:2e3}]}[e]||[]}findNextStep(e){return e.steps.find(t=>t.status==="pending"&&t.dependencies.every(s=>e.steps.find(r=>r.id===s)?.status==="completed"))||null}addNotification(e,t,s,i=[]){e.notifications.push({type:t,message:s,timestamp:new Date,recipients:i,read:!1})}notifyListeners(e,t){(this.listeners.get(e)||[]).forEach(i=>{try{i(t)}catch(r){console.error("Error in workflow listener:",r)}})}getWorkflow(e){return this.workflows.get(e)||null}getAllWorkflows(){return Array.from(this.workflows.values())}subscribeToWorkflow(e,t){return this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t),()=>{const s=this.listeners.get(e)||[],i=s.indexOf(t);i>-1&&s.splice(i,1)}}async cancelWorkflow(e){const t=this.workflows.get(e);return t?(t.status="cancelled",t.updatedAt=new Date,this.addNotification(t,"warning","Workflow cancelled"),this.notifyListeners(e,t),{success:!0}):{success:!1,error:"Workflow not found"}}getWorkflowsByStatus(e){return Array.from(this.workflows.values()).filter(t=>t.status===e)}getWorkflowsByType(e){return Array.from(this.workflows.values()).filter(t=>t.type===e)}cleanup(){this.workflows.clear(),this.transitions.clear(),this.listeners.clear()}}const I=new Ce;class qe{static async createOperator(e){try{const t=await I.startWorkflow("operator_onboarding",{operatorData:e},"normal");return t.success?await this.waitForWorkflowCompletion(t.workflowId):{success:!1,error:t.error,code:"WORKFLOW_START_FAILED"}}catch(t){return console.error("Error in createOperator:",t),{success:!1,error:t instanceof Error?t.message:"Failed to create operator",code:"OPERATOR_CREATION_FAILED"}}}static async getOperatorWithAnalysis(e){try{const t=await T.operator.getOperatorPerformance(e);if(!t.success)return t;const s=t.data?.operator,i=t.data?.performance,r=E.evaluatePromotion(s),n=E.recommendTraining(s);return{success:!0,data:{operator:s,performance:i,promotionEligibility:r,trainingRecommendations:n,analysisTimestamp:new Date().toISOString()}}}catch(t){return console.error("Error getting operator analysis:",t),{success:!1,error:t instanceof Error?t.message:"Failed to get operator analysis",code:"OPERATOR_ANALYSIS_FAILED"}}}static async updateOperator(e,t,s){try{if(t.skillLevel||t.machineTypes||t.maxConcurrentWork){const r={id:e,...t},n=E.validateOperatorCreation(r);if(!n.isValid)return{success:!1,error:n.errors.join(", "),code:"VALIDATION_FAILED",metadata:{warnings:n.warnings}}}return await T.operator.updateOperatorStatus(e,t,s)}catch(i){return console.error("Error updating operator:",i),{success:!1,error:i instanceof Error?i.message:"Failed to update operator",code:"OPERATOR_UPDATE_FAILED"}}}static async processSelfAssignment(e,t,s){try{const i={id:e,machineType:"overlock",priority:"normal"},r={id:t,skillLevel:"intermediate"},n={id:"supervisor_1",supervisorLevel:"senior"},a=await I.startWorkflow("work_assignment",{workItem:i,operator:r,supervisor:n,assignmentRequest:{workItemId:e,operatorId:t,reason:s,requestedAt:new Date}},"normal");return a.success?{success:!0,data:{message:"Assignment workflow started",workflowId:a.workflowId},workflowId:a.workflowId}:{success:!1,error:a.error,code:"WORKFLOW_START_FAILED"}}catch(i){return console.error("Error processing self-assignment:",i),{success:!1,error:i instanceof Error?i.message:"Failed to process assignment",code:"ASSIGNMENT_PROCESSING_FAILED"}}}static async getWorkRecommendations(e){try{const t={id:e,machineTypes:["overlock","flatlock"],skillLevel:"advanced",averageEfficiency:.89,qualityScore:.94,currentAssignments:[]},s=[{id:"work_1",bundleNumber:"BDL-001",operation:"Side Seam",machineType:"overlock",requiredSkillLevel:"intermediate",estimatedDuration:45,priority:"high",complexity:6},{id:"work_2",bundleNumber:"BDL-002",operation:"Hem",machineType:"flatlock",requiredSkillLevel:"advanced",estimatedDuration:30,priority:"normal",complexity:7}],i=s.map(r=>{const n=b.recommendationEngine.generateRecommendations(r,t),a=b.workAssignmentLogic.calculateMatchScore(r,t);return{workItem:r,recommendation:n,matchScore:a,aiScore:n.match,reasons:n.reasons}});return i.sort((r,n)=>n.aiScore-r.aiScore),{success:!0,data:{operatorId:e,recommendations:i.slice(0,10),totalAvailable:s.length,generatedAt:new Date().toISOString()}}}catch(t){return console.error("Error getting work recommendations:",t),{success:!1,error:t instanceof Error?t.message:"Failed to get recommendations",code:"RECOMMENDATIONS_FAILED"}}}static async processDamageReport(e){try{const t={id:e.workItemId,bundleId:"bundle_1",totalPieces:100,completedPieces:80,ratePerPiece:10,isCustomerOrder:!0},s={id:e.operatorId,averageEfficiency:.85,qualityScore:.92},i={id:e.supervisorId,supervisorLevel:"senior"},r=await I.startWorkflow("quality_control",{damageReport:e,workItem:t,operator:s,supervisor:i},"high");return r.success?{success:!0,data:{message:"Quality control workflow started",workflowId:r.workflowId},workflowId:r.workflowId}:{success:!1,error:r.error,code:"WORKFLOW_START_FAILED"}}catch(t){return console.error("Error processing damage report:",t),{success:!1,error:t instanceof Error?t.message:"Failed to process damage report",code:"DAMAGE_PROCESSING_FAILED"}}}static async calculateOperatorPayment(e,t){try{const s=[];let i=0,r=0,n=0;for(const o of t){const c=o.damageReports||[],u=b.paymentLogic.calculateDamageAwarePayment({rate:o.ratePerPiece,totalPieces:o.totalPieces},{piecesCompleted:o.completedPieces,efficiency:o.efficiency,qualityScore:o.qualityScore},c);s.push({workItemId:o.workItemId,bundleNumber:o.bundleNumber,calculation:u}),i+=u.basePayment,r+=u.bonuses,n+=u.penalties}const a=i+r-n;return{success:!0,data:{operatorId:e,period:{startDate:new Date(Date.now()-10080*60*1e3),endDate:new Date},summary:{totalBasePayment:i,totalBonuses:r,totalPenalties:n,finalPayment:a,workItemsCompleted:t.length},calculations:s,generatedAt:new Date().toISOString()}}}catch(s){return console.error("Error calculating payment:",s),{success:!1,error:s instanceof Error?s.message:"Failed to calculate payment",code:"PAYMENT_CALCULATION_FAILED"}}}static async processAssignmentApproval(e,t,s,i){try{return await T.supervisor.processAssignmentApproval(e,t,s,i)}catch(r){return console.error("Error processing assignment approval:",r),{success:!1,error:r instanceof Error?r.message:"Failed to process approval",code:"APPROVAL_PROCESSING_FAILED"}}}static async getSupervisorDashboard(e){try{const t={id:e,supervisorLevel:"senior",teamMembers:["op1","op2","op3"],responsibleLines:["line1","line2"]},s=[{id:"op1",averageEfficiency:.85,qualityScore:.9},{id:"op2",averageEfficiency:.78,qualityScore:.88},{id:"op3",averageEfficiency:.92,qualityScore:.95}],i=G.analyzeTeamProductivity(t,s,{completedWork:[],qualityIncidents:[],onTimeDeliveries:45,totalDeliveries:50});return{success:!0,data:{supervisor:t,teamProductivity:i,pendingApprovals:[],teamSize:s.length,dashboardGeneratedAt:new Date().toISOString()}}}catch(t){return console.error("Error getting supervisor dashboard:",t),{success:!1,error:t instanceof Error?t.message:"Failed to get dashboard",code:"DASHBOARD_FETCH_FAILED"}}}static async analyzeCompanyPerformance(){try{const e={totalOperators:50,activeOperators:45,averageEfficiency:.82,qualityScore:.88,onTimeDelivery:.91,customerSatisfactionScore:4.2},t={revenue:25e5,costs:18e5,profitMargin:.28,budgetUtilization:.85},s={marketShare:.15,competitorAnalysis:.72,growthRate:.08,customerRetentionRate:.89},i={efficiencyTrend:"up",qualityTrend:"stable",profitabilityTrend:"up"};return{success:!0,data:{performanceAnalysis:Ie.analyzeCompanyPerformance(e,t,s,i),rawData:{operational:e,financial:t,market:s,trends:i},analysisDate:new Date().toISOString()}}}catch(e){return console.error("Error analyzing company performance:",e),{success:!1,error:e instanceof Error?e.message:"Failed to analyze performance",code:"PERFORMANCE_ANALYSIS_FAILED"}}}static async waitForWorkflowCompletion(e,t=3e4){return new Promise(s=>{const i=Date.now(),r=()=>{const n=I.getWorkflow(e);if(!n){s({success:!1,error:"Workflow not found",code:"WORKFLOW_NOT_FOUND"});return}if(n.status==="completed"){s({success:!0,data:n.context,workflowId:e});return}if(n.status==="failed"){s({success:!1,error:"Workflow failed",code:"WORKFLOW_FAILED",data:n.context});return}if(Date.now()-i>t){s({success:!1,error:"Workflow timeout",code:"WORKFLOW_TIMEOUT"});return}setTimeout(r,100)};r()})}static getWorkflowStatus(e){const t=I.getWorkflow(e);return t?{success:!0,data:t}:{success:!1,error:"Workflow not found",code:"WORKFLOW_NOT_FOUND"}}static subscribeToWorkflow(e,t){return I.subscribeToWorkflow(e,t)}static getActiveWorkflows(){return{success:!0,data:I.getWorkflowsByStatus("running")}}}const ee=qe;class D{static instance;connectionState={firestore:"disconnected",realtimedb:"disconnected",auth:"disconnected",lastCheck:new Date,isOnline:navigator.onLine};listeners=[];healthCheckInterval;reconnectTimeout;reconnectAttempts=0;maxReconnectAttempts=5;isEnablingNetwork=!1;isNetworkEnabled=!0;constructor(){this.initializeConnectionMonitoring()}static getInstance(){return D.instance||(D.instance=new D),D.instance}initializeConnectionMonitoring(){window.addEventListener("online",this.handleOnline.bind(this)),window.addEventListener("offline",this.handleOffline.bind(this)),this.startHealthCheck(),this.checkConnections()}handleOnline(){console.log("🌐 Network connection restored"),this.connectionState.isOnline=!0,this.attemptReconnection()}handleOffline(){console.log("📴 Network connection lost"),this.connectionState.isOnline=!1,this.updateConnectionState("firestore","disconnected"),this.updateConnectionState("realtimedb","disconnected"),this.updateConnectionState("auth","disconnected")}startHealthCheck(){this.healthCheckInterval=setInterval(()=>{this.checkConnections()},X.heartbeatInterval)}async checkConnections(){this.connectionState.lastCheck=new Date;try{!this.isEnablingNetwork&&!this.isNetworkEnabled&&(this.isEnablingNetwork=!0,await B(m),this.isNetworkEnabled=!0,this.isEnablingNetwork=!1),this.updateConnectionState("firestore","connected"),this.reconnectAttempts=0}catch(e){this.isEnablingNetwork=!1,console.error("Firestore connection check failed:",e),this.updateConnectionState("firestore","error"),this.handleConnectionError("firestore")}try{const e=L(A,".info/connected");j(e,t=>{t.val()===!0?(this.updateConnectionState("realtimedb","connected"),this.reconnectAttempts=0):this.updateConnectionState("realtimedb","disconnected")})}catch(e){console.error("Realtime Database connection check failed:",e),this.updateConnectionState("realtimedb","error"),this.handleConnectionError("realtimedb")}try{ge.currentUser!==void 0?this.updateConnectionState("auth","connected"):this.updateConnectionState("auth","disconnected")}catch(e){console.error("Auth connection check failed:",e),this.updateConnectionState("auth","error")}}updateConnectionState(e,t){this.connectionState[e]=t,this.notifyListeners()}handleConnectionError(e){this.reconnectAttempts<this.maxReconnectAttempts?this.scheduleReconnection():console.error(`⚠️ Max reconnection attempts reached for ${e}`)}scheduleReconnection(){this.reconnectTimeout&&clearTimeout(this.reconnectTimeout);const e=Math.min(X.retryDelay*Math.pow(2,this.reconnectAttempts),3e4);console.log(`🔄 Scheduling reconnection in ${e}ms (attempt ${this.reconnectAttempts+1})`),this.reconnectTimeout=setTimeout(()=>{this.attemptReconnection()},e)}async attemptReconnection(){if(!this.connectionState.isOnline){console.log("📴 Cannot reconnect: offline");return}this.reconnectAttempts++,console.log(`🔄 Attempting reconnection (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);try{!this.isEnablingNetwork&&!this.isNetworkEnabled&&(this.isEnablingNetwork=!0,await B(m),this.isNetworkEnabled=!0,this.isEnablingNetwork=!1),Z(A),await this.checkConnections(),console.log("✅ Reconnection successful")}catch(e){this.isEnablingNetwork=!1,console.error("❌ Reconnection failed:",e),this.handleConnectionError("reconnection")}}getConnectionState(){return{...this.connectionState}}isConnected(){return this.connectionState.firestore==="connected"&&this.connectionState.realtimedb==="connected"}onConnectionChange(e){return this.listeners.push(e),e(this.getConnectionState()),()=>{const t=this.listeners.indexOf(e);t>-1&&this.listeners.splice(t,1)}}notifyListeners(){this.listeners.forEach(e=>{try{e(this.getConnectionState())}catch(t){console.error("Error in connection state listener:",t)}})}async forceReconnect(){console.log("🔄 Force reconnect requested"),this.reconnectAttempts=0,await this.attemptReconnection()}async goOffline(){console.log("📴 Going offline manually");try{this.isNetworkEnabled&&(await he(m),this.isNetworkEnabled=!1),ye(A),this.updateConnectionState("firestore","disconnected"),this.updateConnectionState("realtimedb","disconnected")}catch(e){console.error("Error going offline:",e)}}async goOnline(){console.log("🌐 Going online manually");try{!this.isEnablingNetwork&&!this.isNetworkEnabled&&(this.isEnablingNetwork=!0,await B(m),this.isNetworkEnabled=!0,this.isEnablingNetwork=!1),Z(A),await this.checkConnections()}catch(e){this.isEnablingNetwork=!1,console.error("Error going online:",e)}}cleanup(){this.healthCheckInterval&&clearInterval(this.healthCheckInterval),this.reconnectTimeout&&clearTimeout(this.reconnectTimeout),window.removeEventListener("online",this.handleOnline.bind(this)),window.removeEventListener("offline",this.handleOffline.bind(this)),this.listeners=[]}async connectToEmulators(){}getHealthMetrics(){return{uptime:Date.now()-this.connectionState.lastCheck.getTime(),reconnectAttempts:this.reconnectAttempts,lastSuccessfulConnection:this.connectionState.lastCheck,isHealthy:this.isConnected()&&this.connectionState.isOnline}}}const N=D.getInstance();var We={};const q={breakpoints:{mobile:"320px",tablet:"768px",desktop:"1024px",widescreen:"1440px"},touch:{minTouchTarget:44,touchPadding:8,swipeThreshold:50,longPressDelay:500,doubleTapDelay:300,dragStartDelay:150,dragScrollThreshold:20,mobileSpacing:{xs:"4px",sm:"8px",md:"16px",lg:"24px",xl:"32px"}},performance:{lazyLoading:{rootMargin:"50px",threshold:.1,maxRetries:3},virtualScroll:{itemHeight:80,bufferSize:5,threshold:100},codeSplitting:{chunkSize:25e4,maxChunks:10,cacheGroups:{vendor:!0,common:!0,features:!0}},images:{lazyLoad:!0,webpSupport:!0,placeholder:"blur",sizes:{thumbnail:150,small:300,medium:600,large:1200},quality:{thumbnail:70,standard:85,high:95}},cache:{images:"7d",api:"5m",static:"1y",sw:"24h"}},i18n:{defaultLocale:"en",supportedLocales:["en","ne"],fallbackLocale:"en",nepali:{dateFormat:"ne-NP",numberFormat:"ne-NP",currency:"NPR",calendar:"nepali",direction:"ltr"},namespaces:["common","navigation","operators","work-assignment","production","quality","reports","settings"],loadPath:"/locales/{{lng}}/{{ns}}.json",interpolation:{escapeValue:!1}},notifications:{push:{vapidKey:We.REACT_APP_VAPID_KEY,serviceWorkerPath:"/sw.js",maxNotifications:10,defaultIcon:"/icons/notification-192x192.png",badge:"/icons/badge-72x72.png"},toast:{position:"top-right",duration:5e3,maxToasts:5,animation:"slide-down",closeButton:!0,pauseOnHover:!0},inApp:{maxVisible:3,grouping:!0,sound:!0,vibration:[200,100,200],priority:{critical:1,high:2,medium:3,low:4}},types:{system:{icon:"bell",color:"blue",sound:"notification.mp3"},assignment:{icon:"briefcase",color:"green",sound:"assignment.mp3"},quality:{icon:"shield-check",color:"orange",sound:"alert.mp3"},break:{icon:"coffee",color:"purple",sound:"gentle.mp3"},achievement:{icon:"trophy",color:"gold",sound:"success.mp3"}}},pwa:{manifest:{name:"TSA ERP - Work Management",shortName:"TSA ERP",description:"Complete work management system for TSA garment factory",startUrl:"/",display:"standalone",orientation:"portrait-primary",themeColor:"#2563eb",backgroundColor:"#ffffff",categories:["productivity","business","utilities"]},icons:[{src:"/icons/icon-72x72.png",sizes:"72x72",type:"image/png"},{src:"/icons/icon-96x96.png",sizes:"96x96",type:"image/png"},{src:"/icons/icon-128x128.png",sizes:"128x128",type:"image/png"},{src:"/icons/icon-144x144.png",sizes:"144x144",type:"image/png"},{src:"/icons/icon-152x152.png",sizes:"152x152",type:"image/png"},{src:"/icons/icon-192x192.png",sizes:"192x192",type:"image/png"},{src:"/icons/icon-384x384.png",sizes:"384x384",type:"image/png"},{src:"/icons/icon-512x512.png",sizes:"512x512",type:"image/png"}],offline:{cacheStrategy:"NetworkFirst",cacheName:"tsa-erp-v1",maxEntries:100,maxAgeSeconds:86400,precacheRoutes:["/","/operators","/work-assignments","/dashboard"],runtimeCaching:{api:"NetworkFirst",images:"CacheFirst",static:"StaleWhileRevalidate"}},updates:{checkInterval:36e5,showUpdatePrompt:!0,autoUpdate:!1,skipWaiting:!1}},accessibility:{keyboard:{enabled:!0,trapFocus:!0,skipLinks:!0,shortcuts:{search:["ctrl+k","cmd+k"],home:["ctrl+h","cmd+h"],assignments:["ctrl+a","cmd+a"],operators:["ctrl+o","cmd+o"],settings:["ctrl+,","cmd+,"],help:["?","f1"]}},screenReader:{announcements:!0,liveRegions:!0,skipToContent:!0,labelledBy:!0,describedBy:!0},colorBlind:{highContrast:!1,reducedMotion:!1,alternativeColors:!0,patterns:!0},textScaling:{minSize:12,maxSize:24,lineHeight:1.5,letterSpacing:.1}},animations:{respectReducedMotion:!0,durations:{fast:150,normal:300,slow:500,verySlow:800},easings:{easeOut:"cubic-bezier(0.25, 0.46, 0.45, 0.94)",easeIn:"cubic-bezier(0.55, 0.055, 0.675, 0.19)",easeInOut:"cubic-bezier(0.645, 0.045, 0.355, 1)",bounce:"cubic-bezier(0.68, -0.55, 0.265, 1.55)"},gestures:{swipe:{threshold:50,velocity:.3,duration:200},drag:{damping:.9,stiffness:300,mass:1}}},layout:{containers:{xs:"100%",sm:"540px",md:"720px",lg:"960px",xl:"1140px",xxl:"1320px"},grid:{columns:12,gutter:"24px",mobileGutter:"16px"},header:{height:"64px",mobileHeight:"56px",sticky:!0,shadow:!0},sidebar:{width:"280px",mobileWidth:"100%",collapsedWidth:"72px",breakpoint:"md"},content:{padding:"24px",mobilePadding:"16px",maxWidth:"1200px"}},theme:{colorModes:["light","dark","auto"],defaultMode:"light",colors:{primary:"#2563eb",secondary:"#64748b",success:"#10b981",warning:"#f59e0b",error:"#ef4444",info:"#3b82f6"},typography:{fontFamily:{sans:["Inter","system-ui","sans-serif"],mono:["JetBrains Mono","monospace"],nepali:["Noto Sans Devanagari","sans-serif"]},fontSize:{xs:"0.75rem",sm:"0.875rem",base:"1rem",lg:"1.125rem",xl:"1.25rem","2xl":"1.5rem","3xl":"1.875rem","4xl":"2.25rem"},fontWeight:{light:300,normal:400,medium:500,semibold:600,bold:700}}},search:{debounceDelay:300,minQueryLength:2,maxResults:50,highlightMatches:!0,scopes:[{id:"all",label:"All",icon:"search"},{id:"operators",label:"Operators",icon:"users"},{id:"work-items",label:"Work Items",icon:"briefcase"},{id:"bundles",label:"Bundles",icon:"package"},{id:"reports",label:"Reports",icon:"chart-bar"}],filters:{dateRange:!0,status:!0,priority:!0,tags:!0},recentSearches:{enabled:!0,maxItems:10,storageKey:"tsa-erp-recent-searches"}},loading:{skeletons:{enabled:!0,animation:"pulse",baseColor:"#f3f4f6",highlightColor:"#e5e7eb",borderRadius:"4px"},spinners:{size:{small:"16px",medium:"24px",large:"32px"},strokeWidth:2,color:"primary"},progress:{height:"4px",color:"primary",backgroundColor:"#e5e7eb",animation:!0}}};class Me{swRegistration=null;installPrompt=null;isOnline=navigator.onLine;offlineQueue=[];syncInProgress=!1;constructor(){this.initializeEventListeners(),this.loadOfflineQueue()}async initialize(){try{if("serviceWorker"in navigator){if(window.location.hostname==="localhost"||window.location.port==="3000"){console.log("Development mode: Skipping Service Worker registration to avoid cache issues");const t=await navigator.serviceWorker.getRegistrations();for(const s of t)console.log("Unregistering existing service worker:",s.scope),await s.unregister();if("caches"in window){const s=await caches.keys();for(const i of s)console.log("Clearing cache:",i),await caches.delete(i)}return}this.swRegistration=await navigator.serviceWorker.register("/sw.js",{scope:"/"}),console.log("Service Worker registered:",this.swRegistration),this.swRegistration.addEventListener("updatefound",()=>{const t=this.swRegistration?.installing;t&&t.addEventListener("statechange",()=>{t.state==="installed"&&navigator.serviceWorker.controller&&this.notifyAppUpdate()})})}"Notification"in window&&Notification.permission==="default"&&await Notification.requestPermission(),console.log("PWA Service initialized successfully")}catch(e){throw console.error("PWA Service initialization failed:",e),e}}initializeEventListeners(){window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),this.installPrompt=e,console.log("Install prompt available")}),window.addEventListener("online",()=>{this.isOnline=!0,console.log("App is online"),this.syncOfflineQueue()}),window.addEventListener("offline",()=>{this.isOnline=!1,console.log("App is offline"),this.showOfflineNotification()}),window.addEventListener("appinstalled",()=>{console.log("App installed successfully"),this.installPrompt=null}),document.addEventListener("visibilitychange",()=>{!document.hidden&&this.isOnline&&this.offlineQueue.length>0&&this.syncOfflineQueue()})}canInstall(){return this.installPrompt!==null}async showInstallPrompt(){if(!this.installPrompt)return console.warn("Install prompt not available"),null;try{await this.installPrompt.prompt();const e=await this.installPrompt.userChoice;return console.log("Install prompt result:",e),e.outcome==="accepted"&&(this.installPrompt=null),e}catch(e){return console.error("Install prompt failed:",e),null}}isInstalled(){return window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0||document.referrer.includes("android-app://")}async showNotification(e){if(!this.swRegistration)throw new Error("Service Worker not registered");if(Notification.permission!=="granted"&&await Notification.requestPermission()!=="granted")throw new Error("Notification permission denied");const t={icon:q.pwa.icons.find(s=>s.sizes==="192x192")?.src||"/icons/icon-192x192.png",badge:"/icons/badge-72x72.png",vibrate:[200,100,200],requireInteraction:!1,...e};await this.swRegistration.showNotification(e.title,t)}async subscribeToPush(){if(!this.swRegistration)throw new Error("Service Worker not registered");const e=q.notifications.push.vapidKey;if(!e)return console.warn("VAPID key not configured"),null;try{const t=await this.swRegistration.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.urlBase64ToUint8Array(e)});return console.log("Push subscription created:",t),await this.sendSubscriptionToServer(t),t}catch(t){throw console.error("Push subscription failed:",t),t}}async unsubscribeFromPush(){if(!this.swRegistration)throw new Error("Service Worker not registered");const e=await this.swRegistration.pushManager.getSubscription();e&&(await e.unsubscribe(),console.log("Unsubscribed from push notifications"))}addToOfflineQueue(e,t="GET",s,i={}){const r={id:Date.now().toString()+Math.random().toString(36).substr(2,9),url:e,method:t,headers:i,body:s,timestamp:Date.now(),retries:0};this.offlineQueue.push(r),this.saveOfflineQueue(),console.log("Added to offline queue:",r),this.isOnline&&this.syncOfflineQueue()}async syncOfflineQueue(){if(this.syncInProgress||this.offlineQueue.length===0||!this.isOnline)return;this.syncInProgress=!0,console.log("Syncing offline queue:",this.offlineQueue.length,"items");const e=3,t=[];for(const s of this.offlineQueue)try{const i=await fetch(s.url,{method:s.method,headers:{"Content-Type":"application/json",...s.headers},body:s.body});if(i.ok)t.push(s.id),console.log("Synced offline item:",s.id);else throw new Error(`HTTP ${i.status}: ${i.statusText}`)}catch(i){console.error("Failed to sync offline item:",s.id,i),s.retries++,s.retries>=e&&(t.push(s.id),console.warn("Max retries reached, removing item:",s.id))}this.offlineQueue=this.offlineQueue.filter(s=>!t.includes(s.id)),this.saveOfflineQueue(),this.syncInProgress=!1,t.length>0&&this.showNotification({title:"Data Synchronized",body:`${t.length} offline actions have been synchronized.`,tag:"sync-complete"})}async requestBackgroundSync(e){if(!this.swRegistration)throw new Error("Service Worker not registered");if("sync"in this.swRegistration)try{await this.swRegistration.sync.register(e),console.log("Background sync registered:",e)}catch(t){throw console.error("Background sync registration failed:",t),t}else console.warn("Background sync not supported")}getOfflineQueueStatus(){const e=this.offlineQueue.filter(s=>s.retries>=3).length,t=localStorage.getItem("pwa-last-sync");return{pending:this.offlineQueue.length-e,failed:e,lastSync:t?new Date(parseInt(t)):null}}isOnlineStatus(){return this.isOnline}getAppInfo(){return{isInstalled:this.isInstalled(),canInstall:this.canInstall(),version:"1.0.0",isOnline:this.isOnline,swStatus:this.swRegistration?.active?"active":"inactive"}}urlBase64ToUint8Array(e){const t="=".repeat((4-e.length%4)%4),s=(e+t).replace(/-/g,"+").replace(/_/g,"/"),i=window.atob(s),r=new Uint8Array(i.length);for(let n=0;n<i.length;++n)r[n]=i.charCodeAt(n);return r}async sendSubscriptionToServer(e){try{if(!(await fetch("/api/notifications/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).ok)throw new Error("Failed to send subscription to server");console.log("Subscription sent to server successfully")}catch(t){console.error("Failed to send subscription to server:",t)}}saveOfflineQueue(){try{localStorage.setItem("pwa-offline-queue",JSON.stringify(this.offlineQueue))}catch(e){console.error("Failed to save offline queue:",e)}}loadOfflineQueue(){try{const e=localStorage.getItem("pwa-offline-queue");e&&(this.offlineQueue=JSON.parse(e),console.log("Loaded offline queue:",this.offlineQueue.length,"items"))}catch(e){console.error("Failed to load offline queue:",e),this.offlineQueue=[]}}notifyAppUpdate(){this.showNotification({title:"App Update Available",body:"A new version of TSA ERP is available. Restart the app to update.",tag:"app-update",actions:[{action:"update",title:"Update Now"},{action:"later",title:"Later"}],requireInteraction:!0})}showOfflineNotification(){this.showNotification({title:"You're Offline",body:"TSA ERP is now working in offline mode. Your data will sync when you're back online.",tag:"offline-mode"})}async updateServiceWorker(){if(!this.swRegistration)throw new Error("Service Worker not registered");try{await this.swRegistration.update(),console.log("Service Worker updated"),this.swRegistration.waiting&&(this.swRegistration.waiting.postMessage({type:"SKIP_WAITING"}),window.location.reload())}catch(e){throw console.error("Service Worker update failed:",e),e}}destroy(){this.syncInProgress=!1,this.saveOfflineQueue(),console.log("PWA Service destroyed")}}const K=new Me;typeof window<"u"&&K.initialize().catch(console.error);class Fe{notifications=[];toastQueue=[];settings;subscribers=new Map;toastSubscribers=new Set;constructor(){this.settings=this.loadSettings(),this.initializeFirebaseListener(),this.registerServiceWorkerListeners()}async initialize(){try{if("Notification"in window&&Notification.permission==="default"){const e=await Notification.requestPermission();this.settings.pushEnabled=e==="granted",this.saveSettings()}await this.loadNotifications(),this.settings.pushEnabled&&await this.subscribeToPush(),console.log("Notification service initialized")}catch(e){throw console.error("Failed to initialize notification service:",e),e}}async sendNotification(e){const t={...e,id:this.generateNotificationId(),timestamp:new Date,read:!1};if(this.isNotificationEnabled(t)){if(this.isInQuietHours()){console.log("Notification suppressed due to quiet hours"),await this.saveNotificationToFirebase(t);return}await this.saveNotificationToFirebase(t),this.addNotification(t),this.settings.pushEnabled&&"serviceWorker"in navigator&&await this.sendPushNotification(t),!("serviceWorker"in navigator)&&"Notification"in window&&Notification.permission==="granted"&&await this.showBrowserNotification(t),this.settings.soundEnabled&&this.playNotificationSound(t.type),this.settings.vibrationEnabled&&"vibrate"in navigator&&this.vibrateDevice(t.priority),this.notifySubscribers(t)}}showToast(e){const t={...e,id:this.generateNotificationId(),duration:e.duration||q.notifications.toast.duration};this.toastQueue.push(t),this.notifyToastSubscribers(t),setTimeout(()=>{this.removeToast(t.id)},t.duration)}getNotifications(e){let t=[...this.notifications];return e&&(e.type&&(t=t.filter(s=>s.type===e.type)),e.read!==void 0&&(t=t.filter(s=>s.read===e.read)),e.priority&&(t=t.filter(s=>s.priority===e.priority)),e.limit&&(t=t.slice(0,e.limit))),t.sort((s,i)=>i.timestamp.getTime()-s.timestamp.getTime())}markAsRead(e){const t=this.notifications.find(s=>s.id===e);t&&!t.read&&(t.read=!0,this.saveNotifications())}markAllAsRead(e){let t=!1;this.notifications.forEach(s=>{!s.read&&(!e||s.type===e)&&(s.read=!0,t=!0)}),t&&this.saveNotifications()}deleteNotification(e){const t=this.notifications.findIndex(s=>s.id===e);t>-1&&(this.notifications.splice(t,1),this.saveNotifications())}clearNotifications(e){e?this.notifications=this.notifications.filter(t=>t.type!==e):this.notifications=[],this.saveNotifications()}getUnreadCount(e){return this.notifications.filter(t=>!t.read&&(!e||t.type===e)).length}subscribe(e,t){return this.subscribers.set(e,t),()=>{this.subscribers.delete(e)}}subscribeToToasts(e){return this.toastSubscribers.add(e),()=>{this.toastSubscribers.delete(e)}}updateSettings(e){this.settings={...this.settings,...e},this.saveSettings(),e.pushEnabled&&!this.settings.pushEnabled&&this.subscribeToPush()}getSettings(){return{...this.settings}}async testNotification(){await this.sendNotification({type:"system",title:"Test Notification",message:"This is a test notification to verify the system is working correctly.",priority:"medium"})}generateNotificationId(){return`notification_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}addNotification(e){this.notifications.unshift(e),this.notifications.length>100&&(this.notifications=this.notifications.slice(0,100)),this.saveNotifications()}isNotificationEnabled(e){return this.settings.inAppEnabled?this.settings.categories[e.type]!==!1:!1}isInQuietHours(){if(!this.settings.quietHours.enabled)return!1;const e=new Date,t=e.getHours()*60+e.getMinutes(),s=this.settings.quietHours.start.split(":"),i=this.settings.quietHours.end.split(":"),r=parseInt(s[0])*60+parseInt(s[1]),n=parseInt(i[0])*60+parseInt(i[1]);return r<=n?t>=r&&t<=n:t>=r||t<=n}async sendPushNotification(e){try{await K.showNotification({title:e.title,body:e.message,icon:this.getNotificationIcon(e.type),badge:"/icons/badge-72x72.png",tag:e.type,data:e.data,actions:e.actions?.map(t=>({action:t.id,title:t.title}))})}catch(t){console.error("Failed to send push notification:",t)}}async showBrowserNotification(e){try{const t=new Notification(e.title,{body:e.message,icon:this.getNotificationIcon(e.type),badge:"/icons/badge-72x72.png",tag:e.type,data:e.data,requireInteraction:e.priority==="critical"});t.onclick=()=>{e.actionUrl&&window.open(e.actionUrl,"_blank"),t.close()},e.priority!=="critical"&&setTimeout(()=>{t.close()},5e3)}catch(t){console.error("Failed to show browser notification:",t)}}getNotificationIcon(e){const t=q.notifications.types[e];return t?`/icons/${t.icon}.png`:"/icons/notification-192x192.png"}playNotificationSound(e){try{const s=q.notifications.types[e]?.sound||"notification.mp3",i=new Audio(`/sounds/${s}`);i.volume=.5,i.play().catch(console.warn)}catch(t){console.warn("Failed to play notification sound:",t)}}vibrateDevice(e){const t={low:[100],medium:[200,100,200],high:[300,100,300,100,300],critical:[500,200,500,200,500]},s=t[e]||t.medium;navigator.vibrate(s)}notifySubscribers(e){this.subscribers.forEach(t=>{try{t(e)}catch(s){console.error("Notification subscriber error:",s)}})}notifyToastSubscribers(e){this.toastSubscribers.forEach(t=>{try{t(e)}catch(s){console.error("Toast subscriber error:",s)}})}removeToast(e){const t=this.toastQueue.findIndex(s=>s.id===e);t>-1&&this.toastQueue.splice(t,1)}async subscribeToPush(){try{await K.subscribeToPush()}catch(e){console.error("Failed to subscribe to push notifications:",e)}}initializeFirebaseListener(){this.subscribeToFirebaseNotifications()}async saveNotificationToFirebase(e){try{console.log("Notification saved locally (Firebase disabled in development)")}catch(t){console.error("Failed to save notification to Firebase:",t)}}subscribeToFirebaseNotifications(){try{console.log("Firebase notification listener - using local mode for development")}catch(e){console.error("Failed to initialize Firebase notification listener:",e)}}registerServiceWorkerListeners(){"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("message",e=>{if(e.data&&e.data.type==="NOTIFICATION_CLICK"){const t=e.data.notification;this.handleNotificationClick(t)}})}handleNotificationClick(e){e.actionUrl&&window.open(e.actionUrl,"_blank");const t=this.notifications.find(s=>s.id===e.id);t&&this.markAsRead(t.id)}saveNotifications(){try{localStorage.setItem("tsa-erp-notifications",JSON.stringify(this.notifications.map(e=>({...e,timestamp:e.timestamp.toISOString()}))))}catch(e){console.error("Failed to save notifications:",e)}}async loadNotifications(){try{const e=localStorage.getItem("tsa-erp-notifications");if(e){const t=JSON.parse(e);this.notifications=t.map(s=>({...s,timestamp:new Date(s.timestamp)}))}}catch(e){console.error("Failed to load notifications:",e),this.notifications=[]}}saveSettings(){try{localStorage.setItem("tsa-erp-notification-settings",JSON.stringify(this.settings))}catch(e){console.error("Failed to save notification settings:",e)}}loadSettings(){try{const e=localStorage.getItem("tsa-erp-notification-settings");if(e)return{...this.getDefaultSettings(),...JSON.parse(e)}}catch(e){console.error("Failed to load notification settings:",e)}return this.getDefaultSettings()}getDefaultSettings(){return{pushEnabled:!1,emailEnabled:!0,inAppEnabled:!0,soundEnabled:!0,vibrationEnabled:!0,categories:{system:!0,assignment:!0,quality:!0,break:!0,achievement:!0,alert:!0},quietHours:{enabled:!1,start:"22:00",end:"08:00"}}}destroy(){this.subscribers.clear(),this.toastSubscribers.clear(),this.saveNotifications(),this.saveSettings(),console.log("Notification service destroyed")}}const Be=new Fe;typeof window<"u"&&Be.initialize().catch(console.error);const Ye={processAssignmentApproval:ee.processAssignmentApproval,getDashboard:ee.getSupervisorDashboard};N.getConnectionState,N.isConnected,N.forceReconnect,N.goOffline,N.goOnline;export{G as a,b,E as o,Ye as s,I as w};
