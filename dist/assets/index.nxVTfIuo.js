import{ab as y,ae as j,X as C,a0 as K,Y as b,a8 as oe,a1 as fe,af as ge,aa as ce,a3 as le,a7 as J,a5 as ye,a6 as ve,ag as Q,ah as we,Z as se}from"./firebase-vendor.m6WcKfT_.js";import{C as g,d as h,s as U,r as A,a as S,R as k,e as _,u as Se,o as z,f as re,h as be,i as ie,j as Ae,k as L,E as H,l as Ee}from"./index.B__xpDQO.js";import{M as G,S as O}from"./operator-service.ea3XhWLu.js";import{E as T,N as ke}from"./notification-service.CokO_XAL.js";import"./react-vendor.BcnQP8kQ.js";import"./damage-report-service.CoCQ_gjd.js";import"./operator-wallet-service.BuDOx5T4.js";class P{static validateOperatorCreation(e){const t=[],s=[];e.username.length<3&&t.push("Username must be at least 3 characters long"),/^TSA-\d{4}$/.test(e.employeeId)||t.push("Employee ID must follow format: TSA-XXXX (e.g., TSA-0001)"),e.machineTypes.includes(e.primaryMachine)||t.push("Primary machine must be included in machine types list");const i=G.find(c=>c.machineType===e.primaryMachine);if(i){const c=O.findIndex(d=>d.value===e.skillLevel),u=O.findIndex(d=>d.value===i.requiredSkillLevel);c<u&&t.push(`Operator skill level (${e.skillLevel}) is insufficient for primary machine ${i.displayName}`)}(Date.now()-new Date(e.hiredDate).getTime())/(1e3*60*60*24*30)<3&&e.skillLevel==="expert"&&s.push("Expert skill level assigned to recently hired operator (< 3 months)");const a=O.find(c=>c.value===e.skillLevel),o=a?.value==="beginner"?2:a?.value==="intermediate"?4:a?.value==="advanced"?6:8;return e.maxConcurrentWork>o&&s.push(`Max concurrent work (${e.maxConcurrentWork}) exceeds recommended for skill level (${o})`),e.email&&!e.email.endsWith("@tsa.com")&&!e.email.endsWith("@contractor.tsa.com")&&s.push("Email domain should be @tsa.com for employees or @contractor.tsa.com for contractors"),{isValid:t.length===0,errors:t,warnings:s}}static validateWorkAssignment(e,t){if(!(e.machineTypes.includes(t.machineType)||e.primaryMachine===t.machineType))return{canAssign:!1,reason:`Operator cannot work on ${t.machineType}`,machineIncompatible:!0};const r=O.findIndex(o=>o.value===e.skillLevel),i=O.findIndex(o=>o.value===t.skillRequired);return r<i?{canAssign:!1,reason:"Operator skill level insufficient for required work",skillMismatch:!0}:("realtimeStatus"in e&&e.realtimeStatus?.currentWorkItems||0)>=e.maxConcurrentWork?{canAssign:!1,reason:`Operator at maximum concurrent work capacity (${e.maxConcurrentWork})`,maxConcurrentExceeded:!0}:("realtimeStatus"in e?e.realtimeStatus?.status==="idle"||e.realtimeStatus?.status==="working":e.currentStatus==="idle"||e.currentStatus==="working")?{canAssign:!0}:{canAssign:!1,reason:`Operator not available (status: ${"realtimeStatus"in e?e.realtimeStatus?.status:e.currentStatus})`}}static analyzePerformance(e){const t=[];let s=0;const r=e.averageEfficiency;let i="stable";r<.7?(i="declining",t.push("Consider additional training or mentoring"),t.push("Review current work assignments for complexity")):r>.9&&(i="improving",t.push("Consider for advanced projects"),t.push("Potential candidate for team lead role"));const n=e.qualityScore;let a="stable";return n<.8?(a="declining",t.push("Quality control training needed"),t.push("Implement peer review process")):n>.95&&(a="improving",t.push("Consider for quality assurance role")),s=Math.round((r*.6+n*.4)*100),e.totalWorkingDays/22>12&&e.skillLevel==="intermediate"&&t.push("Consider promotion to advanced skill level"),e.completedBundles>100&&r>.85&&t.push("High performer - consider for complex assignments"),{efficiencyTrend:i,qualityTrend:a,productivityScore:s,recommendedActions:t}}static validateShiftAssignment(e,t,s){const r=[],i=[];e.shift!==t&&i.push(`Operator regular shift is ${e.shift}, requesting ${t}`),t==="night"&&e.totalWorkingDays/22<6&&r.push("Operators with less than 6 months experience cannot work night shifts");const n=s.getDay();return(n===0||n===6)&&e.skillLevel==="beginner"&&i.push("Beginner operators should avoid weekend shifts without supervision"),{isValid:r.length===0,errors:r,warnings:i}}static validateMachineAssignment(e,t,s){const r=[],i=[];e.machineTypes.includes(s)||r.push(`Operator not certified for machine type: ${s}`),e.primaryMachine===s?i.push("Assigning to primary machine - optimal performance expected"):i.push("Assigning to secondary machine - monitor performance closely");const n=G.find(a=>a.machineType===s);if(n){const a=O.findIndex(c=>c.value===e.skillLevel),o=O.findIndex(c=>c.value===n.requiredSkillLevel);a<o&&r.push(`Insufficient skill level for machine type: ${s}`)}return{isValid:r.length===0,errors:r,warnings:i}}static validateLeaveRequest(e,t,s,r){const i=[],n=[],a=Math.ceil((r.getTime()-s.getTime())/864e5),o={sick:15,annual:21,emergency:7,maternity:98};a>o[t]&&i.push(`${t} leave cannot exceed ${o[t]} days`);const c=Math.ceil((s.getTime()-Date.now())/(1e3*60*60*24));return t==="annual"&&c<7&&n.push("Annual leave should be requested at least 7 days in advance"),"realtimeStatus"in e&&e.realtimeStatus?.currentWorkItems>0&&n.push("Operator has pending work assignments - consider reassignment"),{isValid:i.length===0,errors:i,warnings:n}}static recommendTraining(e){const t=[];e.averageEfficiency<.7&&(t.push("Efficiency Improvement Workshop"),t.push("Time Management Training")),e.qualityScore<.8&&(t.push("Quality Control Certification"),t.push("Attention to Detail Training"));const s=e.totalWorkingDays/22;s>6&&e.skillLevel==="beginner"&&t.push("Intermediate Skills Certification"),s>18&&e.skillLevel==="intermediate"&&(t.push("Advanced Operations Training"),t.push("Leadership Skills Workshop"));const r=G.filter(i=>!e.machineTypes.includes(i.machineType));return r.length>0&&t.push(`Cross-training on ${r[0].displayName}`),t.push("Annual Safety Refresher Course"),t}static evaluatePromotion(e){const t=[],s=[],r=O.findIndex(d=>d.value===e.skillLevel),i=O[r+1];if(!i)return{eligible:!1,nextLevel:"Maximum level reached",requirements:[],blockers:["Already at highest skill level"]};const n=e.totalWorkingDays/22,o={intermediate:6,advanced:18,expert:36}[i.value];n<o&&s.push(`Need ${o-n} more months of experience`),e.averageEfficiency<.8&&s.push("Efficiency must be at least 80%"),e.qualityScore<.85&&s.push("Quality score must be at least 85%");const u={intermediate:50,advanced:200,expert:500}[i.value];return e.completedBundles<u&&s.push(`Need ${u-e.completedBundles} more completed bundles`),t.push(`Complete ${i.label} certification course`),t.push("Pass practical skill assessment"),t.push("Supervisor evaluation"),{eligible:s.length===0,nextLevel:i.label,requirements:t,blockers:s}}}const I={validateOperatorCreation:P.validateOperatorCreation,validateWorkAssignment:P.validateWorkAssignment,analyzePerformance:P.analyzePerformance,validateShiftAssignment:P.validateShiftAssignment,validateMachineAssignment:P.validateMachineAssignment,validateLeaveRequest:P.validateLeaveRequest,recommendTraining:P.recommendTraining,evaluatePromotion:P.evaluatePromotion};class Re extends T{constructor(e){super(g.OPERATORS,e)}validate(e){const t=[];return(!e.username||typeof e.username!="string")&&t.push("Username is required and must be a string"),(!e.name||typeof e.name!="string")&&t.push("Name is required and must be a string"),e.role!=="operator"&&t.push('Role must be "operator"'),(!e.skills||!Array.isArray(e.skills))&&t.push("Skills must be provided as an array"),e.efficiencyRating!==void 0&&(typeof e.efficiencyRating!="number"||e.efficiencyRating<0||e.efficiencyRating>100)&&t.push("Efficiency rating must be a number between 0 and 100"),e.qualityScore!==void 0&&(typeof e.qualityScore!="number"||e.qualityScore<0||e.qualityScore>100)&&t.push("Quality score must be a number between 0 and 100"),{valid:t.length===0,errors:t}}async getBySkill(e,t){return this.getWhere("skills","array-contains",e,t)}async getAvailableOperators(e){return this.getWhere("availabilityStatus","==","available",e)}async getByEfficiencyRange(e,t,s){const r=[{field:"efficiencyRating",operator:">=",value:e},{field:"efficiencyRating",operator:"<=",value:t}];return this.query({...s,where:r})}async updateAvailabilityStatus(e,t,s){return this.update(e,{availabilityStatus:t,lastActiveTime:new Date},s)}async updateStatistics(e,t,s){const r={};return t.piecesCompleted!==void 0&&(r.totalPiecesCompleted=t.piecesCompleted),t.earnings!==void 0&&(r.totalEarnings=t.earnings),t.efficiencyRating!==void 0&&(r.efficiencyRating=t.efficiencyRating),t.qualityScore!==void 0&&(r.qualityScore=t.qualityScore),this.update(e,r,s)}async getTopPerformers(e=10){return this.query({orderByField:"efficiencyRating",orderDirection:"desc",limit:e,where:[{field:"active",operator:"==",value:!0}]})}async searchOperators(e,t){const s=await this.query({...t,where:[{field:"name",operator:">=",value:e},{field:"name",operator:"<=",value:e+""}]}),r=await this.query({...t,where:[{field:"username",operator:">=",value:e},{field:"username",operator:"<=",value:e+""}]});if(s.success&&r.success){const n=[...s.data||[],...r.data||[]].filter((a,o,c)=>c.findIndex(u=>u.id===a.id)===o);return{success:!0,data:n,metadata:{totalCount:n.length}}}return s.success?s:r}async getOperatorDashboardData(e){try{const t=await this.getById(e);if(!t.success)return t;const s=new Date().toISOString().split("T")[0];return{success:!0,data:{operator:t.data,todayStats:{piecesCompleted:0,earnings:0,hoursWorked:0,efficiency:0},weeklyStats:{totalPieces:0,totalEarnings:0,averageEfficiency:0,workingDays:0},currentAssignments:[],recentCompletions:[]}}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to get dashboard data"}}}async updateMultipleStatuses(e,t){const s=e.map(r=>({id:r.operatorId,data:{availabilityStatus:r.status,lastActiveTime:new Date}}));return this.batchUpdate(s,t)}async getByDepartment(e,t){return this.getWhere("department","==",e,t)}async getByMachineType(e,t){return this.getWhere("machineType","==",e,t)}async getOperatorsOnShift(e,t){return this.getWhere("shiftPreference","==",e,t)}shouldAudit(){return!0}}class Oe extends T{constructor(e){super(g.SUPERVISORS,e)}validate(e){const t=[];return(!e.username||typeof e.username!="string")&&t.push("Username is required and must be a string"),(!e.name||typeof e.name!="string")&&t.push("Name is required and must be a string"),e.role!=="supervisor"&&t.push('Role must be "supervisor"'),(!e.supervisorLevel||!["junior","senior","lead"].includes(e.supervisorLevel))&&t.push("Supervisor level must be junior, senior, or lead"),(!e.responsibleLines||!Array.isArray(e.responsibleLines))&&t.push("Responsible lines must be provided as an array"),(!e.teamMembers||!Array.isArray(e.teamMembers))&&t.push("Team members must be provided as an array"),{valid:t.length===0,errors:t}}async getBySupervisorLevel(e,t){return this.getWhere("supervisorLevel","==",e,t)}async getByResponsibleLine(e,t){return this.getWhere("responsibleLines","array-contains",e,t)}async getSupervisorForOperator(e,t){return this.getWhere("teamMembers","array-contains",e,t)}async addOperatorToTeam(e,t,s){const r=await this.getById(e);if(!r.success||!r.data)return r;const i=[...r.data.teamMembers||[]];return i.includes(t)||i.push(t),this.update(e,{teamMembers:i,managedOperatorCount:i.length},s)}async removeOperatorFromTeam(e,t,s){const r=await this.getById(e);if(!r.success||!r.data)return r;const i=(r.data.teamMembers||[]).filter(n=>n!==t);return this.update(e,{teamMembers:i,managedOperatorCount:i.length},s)}async assignLineResponsibility(e,t,s){const r=await this.getById(e);if(!r.success||!r.data)return r;const i=[...r.data.responsibleLines||[]];return i.includes(t)||i.push(t),this.update(e,{responsibleLines:i},s)}async removeLineResponsibility(e,t,s){const r=await this.getById(e);if(!r.success||!r.data)return r;const i=(r.data.responsibleLines||[]).filter(n=>n!==t);return this.update(e,{responsibleLines:i},s)}async getSupervisorWorkload(e){try{const t=await this.getById(e);return!t.success||!t.data?t:{success:!0,data:{supervisor:t.data,totalOperators:t.data.teamMembers?.length||0,activeOperators:0,totalLines:t.data.responsibleLines?.length||0,pendingTasks:0,todayAssignments:0}}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to get workload data"}}}async getSupervisorsWithCapacity(e=20,t){return this.query({...t,where:[{field:"managedOperatorCount",operator:"<",value:e},{field:"active",operator:"==",value:!0}]})}async getSeniorSupervisors(e){return this.query({...e,where:[{field:"supervisorLevel",operator:"in",value:["senior","lead"]},{field:"active",operator:"==",value:!0}]})}async bulkReassignOperators(e,t,s,r){try{const i=[{type:"read",collection:this.collectionName,id:e},{type:"read",collection:this.collectionName,id:t}],n=await this.transaction(i,r);if(!n.success)return{success:!1,error:"Failed to read supervisors for reassignment"};const a=n.results[e],o=n.results[t];if(!a||!o)return{success:!1,error:"One or both supervisors not found"};const c=(a.teamMembers||[]).filter(f=>!s.includes(f)),u=[...o.teamMembers||[],...s],d=[{type:"update",collection:this.collectionName,id:e,data:{teamMembers:c,managedOperatorCount:c.length}},{type:"update",collection:this.collectionName,id:t,data:{teamMembers:u,managedOperatorCount:u.length}}];return(await this.transaction(d,r)).success?{success:!0,data:{fromSupervisor:{...a,teamMembers:c,managedOperatorCount:c.length},toSupervisor:{...o,teamMembers:u,managedOperatorCount:u.length},reassignedCount:s.length}}:{success:!1,error:"Failed to update supervisor assignments"}}catch(i){return{success:!1,error:i instanceof Error?i.message:"Bulk reassignment failed"}}}async getSupervisorDashboardData(e){try{const t=await this.getById(e);return!t.success||!t.data?t:{success:!0,data:{supervisor:t.data,teamStats:{totalOperators:t.data.teamMembers?.length||0,activeOperators:0,efficiency:0,qualityScore:0},lineStatus:{totalLines:t.data.responsibleLines?.length||0,activeLines:0,targetEfficiency:0,actualEfficiency:0},pendingApprovals:[],todayActivities:[]}}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to get dashboard data"}}}async searchSupervisors(e,t){const s=[{field:"name",operator:">=",value:e},{field:"name",operator:"<=",value:e+""},...t?[{field:"supervisorLevel",operator:"==",value:t}]:[]];return this.query({where:s})}shouldAudit(){return!0}}class Ie extends T{constructor(e){super(g.WORK_ITEMS,e)}validate(e){const t=[];return(!e.bundleNumber||typeof e.bundleNumber!="string")&&t.push("Bundle number is required and must be a string"),(!e.operation||typeof e.operation!="string")&&t.push("Operation is required and must be a string"),(!e.pieces||typeof e.pieces!="number"||e.pieces<=0)&&t.push("Pieces must be a positive number"),(!e.rate||typeof e.rate!="number"||e.rate<=0)&&t.push("Rate must be a positive number"),e.status&&!["pending","assigned","self_assigned","in_progress","completed","cancelled","on_hold"].includes(e.status)&&t.push("Invalid status value"),e.paymentStatus&&!["PENDING","HELD_FOR_DAMAGE","RELEASED","PAID"].includes(e.paymentStatus)&&t.push("Invalid payment status value"),{valid:t.length===0,errors:t}}async getByStatus(e,t){return this.getWhere("status","==",e,t)}async getAssignedToOperator(e,t){return this.getWhere("operatorId","==",e,{...t,where:[{field:"operatorId",operator:"==",value:e},{field:"status",operator:"in",value:["assigned","self_assigned","in_progress"]}]})}async getByBundle(e,t){return this.getWhere("bundleNumber","==",e,t)}async getPendingWorkItems(e){return this.getWhere("status","==","pending",e)}async getByOperation(e,t){return this.getWhere("operation","==",e,t)}async getByPaymentStatus(e,t){return this.getWhere("paymentStatus","==",e,t)}async getWorkItemsRequiringRework(e){return this.getWhere("reworkRequired","==",!0,e)}async selfAssignWorkItem(e,t,s){const r=await this.getById(e);return!r.success||!r.data?r:r.data.status!=="pending"?{success:!1,error:"Work item is not available for self-assignment",errorCode:"WORK_ITEM_NOT_AVAILABLE"}:this.update(e,{operatorId:t,status:"self_assigned",assignedAt:new Date},s)}async startWork(e,t,s){const r=await this.getById(e);return!r.success||!r.data?r:r.data.operatorId!==t?{success:!1,error:"Work item is not assigned to this operator",errorCode:"WORK_ITEM_NOT_ASSIGNED"}:["assigned","self_assigned"].includes(r.data.status)?this.update(e,{status:"in_progress",startedAt:new Date},s):{success:!1,error:"Work item cannot be started in current status",errorCode:"INVALID_STATUS_TRANSITION"}}async completeWorkItem(e,t,s){const r=await this.getById(e);if(!r.success||!r.data)return r;if(r.data.operatorId!==t.operatorId)return{success:!1,error:"Work item is not assigned to this operator",errorCode:"WORK_ITEM_NOT_ASSIGNED"};if(r.data.status!=="in_progress")return{success:!1,error:"Work item is not in progress",errorCode:"INVALID_STATUS_TRANSITION"};const i={status:"completed",completedAt:new Date,completedPieces:t.piecesCompleted,qualityScore:t.qualityScore,actualTimeMinutes:t.timeSpentMinutes,defects:t.defects,paymentStatus:"RELEASED",canWithdraw:!0},n=t.piecesCompleted*r.data.rate;return i.totalValue=n,this.update(e,i,s)}async holdPaymentForDamage(e,t,s,r){return this.update(e,{paymentStatus:"HELD_FOR_DAMAGE",canWithdraw:!1,reworkRequired:!0,reworkReason:`Payment held due to damage report: ${t}`},r)}async releaseHeldPayment(e,t){const s=await this.getById(e);return!s.success||!s.data?s:s.data.paymentStatus!=="HELD_FOR_DAMAGE"?{success:!1,error:"Payment is not currently held",errorCode:"PAYMENT_NOT_HELD"}:this.update(e,{paymentStatus:"RELEASED",canWithdraw:!0,reworkRequired:!1,reworkReason:void 0},t)}async getByDifficulty(e,t){return this.getWhere("difficulty","==",e,t)}async getWorkItemsByDateRange(e,t,s){return this.query({...s,where:[{field:"createdAt",operator:">=",value:e},{field:"createdAt",operator:"<=",value:t}]})}async getCompletedWorkItemsByDateRange(e,t,s){return this.query({...s,where:[{field:"completedAt",operator:">=",value:e},{field:"completedAt",operator:"<=",value:t},{field:"status",operator:"==",value:"completed"}]})}async getWorkItemStatistics(e){try{const t=[];e?.operatorId&&t.push({field:"operatorId",operator:"==",value:e.operatorId}),e?.bundleNumber&&t.push({field:"bundleNumber",operator:"==",value:e.bundleNumber}),e?.operation&&t.push({field:"operation",operator:"==",value:e.operation}),e?.dateFrom&&t.push({field:"createdAt",operator:">=",value:e.dateFrom}),e?.dateTo&&t.push({field:"createdAt",operator:"<=",value:e.dateTo});const s=await this.query({where:t,limit:1e4});if(!s.success||!s.data)return{success:!1,error:"Failed to fetch work items for statistics"};const r=s.data;return{success:!0,data:{totalItems:r.length,completedItems:r.filter(n=>n.status==="completed").length,pendingItems:r.filter(n=>n.status==="pending").length,inProgressItems:r.filter(n=>n.status==="in_progress").length,totalPieces:r.reduce((n,a)=>n+a.pieces,0),completedPieces:r.reduce((n,a)=>n+(a.completedPieces||0),0),totalEarnings:r.reduce((n,a)=>n+(a.totalValue||0),0),averageQuality:r.length>0?r.reduce((n,a)=>n+(a.qualityScore||0),0)/r.length:0,averageEfficiency:0}}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to calculate statistics"}}}async bulkUpdateStatus(e,t,s){const r=e.map(i=>({id:i,data:{status:t}}));return this.batchUpdate(r,s)}async getWorkItemsSummary(e){try{const t=e?[{field:"operatorId",operator:"==",value:e}]:[],s=await this.query({where:t,limit:1e4});if(!s.success||!s.data)return{success:!1,error:"Failed to fetch work items summary"};const r=s.data;return{success:!0,data:{pending:r.filter(n=>n.status==="pending").length,assigned:r.filter(n=>["assigned","self_assigned"].includes(n.status)).length,inProgress:r.filter(n=>n.status==="in_progress").length,completed:r.filter(n=>n.status==="completed").length,onHold:r.filter(n=>n.status==="on_hold").length}}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to get summary"}}}shouldAudit(){return!0}}class Te extends T{constructor(e){super(g.BUNDLES,e)}validate(e){const t=[];return(!e.bundleNumber||typeof e.bundleNumber!="string")&&t.push("Bundle number is required and must be a string"),(!e.articleNumber||typeof e.articleNumber!="string")&&t.push("Article number is required and must be a string"),(!e.customerPO||typeof e.customerPO!="string")&&t.push("Customer PO is required and must be a string"),(!e.orderQuantity||typeof e.orderQuantity!="number"||e.orderQuantity<=0)&&t.push("Order quantity must be a positive number"),e.deliveryDate||t.push("Delivery date is required"),(!e.sizes||!Array.isArray(e.sizes)||e.sizes.length===0)&&t.push("Sizes must be provided as a non-empty array"),e.priority&&!["low","normal","high","urgent"].includes(e.priority)&&t.push("Priority must be low, normal, high, or urgent"),e.status&&!["pending","in_progress","completed","on_hold","cancelled"].includes(e.status)&&t.push("Invalid status value"),{valid:t.length===0,errors:t}}async getByStatus(e,t){return this.getWhere("status","==",e,t)}async getByPriority(e,t){return this.getWhere("priority","==",e,t)}async getByCustomerPO(e,t){return this.getWhere("customerPO","==",e,t)}async getByArticleNumber(e,t){return this.getWhere("articleNumber","==",e,t)}async getByDeliveryDateRange(e,t,s){return this.query({...s,where:[{field:"deliveryDate",operator:">=",value:e},{field:"deliveryDate",operator:"<=",value:t}]})}async getUrgentBundles(e){const t=new Date;return t.setDate(t.getDate()+3),this.query({...e,where:[{field:"priority",operator:"in",value:["high","urgent"]}]})}async getOverdueBundles(e){const t=new Date;return this.query({...e,where:[{field:"deliveryDate",operator:"<",value:t},{field:"status",operator:"!=",value:"completed"}]})}async updateProgress(e,t,s){const r=await this.getById(e);if(!r.success||!r.data)return r;const i=r.data.totalPieces,n=Math.max(0,i-t),a={completedPieces:t,remainingPieces:n};return t===0&&r.data.status==="pending"||(t>0&&t<i?a.status="in_progress":t>=i&&(a.status="completed",a.actualCompletion=new Date)),this.update(e,a,s)}async setPriority(e,t,s){return this.update(e,{priority:t},s)}async holdBundle(e,t,s){return this.update(e,{status:"on_hold"},s)}async resumeBundle(e,t){const s=await this.getById(e);if(!s.success||!s.data)return s;const r=s.data.completedPieces>0?"in_progress":"pending";return this.update(e,{status:r},t)}async cancelBundle(e,t,s){return this.update(e,{status:"cancelled"},s)}async getBundleStatistics(e){try{const t=[];e?.status&&t.push({field:"status",operator:"==",value:e.status}),e?.priority&&t.push({field:"priority",operator:"==",value:e.priority}),e?.articleNumber&&t.push({field:"articleNumber",operator:"==",value:e.articleNumber}),e?.dateFrom&&t.push({field:"createdAt",operator:">=",value:e.dateFrom}),e?.dateTo&&t.push({field:"createdAt",operator:"<=",value:e.dateTo});const s=await this.query({where:t,limit:1e4});if(!s.success||!s.data)return{success:!1,error:"Failed to fetch bundles for statistics"};const r=s.data,i=new Date;return{success:!0,data:{totalBundles:r.length,completedBundles:r.filter(a=>a.status==="completed").length,inProgressBundles:r.filter(a=>a.status==="in_progress").length,pendingBundles:r.filter(a=>a.status==="pending").length,onHoldBundles:r.filter(a=>a.status==="on_hold").length,overdueBundles:r.filter(a=>new Date(a.deliveryDate)<i&&a.status!=="completed").length,totalPieces:r.reduce((a,o)=>a+o.totalPieces,0),completedPieces:r.reduce((a,o)=>a+o.completedPieces,0),averageCompletionRate:r.length>0?r.reduce((a,o)=>{const c=o.totalPieces>0?o.completedPieces/o.totalPieces*100:0;return a+c},0)/r.length:0,averageDelayDays:0}}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to calculate statistics"}}}async getBundleTimeline(e){try{return{success:!0,data:[{timestamp:new Date,event:"Bundle Created",description:"Bundle was created in the system",type:"info"}]}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to get timeline"}}}async searchBundles(e,t){const s=await this.query({...t,where:[{field:"bundleNumber",operator:">=",value:e},{field:"bundleNumber",operator:"<=",value:e+""}]}),r=await this.query({...t,where:[{field:"articleNumber",operator:">=",value:e},{field:"articleNumber",operator:"<=",value:e+""}]});if(s.success&&r.success){const n=[...s.data||[],...r.data||[]].filter((a,o,c)=>c.findIndex(u=>u.id===a.id)===o);return{success:!0,data:n,metadata:{totalCount:n.length}}}return s.success?s:r}async getBundleDashboardSummary(){try{const e=await this.getAll({limit:1e4});if(!e.success||!e.data)return{success:!1,error:"Failed to fetch bundles for summary"};const t=e.data,s=new Date,r=new Date(s.getFullYear(),s.getMonth(),s.getDate());return{success:!0,data:{totalBundles:t.length,activeBundles:t.filter(n=>["pending","in_progress"].includes(n.status)).length,completedToday:t.filter(n=>n.status==="completed"&&n.actualCompletion&&new Date(n.actualCompletion)>=r).length,overdue:t.filter(n=>new Date(n.deliveryDate)<s&&n.status!=="completed").length,highPriority:t.filter(n=>["high","urgent"].includes(n.priority)).length}}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Failed to get summary"}}}shouldAudit(){return!0}}new Re({cache:{enabled:!0,ttl:600*1e3,maxSize:500,strategy:"lru",invalidateOnUpdate:!0},retry:{enabled:!0,maxAttempts:3,backoffStrategy:"exponential",baseDelay:1e3,maxDelay:1e4},performance:{enabled:!0,trackLatency:!0,trackThroughput:!0,trackErrors:!0,sampleRate:1}});new Oe({cache:{enabled:!0,ttl:900*1e3,maxSize:200,strategy:"lru",invalidateOnUpdate:!0}});new Ie({cache:{enabled:!0,ttl:300*1e3,maxSize:1e3,strategy:"lru",invalidateOnUpdate:!0},retry:{enabled:!0,maxAttempts:5,backoffStrategy:"exponential",baseDelay:500,maxDelay:5e3}});new Te({cache:{enabled:!0,ttl:1800*1e3,maxSize:1e3,strategy:"lru",invalidateOnUpdate:!0}});new ke({cache:{enabled:!0,ttl:120*1e3,maxSize:500,strategy:"lru",invalidateOnUpdate:!1},offlineSync:!1});class Pe extends T{constructor(e){super("management",e)}validate(e){return{valid:!0,errors:[]}}}let _e=class extends T{constructor(e){super("workAssignments",e)}validate(e){return{valid:!0,errors:[]}}};class xe extends T{constructor(e){super("productionStats",e)}validate(e){return{valid:!0,errors:[]}}}class Ne extends T{constructor(e){super("qualityIssues",e)}validate(e){return{valid:!0,errors:[]}}}class De extends T{constructor(e){super("systemSettings",e)}validate(e){return{valid:!0,errors:[]}}}new Pe;new _e;new xe;new Ne;new De;class x{static validateSupervisorCreation(e){const t=[],s=[],r=e;(!r.username||r.username.length<3)&&t.push("Username must be at least 3 characters long"),(!e.supervisorLevel||!["junior","senior","lead"].includes(e.supervisorLevel))&&t.push("Supervisor level must be junior, senior, or lead");const i=e.experienceMonths||0,a={junior:12,senior:36,lead:60}[e.supervisorLevel];a&&i<a&&t.push(`${e.supervisorLevel} supervisor requires at least ${a} months of experience`);const c={junior:8,senior:15,lead:25}[e.supervisorLevel];e.teamMembers&&e.teamMembers.length>c&&s.push(`Team size (${e.teamMembers.length}) exceeds recommended maximum for ${e.supervisorLevel} supervisor (${c})`),(!e.responsibleLines||!Array.isArray(e.responsibleLines)||e.responsibleLines.length===0)&&t.push("Supervisor must be assigned to at least one production line");const d={junior:2,senior:4,lead:8}[e.supervisorLevel];return e.responsibleLines&&e.responsibleLines.length>d&&s.push(`Line responsibility (${e.responsibleLines.length}) exceeds recommended for ${e.supervisorLevel} supervisor (${d})`),{isValid:t.length===0,errors:t,warnings:s}}static evaluateWorkAssignment(e,t,s,r){const i=[],n=[];let a="low";if(!e.teamMembers.includes(t.id))return{canAssign:!1,reason:"Operator is not under your supervision",alternativeSuggestions:["Contact operator's direct supervisor"],requiredApprovals:[],riskLevel:"high"};if(r.currentWorkload>=t.maxConcurrentWork)return{canAssign:!1,reason:"Operator at maximum workload capacity",alternativeSuggestions:["Wait for current work completion","Reassign lower priority work","Find alternative operator"],requiredApprovals:[],riskLevel:"medium"};const o=["beginner","intermediate","advanced","expert"],c=o.indexOf(r.operatorSkillLevel),u=o.indexOf(s.requiredSkillLevel||"beginner");c<u&&(a="high",i.push("Consider providing additional supervision"),i.push("Pair with experienced operator for mentoring"),e.supervisorLevel==="junior"&&n.push("Senior supervisor approval required for skill mismatch assignments"));const d=(r.deadline.getTime()-Date.now())/(1e3*60*60);return d<24&&(a=a==="high"?"high":"medium",i.push("Monitor progress closely due to tight deadline"),d<4&&n.push("Management approval required for urgent assignments")),r.machineAvailability?(t.qualityScore<.8&&s.priority==="high"&&(a="high",i.push("Implement additional quality checks"),i.push("Consider assigning to higher quality operator"),e.supervisorLevel==="junior"&&n.push("Senior supervisor approval for high-priority work to low-quality operator")),{canAssign:!0,alternativeSuggestions:i,requiredApprovals:n,riskLevel:a}):{canAssign:!1,reason:"Required machine type not available",alternativeSuggestions:["Schedule when machine becomes available","Find operator with alternative machine skills"],requiredApprovals:[],riskLevel:"medium"}}static evaluateAssignmentRequest(e,t,s,r){const i=[],n=[];let a="junior";const o={minEfficiency:.85,minQuality:.9,maxWorkloadUtilization:.8},c=s.averageEfficiency>=o.minEfficiency&&s.qualityScore>=o.minQuality,u=["beginner","intermediate","advanced","expert"],d=u.indexOf(s.skillLevel),p=u.indexOf(r.requiredSkillLevel||"beginner"),f=Math.max(0,p-d);f>0&&(i.push(`Skill level gap: operator is ${s.skillLevel}, work requires ${r.requiredSkillLevel}`),a=f>1?"senior":"junior",n.push("Verify operator training records")),r.complexity>7&&(i.push("High complexity work item"),n.push("Ensure operator has handled similar complexity before"),a="senior");const w=(s.realtimeStatus?.currentWorkItems||0)/s.maxConcurrentWork;w>.9&&(i.push("Operator near maximum capacity"),n.push("Confirm operator can handle additional workload")),s.machineTypes.includes(r.machineType)||(i.push("Machine type not in operator certifications"),a="senior",n.push("Verify cross-training completion")),r.priority==="urgent"&&(i.push("Urgent priority work assignment"),n.push("Confirm deadline feasibility"),c||(a="senior"));const E=c&&f===0&&w<=o.maxWorkloadUtilization&&s.machineTypes.includes(r.machineType)&&r.complexity<=6&&r.priority!=="urgent"&&t.supervisorLevel!=="junior";let v="";return E?v="High-performing operator with perfect skill match and optimal workload":i.length>0?v=`Manual review required due to: ${i.join(", ")}`:v="Standard approval process required",{shouldAutoApprove:E,reason:v,requiredSupervisorLevel:a,additionalValidations:n,riskFactors:i}}static analyzeTeamProductivity(e,t,s){const r=[],i=t.reduce((u,d)=>u+d.averageEfficiency,0)/t.length,n=t.reduce((u,d)=>u+d.qualityScore,0)/t.length,a=s.completedWork.length>0?s.completedWork.filter(u=>u.status==="completed").length/s.completedWork.length:0,o=s.totalDeliveries>0?s.onTimeDeliveries/s.totalDeliveries:0,c=(i*.3+n*.3+a*.2+o*.2)*100;return i<.7&&(r.push("Implement efficiency improvement training"),r.push("Review work allocation strategies"),r.push("Consider process optimization workshops")),n<.85&&(r.push("Increase quality control measures"),r.push("Implement peer review processes"),r.push("Schedule quality training sessions")),o<.9&&(r.push("Improve deadline management"),r.push("Implement better work planning"),r.push("Review resource allocation")),a<.8&&(r.push("Investigate workflow bottlenecks"),r.push("Review task complexity assignments"),r.push("Consider team restructuring")),e.supervisorLevel==="junior"&&c<70&&(r.push("Seek senior supervisor mentoring"),r.push("Attend supervisory skill development training")),t.length>10&&e.supervisorLevel==="junior"&&r.push("Consider team size reduction or promotion to senior level"),{teamEfficiency:i,averageQuality:n,completionRate:a,onTimeDelivery:o,recommendedActions:r,teamHealthScore:Math.round(c)}}static evaluateSupervisorPerformance(e,t,s){const r=[],i=[],n=[],a=s.correctDecisions/s.decisionsMade;a>.9?r.push("Excellent decision-making skills"):a<.7&&i.push("Improve decision-making accuracy through training"),t.teamHealthScore>80?r.push("Strong team leadership and performance management"):t.teamHealthScore<60&&i.push("Focus on team productivity improvement"),s.trainingSessionsConducted>0?r.push("Active in team development and training"):i.push("Increase focus on team training and development"),s.teamSatisfactionScore>4?r.push("High team satisfaction and morale"):s.teamSatisfactionScore<3&&i.push("Improve team communication and relationship building");const o={decisionAccuracy:a*25,teamHealth:t.teamHealthScore/100*30,teamSatisfaction:s.teamSatisfactionScore/5*25,development:Math.min(s.trainingSessionsConducted*5,20)},c=Object.values(o).reduce((d,p)=>d+p,0);let u=!1;return e.supervisorLevel==="junior"&&c>=75?(u=!0,n.push("Complete senior supervisor certification"),n.push("Demonstrate team size management (10+ operators)"),n.push("Lead cross-training initiatives")):e.supervisorLevel==="senior"&&c>=85?(u=!0,n.push("Complete leadership development program"),n.push("Demonstrate multi-line management capability"),n.push("Mentor junior supervisors")):(c<60&&n.push("Improve overall performance score to 60+"),t.teamHealthScore<70&&n.push("Achieve team health score of 70+"),a<.8&&n.push("Improve decision accuracy to 80+")),{overallScore:Math.round(c),strengths:r,improvementAreas:i,promotionEligible:u,nextLevelRequirements:n}}static shouldEscalateDecision(e,t){const{type:s,impact:r,cost:i,affectedOperators:n,customerImpact:a}=t,c={junior:{maxCost:5e3,maxOperators:3,canHandleCustomerImpact:!1},senior:{maxCost:2e4,maxOperators:10,canHandleCustomerImpact:!0},lead:{maxCost:5e4,maxOperators:25,canHandleCustomerImpact:!0}}[e.supervisorLevel];return i>c.maxCost?{shouldEscalate:!0,reason:`Cost (₹${i}) exceeds supervisor authority limit (₹${c.maxCost})`,escalateTo:"management",timeframe:i>c.maxCost*2?"immediate":"within_hour"}:n>c.maxOperators?{shouldEscalate:!0,reason:`Number of affected operators (${n}) exceeds authority limit (${c.maxOperators})`,escalateTo:"senior_supervisor",timeframe:"within_hour"}:a&&!c.canHandleCustomerImpact?{shouldEscalate:!0,reason:"Customer impact decisions require higher authority",escalateTo:"management",timeframe:"immediate"}:s==="quality_issue"&&r==="high"?{shouldEscalate:!0,reason:"High impact quality issues require specialized expertise",escalateTo:"quality_head",timeframe:"immediate"}:s==="disciplinary"&&r==="high"?{shouldEscalate:!0,reason:"Serious disciplinary actions require management approval",escalateTo:"management",timeframe:"within_day"}:{shouldEscalate:!1,reason:"Within supervisor authority limits",escalateTo:"senior_supervisor",timeframe:"immediate"}}static evaluateQualityIssue(e,t){const{severity:s,affectedPieces:r,totalPieces:i,customerOrder:n,defectType:a}=t,o=r/i,c=[];return s==="critical"?(c.push("Immediate supervisor notification"),c.push("Document root cause analysis"),c.push("Implement corrective actions"),{action:"escalate",reasoning:"Critical quality issues require management decision",paymentAction:"hold_payment",additionalSteps:c}):s==="major"&&(o>.1||n)?a.includes("measurement")||a.includes("size")?(c.push("Quality team verification"),c.push("Check measurement tools calibration"),{action:"scrap",reasoning:"Size/measurement defects cannot be reworked effectively",paymentAction:"no_pay",additionalSteps:c}):(c.push("Assign to experienced operator for rework"),c.push("Additional quality inspection after rework"),{action:"rework",reasoning:"Major defects can be corrected through rework",paymentAction:"partial_pay",additionalSteps:c}):s==="minor"?o<.05?{action:"accept_with_discount",reasoning:"Minor defects with low impact rate",paymentAction:"partial_pay",additionalSteps:["Note quality concern in operator record"]}:(c.push("Provide quality feedback to operator"),c.push("Monitor next few bundles closely"),{action:"rework",reasoning:"High rate of minor defects needs correction",paymentAction:"partial_pay",additionalSteps:c}):{action:"escalate",reasoning:"Unable to determine appropriate action",paymentAction:"hold_payment",additionalSteps:["Require senior supervisor review"]}}}const Y={validateSupervisorCreation:x.validateSupervisorCreation,evaluateWorkAssignment:x.evaluateWorkAssignment,evaluateAssignmentRequest:x.evaluateAssignmentRequest,analyzeTeamProductivity:x.analyzeTeamProductivity,evaluateSupervisorPerformance:x.evaluateSupervisorPerformance,shouldEscalateDecision:x.shouldEscalateDecision,evaluateQualityIssue:x.evaluateQualityIssue};class V{static evaluateResourceAllocation(e,t,s,r){const i=[],n=[];let a=0;s.sort((u,d)=>{const p=this.calculateBundlePriority(u,r);return this.calculateBundlePriority(d,r)-p}),this.groupOperatorsBySkill(e);for(const u of t){const d=e.filter(v=>v.machineTypes.includes(u.machineType)&&v.currentStatus==="idle");if(d.length===0){i.push(`No available operators for ${u.name}`);continue}const p=Math.min(d.length,u.maxOperators,Math.ceil(u.targetEfficiency*u.maxOperators)),f=d.sort((v,M)=>M.averageEfficiency*M.qualityScore-v.averageEfficiency*v.qualityScore).slice(0,p),w=f.reduce((v,M)=>v+M.averageEfficiency,0)/f.length,E=p*w*u.hoursPerDay*u.averageRatePerHour;n.push({lineId:u.id,allocatedOperators:p,expectedEfficiency:w,predictedOutput:E}),a+=E*u.profitMarginPerPiece}const o=n.filter(u=>u.allocatedOperators<3);return o.length>0&&i.push(`${o.length} production lines under-utilized`),e.filter(u=>u.realtimeStatus?.currentWorkItems>u.maxConcurrentWork*.9).length>e.length*.3&&i.push("Over 30% of operators at maximum capacity"),{canAllocate:n.length>0,optimizedDistribution:n,riskFactors:i,expectedROI:a,timeToBreakeven:a>0?30:void 0}}static evaluateBudgetRequest(e,t,s){const r=[],i=[];let n="medium";if(e.amount>t.remaining)return{approved:!1,approvedAmount:0,conditions:[`Request exceeds available budget by ₹${e.amount-t.remaining}`],paybackPeriod:0,riskAssessment:"high",alternatives:["Request budget reallocation from other departments","Phase the investment over multiple quarters","Seek partial approval for critical components only"]};let a=.7,o=12;switch(e.category){case"equipment":a=.6,o=8,e.amount>1e5&&(r.push("Requires detailed equipment ROI analysis"),r.push("Must include maintenance cost projections"));break;case"training":a=.8,o=18,r.push("Must track skill improvement metrics"),r.push("Require training completion certificates");break;case"technology":a=.7,o=10,e.amount>2e5&&(r.push("Pilot implementation required first"),r.push("Vendor support agreement mandatory"));break;case"infrastructure":a=.5,o=24,r.push("Must improve overall facility efficiency");break;case"expansion":a=.8,o=15,r.push("Market demand analysis required"),r.push("Gradual rollout plan mandatory");break}const c=s.previousRequestsROI.length>0?s.previousRequestsROI.reduce((w,E)=>w+E,0)/s.previousRequestsROI.length:.5;c<.3?(n="high",a+=.2,r.push("Enhanced monitoring and reporting required due to low historical ROI")):c>.8&&(n="low",a-=.1),s.departmentEfficiency<.7&&(r.push("Department must improve efficiency metrics before additional investment"),a+=.15),s.pastBudgetUtilization<.8&&(r.push("Must improve budget utilization (currently "+Math.round(s.pastBudgetUtilization*100)+"%)"),n="medium");const u=e.amount/t.total;u>.3?(n="high",r.push("Large investment requires board approval"),r.push("Phased implementation plan required")):u<.05&&(n="low");const p=(c+s.departmentEfficiency+s.pastBudgetUtilization)/3>=a,f=p?e.amount:Math.min(e.amount*.5,t.remaining*.2);return!p&&f>0&&(i.push(`Partial approval of ₹${f} available`),i.push("Resubmit with improved justification and reduced scope")),{approved:p,approvedAmount:p?e.amount:f,conditions:r,paybackPeriod:o,riskAssessment:n,alternatives:p?void 0:i}}static analyzeCompanyPerformance(e,t,s,r){const i=[],n=[],a=Math.min(t.profitMargin*100,100),o=t.budgetUtilization*100,c=(a+o)/2,u=e.activeOperators/e.totalOperators*100,d=e.averageEfficiency*100,p=e.qualityScore*100,f=e.onTimeDelivery*100,w=(u+d+p+f)/4,E=s.marketShare*100,v=s.competitorAnalysis*100,M=e.customerSatisfactionScore/5*100,me=s.customerRetentionRate*100,$=(E+v+M+me)/4,pe=Math.min(s.growthRate*10,100),he=this.calculateTrendScore(r),te=Math.min(pe+he,100);return c<60&&(i.push("Implement cost reduction strategies"),i.push("Review pricing strategy and profit margins"),i.push("Optimize resource allocation"),n.push({metric:"Financial Health",current:Math.round(c),target:75,trend:r.profitabilityTrend})),w<70&&(i.push("Invest in operator training and development"),i.push("Upgrade equipment and technology"),i.push("Implement lean manufacturing principles"),n.push({metric:"Operational Efficiency",current:Math.round(w),target:85,trend:r.efficiencyTrend})),$<65&&(i.push("Enhance customer relationship management"),i.push("Improve product quality and delivery times"),i.push("Develop competitive market strategies"),n.push({metric:"Market Position",current:Math.round($),target:80,trend:"stable"})),te<50&&(i.push("Explore new market opportunities"),i.push("Invest in innovation and product development"),i.push("Consider strategic partnerships or acquisitions")),e.averageEfficiency<.75&&i.push("Conduct efficiency improvement workshops"),e.qualityScore<.85&&i.push("Implement comprehensive quality management system"),e.onTimeDelivery<.9&&i.push("Improve production planning and scheduling"),{financialHealth:Math.round(c),operationalEfficiency:Math.round(w),marketPosition:Math.round($),growthPotential:Math.round(te),recommendedActions:i,criticalMetrics:n}}static evaluateExpansionOpportunity(e,t,s){const r=[],i=[],n=[];if(e.investmentRequired>s.availableCapital*.8)return r.push("Investment exceeds 80% of available capital"),i.push("Seek external financing"),i.push("Phase the expansion over multiple periods"),{recommendation:"modify",reasoning:r,alternativeOptions:i,riskMitigation:["Secure financing before proceeding","Reduce initial investment scope"]};if(e.marketDemand<.6)return r.push("Market demand below acceptable threshold (60%)"),i.push("Conduct additional market research"),i.push("Consider different market segments"),{recommendation:"postpone",reasoning:r,alternativeOptions:i,riskMitigation:["Wait for market conditions to improve","Develop demand creation strategies"]};if(e.type==="capacity_expansion"&&t.utilizationRate<.85)return r.push("Current capacity not optimally utilized (less than 85%)"),i.push("Focus on improving current utilization first"),i.push("Optimize existing operations"),{recommendation:"postpone",reasoning:r,alternativeOptions:i,riskMitigation:["Achieve 85% utilization before expanding","Implement efficiency improvements"]};const o=(e.expectedRevenue-e.investmentRequired)/e.investmentRequired/(e.timeToMarket/12);return o<.15?(r.push("Expected ROI below minimum threshold (15% annually)"),i.push("Revise revenue projections"),i.push("Reduce investment costs"),{recommendation:"modify",reasoning:r,alternativeOptions:i,riskMitigation:["Improve cost-benefit analysis","Seek higher-margin opportunities"]}):(e.riskFactors.filter(u=>u.includes("high")||u.includes("critical")||u.includes("uncertain")).length>2&&(r.push("Multiple high-risk factors identified"),n.push("Develop comprehensive risk mitigation plan"),n.push("Create contingency strategies"),n.push("Consider insurance coverage")),s.debtToEquityRatio>.6&&(r.push("High debt-to-equity ratio may limit financing options"),n.push("Consider equity financing over debt"),n.push("Improve debt position before expansion")),r.push(`Strong market demand (${Math.round(e.marketDemand*100)}%)`),r.push(`Good expected ROI (${Math.round(o*100)}% annually)`),r.push("Financial position supports investment"),{recommendation:"approve",reasoning:r,alternativeOptions:[],riskMitigation:n})}static calculateBundlePriority(e,t){const s=t.find(n=>n.articleTypes.includes(e.articleNumber)),r=e.priority==="urgent"?1:e.priority==="high"?.8:e.priority==="normal"?.5:.2,i=s?s.urgency*s.profitMargin:.3;return r*.4+i*.6}static groupOperatorsBySkill(e){return e.reduce((t,s)=>{const r=s.skillLevel;return t[r]||(t[r]=[]),t[r].push(s),t},{})}static calculateTrendScore(e){let t=0;return Object.values(e).forEach(s=>{s==="up"?t+=10:s==="down"&&(t-=5)}),t}}const Ce={evaluateResourceAllocation:V.evaluateResourceAllocation,evaluateBudgetRequest:V.evaluateBudgetRequest,analyzeCompanyPerformance:V.analyzeCompanyPerformance,evaluateExpansionOpportunity:V.evaluateExpansionOpportunity},F={calculateBasePayment:(l,e)=>{const t=parseFloat(l.toString())||0,s=parseInt(e.toString())||0;return t*s},calculateWithEfficiencyBonus:(l,e,t=.9)=>{if(e>=t){let s=0;return e>=1.2?s=.5:e>=1?s=.2+(e-1)/.2*.3:e>=.95?s=.1+(e-.95)/.05*.1:s=(e-t)*2,l*(1+Math.min(s,.5))}return l},calculateQualityBonus:(l,e)=>e>=.98?l*.15:e>=.95?l*.1:e>=.9?l*.05:0,calculateDamageAwarePayment:(l,e,t=[])=>{const s=F.calculateBasePayment(l.rate,e.piecesCompleted),r=t.filter(u=>["stitching_defect","needle_damage","tension_issue","alignment_error","wrong_measurement","missing_operation"].includes(u.damageType)),i=t.filter(u=>["fabric_defect","material_issue","machine_malfunction","design_error"].includes(u.damageType)),n=[];let a=0;r.forEach(u=>{const d=F.calculateDamageDeduction(u,s,l.totalPieces);n.push(d),a+=d.deductionAmount});let o=0;const c={};if(e.efficiency){const u=F.calculateWithEfficiencyBonus(s,e.efficiency)-s;o+=u,c.efficiencyBonus=u}if(e.qualityScore){const u=F.calculateQualityBonus(s,e.qualityScore);o+=u,c.qualityBonus=u}return{basePayment:s,penalties:a,bonuses:o,finalPayment:Math.max(0,s+o-a),operatorFaultDamages:r.length,nonOperatorFaultDamages:i.length,details:{...c,damageDeductions:n}}},calculateDamageDeduction:(l,e,t)=>{if(l.operatorFault===!1)return{damageType:l.damageType,severity:l.severity,affectedPieces:l.affectedPieces,deductionAmount:0,deductionPercentage:0};let s=0;const i={broken_stitch:{minor:.05,major:.15,severe:.25},wrong_measurement:{minor:.1,major:.2,severe:.35},fabric_damage:{minor:.1,major:.25,severe:.4},missing_operation:{minor:.2,major:.3,severe:.5},stitching_defect:{minor:.08,major:.18,severe:.3},needle_damage:{minor:.12,major:.22,severe:.35},tension_issue:{minor:.06,major:.16,severe:.28},alignment_error:{minor:.1,major:.2,severe:.32}}[l.damageType];i?s=i[l.severity]||i.minor:s=l.severity==="major"?.15:l.severity==="severe"?.25:.05;const n=l.affectedPieces||1,a=n/t,o=Math.round(e*s*a);return{damageType:l.damageType,severity:l.severity,affectedPieces:n,deductionAmount:o,deductionPercentage:s}}},ee={calculatePriorityScore:l=>{const t={urgent:5,high:4,normal:3,low:2}[l.priority]||3,s=new Date(l.dueDate),r=new Date,i=Math.ceil((s.getTime()-r.getTime())/(1e3*60*60*24));let n=0;i<=1?n=10:i<=3?n=7:i<=7?n=5:i<=14?n=3:n=1;const a=l.complexity?Math.min(l.complexity,3):0,o=l.customerImportance?l.customerImportance:0;return t*2+n+a+o},calculateMatchScore:(l,e)=>{let t=0;const s=[];let r=0;e.machineTypes?.includes(l.machineType)?(r=50,s.push("Perfect machine compatibility")):ee.getRelatedMachineTypes(l.machineType).some(v=>e.machineTypes?.includes(v))?(r=25,s.push("Related machine experience")):(r=0,s.push("Machine type mismatch")),t+=r;let i=0;const n=["beginner","intermediate","advanced","expert"],a=n.indexOf(l.requiredSkillLevel||"beginner"),o=n.indexOf(e.skillLevel||"beginner");o>=a?(i=30,o===a?(i+=10,s.push("Perfect skill level match")):s.push("Skill level exceeds requirement")):(i=Math.max(0,20-(a-o)*10),s.push("Skill level below requirement")),t+=i;let c=20;const u=e.currentAssignments?.length||0,d=e.maxConcurrentWork||5,p=u/d;p>=1?(c=0,s.push("At maximum capacity")):p>=.8?(c=5,s.push("Near maximum capacity")):p>=.6?(c=15,s.push("Moderate workload")):(c=20,s.push("Light workload")),t+=c;let f=0;return e.averageEfficiency&&e.averageEfficiency>.8&&(f+=8,s.push("High efficiency operator")),e.qualityScore&&e.qualityScore>.9&&(f+=7,s.push("High quality operator")),t+=f,{totalScore:Math.min(t,100),machineCompatibilityScore:r,skillLevelScore:i,workloadScore:c,performanceScore:f,reasons:s.slice(0,3)}},getRelatedMachineTypes:l=>({overlock:["flatlock","serger"],flatlock:["overlock","coverstitch"],singleNeedle:["doubleNeedle","straightStitch"],buttonhole:["buttonAttach","bartack"],cutting:["rotaryCutter","bandKnife"],pressing:["steam","ironPress"]})[l]||[]},ue={calculateQualityScore:(l,e=[])=>{if(l===0)return 1;const t=e.reduce((r,i)=>r+(i.affectedPieces||1),0);return Math.max(0,l-t)/l},calculateQualityMetrics:(l,e=[])=>{const t=ue.calculateQualityScore(l,e),s=l>0?e.reduce((o,c)=>o+(c.affectedPieces||1),0)/l:0,r={minor:0,major:0,severe:0};e.forEach(o=>{const c=o.severity||"minor";r[c]=(r[c]||0)+(o.affectedPieces||1)});let i=0;const n={minor:.3,major:.7,severe:1};Object.entries(r).forEach(([o,c])=>{i+=c/l*(n[o]||.3)});const a=i>.1?"major":i>.05?"minor":"minimal";return{qualityScore:t,defectRate:s,impactScore:i,category:a,severityBreakdown:r}},calculateDefectImpact:(l,e,t)=>{const r={fabric_hole:.9,color_issue:.6,stitching_defect:1,size_issue:.95,alignment_error:.7,broken_stitch:.8,wrong_measurement:.9,missing_operation:1,needle_damage:.75,tension_issue:.65}[l]||.5,i=e/t,n=r*i;return{impactScore:n,category:n>.1?"major":n>.05?"minor":"minimal"}}},de={calculateEfficiency:(l,e)=>!l||!e||l<=0?0:Math.min(2,e/l),calculateEfficiencyMetrics:(l,e,t,s)=>{const r=de.calculateEfficiency(l,e),i=l>0?t/(l/60):0,n=s>0?Math.min(1,l/s):0,a=(r*.7+n*.3)*100;return{efficiency:r,piecesPerHour:i,timeUtilization:n,productivityIndex:Math.round(a)}},calculateDailyMetrics:l=>{const e=l.reduce((i,n)=>i+(n.completedPieces||0),0),t=l.reduce((i,n)=>i+(n.timeSpent||0),0),s=l.length>0?l.reduce((i,n)=>i+(n.efficiency||0),0)/l.length:0,r=l.length>0?l.reduce((i,n)=>i+(n.qualityScore||1),0)/l.length:1;return{totalPieces:e,totalTime:t,averageEfficiency:s,bundlesCompleted:l.length,piecesPerHour:t>0?e/(t/60):0,qualityScore:r}},calculateLineEfficiency:l=>l.length===0?0:l.reduce((t,s)=>t+(s.efficiency||0),0)/l.length},Me={generateRecommendations:(l,e)=>{let t=50;const s=[],r=ee.calculateMatchScore(l,e);if(r.machineCompatibilityScore>=50)t+=40,s.push("Perfect machine match");else if(r.machineCompatibilityScore>=25)t+=20,s.push("Related machine experience");else return t=10,s.push("Machine mismatch"),{match:t,reasons:s};return r.skillLevelScore>=30?(t+=15,s.push("Suitable skill level")):r.skillLevelScore>=20&&(t+=10,s.push("Adequate skill level")),r.workloadScore>=15?(t+=10,s.push("Good availability")):r.workloadScore>=5&&(t+=5,s.push("Limited availability")),(l.priority==="urgent"||l.priority==="high")&&(t+=5,s.push("High priority work")),e.averageEfficiency>.85&&e.qualityScore>.9?(t+=10,s.push("Excellent performer")):(e.averageEfficiency>.75||e.qualityScore>.85)&&(t+=5,s.push("Good performer")),(l.estimatedTime||l.standardTime||30)<30&&(t+=5,s.push("Quick work")),{match:Math.min(t,100),reasons:s.slice(0,3)}}},X={TIME_MULTIPLIER:1.9,calculateTimeFromRate:l=>parseFloat((l*X.TIME_MULTIPLIER).toFixed(1)),calculateRateFromTime:l=>parseFloat((l/X.TIME_MULTIPLIER).toFixed(2)),calculateStandardTime:(l,e,t)=>{const s=1+(e-5)*.1,i={manual:1.3,overlock:1,flatlock:1.1,buttonhole:1.2,cutting:.8,pressing:.9}[t]||1;return l*s*i}},R={paymentLogic:F,workAssignmentLogic:ee,qualityLogic:ue,metricsLogic:de,recommendationEngine:Me,operationRateService:X};class Le{static async createOperator(e){try{const t=I.validateOperatorCreation(e);if(!t.isValid)return{success:!1,error:t.errors.join(", "),code:"VALIDATION_FAILED"};const s={...e,createdAt:y(),updatedAt:y(),active:!0,realtimeStatus:{status:"idle",currentWorkItems:0,lastUpdated:y()}},r=await j(C(h,g.OPERATORS),s);return await j(C(h,g.OPERATOR_WALLETS),{operatorId:r.id,availableAmount:0,heldAmount:0,totalEarned:0,heldBundles:[],canWithdraw:!0,lastUpdated:y(),createdAt:y()}),await U(A(S,`${k.OPERATOR_STATUS}/${r.id}`),{status:"idle",currentWorkItems:0,lastUpdated:_(),currentLocation:e.defaultStation||"unassigned",machineStatus:"ready"}),{success:!0,data:{id:r.id,...s},metadata:{warnings:t.warnings,validationPassed:!0}}}catch(t){return console.error("Error creating operator:",t),{success:!1,error:t instanceof Error?t.message:"Failed to create operator",code:"CREATION_FAILED"}}}static async getOperatorPerformance(e){try{const t=await K(b(h,g.OPERATORS,e));if(!t.exists())return{success:!1,error:"Operator not found",code:"NOT_FOUND"};const s={id:t.id,...t.data()},r=I.analyzePerformance(s);return{success:!0,data:{operator:s,performance:r,timestamp:new Date().toISOString()}}}catch(t){return console.error("Error getting operator performance:",t),{success:!1,error:t instanceof Error?t.message:"Failed to get performance",code:"PERFORMANCE_FETCH_FAILED"}}}static async updateOperatorStatus(e,t,s){try{const r=oe(h),i=b(h,g.OPERATORS,e);if(r.update(i,{...t,updatedAt:y(),updatedBy:s}),t.currentStatus){const n=A(S,`${k.OPERATOR_STATUS}/${e}`);await Se(n,{status:t.currentStatus,lastUpdated:_()})}return await r.commit(),{success:!0,data:{operatorId:e,updates:t}}}catch(r){return console.error("Error updating operator:",r),{success:!1,error:r instanceof Error?r.message:"Failed to update operator",code:"UPDATE_FAILED"}}}}class We{static async createWorkAssignment(e){try{const t=le(C(h,g.OPERATORS),J("active","==",!0),J("currentStatus","==","idle")),i=(await ve(t)).docs.map(o=>({id:o.id,...o.data()})).map(o=>({operator:o,recommendation:R.recommendationEngine.generateRecommendations(e,o),matchScore:R.workAssignmentLogic.calculateMatchScore(e,o)}));i.sort((o,c)=>c.matchScore.totalScore-o.matchScore.totalScore);const n={...e,status:"available",priority:R.workAssignmentLogic.calculatePriorityScore(e),aiRecommendations:i.slice(0,5),createdAt:y(),updatedAt:y()},a=await j(C(h,g.WORK_ITEMS),n);return await U(A(S,`${k.AVAILABLE_WORK}/${a.id}`),{...n,createdAt:_()}),{success:!0,data:{id:a.id,...n,topRecommendations:i.slice(0,3)}}}catch(t){return console.error("Error creating work assignment:",t),{success:!1,error:t instanceof Error?t.message:"Failed to create work assignment",code:"ASSIGNMENT_CREATION_FAILED"}}}static async processSelfAssignment(e,t,s){try{return await ce(h,async r=>{const i=b(h,g.WORK_ITEMS,e),n=b(h,g.OPERATORS,t),[a,o]=await Promise.all([r.get(i),r.get(n)]);if(!a.exists()||!o.exists())throw new Error("Work item or operator not found");const c=a.data(),u=o.data();if(c?.status!=="available")throw new Error("Work item is no longer available");const d=I.validateWorkAssignment(u,{machineType:c?.machineType,estimatedDuration:c?.estimatedDuration||30,skillRequired:c?.requiredSkillLevel||"beginner",priority:c?.priority||"normal"});if(!d.canAssign)throw new Error(d.reason||"Cannot assign work");r.update(i,{status:"assigned",operatorId:t,assignedAt:y(),assignmentType:"self_assigned",assignmentReason:s,assignmentValidation:d});const p=u.realtimeStatus?.currentWorkItems||0;r.update(n,{currentStatus:"working","realtimeStatus.currentWorkItems":p+1,"realtimeStatus.lastUpdated":y()});const f={workItemId:e,operatorId:t,assignedAt:y(),assignmentType:"self_assigned",status:"active",validation:d,reason:s},w=b(C(h,g.WORK_ASSIGNMENTS));return r.set(w,f),{success:!0,data:{assignmentId:w.id,workItemId:e,operatorId:t,validation:d}}})}catch(r){return console.error("Error processing self-assignment:",r),{success:!1,error:r instanceof Error?r.message:"Assignment failed",code:"SELF_ASSIGNMENT_FAILED"}}}}class qe{static async processDamageReport(e){try{return await ce(h,async t=>{const s=b(h,g.WORK_ITEMS,e.workItemId),r=b(h,g.OPERATORS,e.operatorId),[i,n]=await Promise.all([t.get(s),t.get(r)]);if(!i.exists()||!n.exists())throw new Error("Work item or operator not found");const a=i.data(),o=n.data(),c=R.paymentLogic.calculateDamageAwarePayment({rate:a?.ratePerPiece||0,totalPieces:a?.totalPieces||0},{piecesCompleted:a?.completedPieces||0,efficiency:o.averageEfficiency,qualityScore:o.qualityScore},[e]),u={...e,paymentImpact:c,status:"reported",reportedAt:y(),resolved:!1},d=b(C(h,g.DAMAGE_REPORTS));if(t.set(d,u),e.operatorFault&&c.penalties>0){const f=le(C(h,g.OPERATOR_WALLETS),J("operatorId","==",e.operatorId),ye(1));t.update(r,{"paymentStatus.held":!0,"paymentStatus.heldAmount":c.penalties,"paymentStatus.reason":"damage_reported",updatedAt:y()})}const p=R.qualityLogic.calculateQualityMetrics(a?.completedPieces||0,[e]);return t.update(s,{qualityScore:p.qualityScore,defectRate:p.defectRate,qualityMetrics:p,lastDamageReport:d.id,updatedAt:y()}),{success:!0,data:{damageReportId:d.id,paymentImpact:c,qualityMetrics:p,actionTaken:e.operatorFault?"payment_held":"no_penalty"}}})}catch(t){return console.error("Error processing damage report:",t),{success:!1,error:t instanceof Error?t.message:"Failed to process damage report",code:"DAMAGE_PROCESSING_FAILED"}}}}class Fe{static async processAssignmentApproval(e,t,s,r){try{const i=await K(b(h,g.WORK_ASSIGNMENTS,e));if(!i.exists())return{success:!1,error:"Assignment request not found",code:"NOT_FOUND"};const n=i.data(),a=await K(b(h,g.SUPERVISORS,t));if(!a.exists())return{success:!1,error:"Supervisor not found",code:"UNAUTHORIZED"};const o=a.data(),c={status:s==="approve"?"approved":"rejected",processedBy:t,processedAt:y(),processingNotes:r,finalDecision:s};if(await fe(b(h,g.WORK_ASSIGNMENTS,e),c),s==="approve"){const u=oe(h),d=b(h,g.WORK_ITEMS,n.workItemId);u.update(d,{status:"assigned",supervisorApproved:!0,approvedBy:t,approvedAt:y()});const p=b(h,g.OPERATORS,n.operatorId);u.update(p,{currentStatus:"working","realtimeStatus.currentWorkItems":ge(1),"realtimeStatus.lastUpdated":y()}),await u.commit()}return{success:!0,data:{requestId:e,decision:s,processedBy:t,notes:r}}}catch(i){return console.error("Error processing assignment approval:",i),{success:!1,error:i instanceof Error?i.message:"Failed to process approval",code:"APPROVAL_PROCESSING_FAILED"}}}}class Ue{static listeners=new Map;static subscribeToOperatorStatus(e,t){const s=A(S,`${k.OPERATOR_STATUS}/${e}`),r=z(s,n=>{const a=n.val();t(a)}),i=`operator_${e}`;return this.listeners.set(i,r),()=>{r(),this.listeners.delete(i)}}static subscribeToAvailableWork(e){const t=A(S,k.AVAILABLE_WORK),s=z(t,i=>{const n=i.val(),a=n?Object.keys(n).map(o=>({id:o,...n[o]})):[];e(a)}),r="available_work";return this.listeners.set(r,s),()=>{s(),this.listeners.delete(r)}}static cleanup(){this.listeners.forEach(e=>{e()}),this.listeners.clear()}}const D={operator:Le,workAssignment:We,quality:qe,supervisor:Fe,realtime:Ue};class Be{workflows=new Map;transitions=new Map;listeners=new Map;registerWorkflow(e){this.workflows.set(e.id,e)}registerTransitions(e,t){this.transitions.set(e,t)}async startWorkflow(e,t,s="normal"){try{const r=`${e}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,i={id:r,name:this.getWorkflowName(e),type:e,steps:this.getWorkflowSteps(e),currentStep:this.getWorkflowSteps(e)[0]?.id||"",status:"initialized",priority:s,createdAt:new Date,updatedAt:new Date,context:t,notifications:[]};return this.workflows.set(r,i),await this.moveToNextStep(r),{success:!0,workflowId:r}}catch(r){return console.error("Error starting workflow:",r),{success:!1,error:r instanceof Error?r.message:"Failed to start workflow"}}}async moveToNextStep(e){try{const t=this.workflows.get(e);if(!t)return{success:!1,error:"Workflow not found"};const s=t.steps.find(a=>a.id===t.currentStep);if(!s)return{success:!1,error:"Current step not found"};const r=s.dependencies.filter(a=>t.steps.find(c=>c.id===a)?.status!=="completed");if(r.length>0)return{success:!1,error:`Unmet dependencies: ${r.join(", ")}`};const i=await this.executeStep(t,s);if(!i.success)return s.status="failed",t.status="failed",this.addNotification(t,"error",i.error||"Step execution failed"),i;s.status="completed",s.completedAt=new Date,s.startedAt&&(s.actualDuration=s.completedAt.getTime()-s.startedAt.getTime());const n=this.findNextStep(t);return n?(t.currentStep=n.id,n.status="in_progress",n.startedAt=new Date,t.status="running"):(t.status="completed",t.completedAt=new Date,this.addNotification(t,"success","Workflow completed successfully")),t.updatedAt=new Date,this.notifyListeners(e,t),{success:!0}}catch(t){return console.error("Error moving to next step:",t),{success:!1,error:t instanceof Error?t.message:"Failed to move to next step"}}}async executeStep(e,t){try{switch(e.type){case"work_assignment":return await this.executeWorkAssignmentStep(e,t);case"quality_control":return await this.executeQualityControlStep(e,t);case"damage_resolution":return await this.executeDamageResolutionStep(e,t);case"payment_processing":return await this.executePaymentProcessingStep(e,t);case"operator_onboarding":return await this.executeOperatorOnboardingStep(e,t);default:return{success:!1,error:`Unknown workflow type: ${e.type}`}}}catch(s){return console.error(`Error executing step ${t.id}:`,s),{success:!1,error:s instanceof Error?s.message:"Step execution failed"}}}async executeWorkAssignmentStep(e,t){const{context:s}=e;switch(t.id){case"validate_assignment":const r=I.validateWorkAssignment(s.operator,{machineType:s.workItem.machineType,estimatedDuration:s.workItem.estimatedDuration,skillRequired:s.workItem.requiredSkillLevel,priority:s.workItem.priority});return r.canAssign?(e.context.assignmentValidation=r,{success:!0,data:r}):{success:!1,error:r.reason};case"check_supervisor_approval":const i=Y.evaluateAssignmentRequest(s.assignmentRequest,s.supervisor,s.operator,s.workItem);return e.context.approvalDecision=i,i.shouldAutoApprove?{success:!0,data:{requiresApproval:!1}}:(this.addNotification(e,"info","Supervisor approval required"),t.assignedTo=s.supervisor.id,{success:!0,data:{requiresApproval:!0}});case"assign_work":const n=await D.workAssignment.processSelfAssignment(s.workItem.id,s.operator.id,s.assignmentRequest.reason);return n.success?(e.context.assignmentResult=n.data,this.addNotification(e,"success","Work assigned successfully"),{success:!0,data:n.data}):{success:!1,error:n.error};case"update_realtime_status":return await D.operator.updateOperatorStatus(s.operator.id,{currentStatus:"working",realtimeStatus:{status:"working",currentWorkItems:(s.operator.realtimeStatus?.currentWorkItems||0)+1,lastUpdated:new Date}});default:return{success:!1,error:`Unknown work assignment step: ${t.id}`}}}async executeQualityControlStep(e,t){const{context:s}=e;switch(t.id){case"assess_damage":const r=R.qualityLogic.calculateDefectImpact(s.damageReport.damageType,s.damageReport.affectedPieces,s.workItem.totalPieces);return e.context.damageImpact=r,{success:!0,data:r};case"determine_supervisor_action":const i=Y.evaluateQualityIssue(s.supervisor,{bundleId:s.workItem.bundleId,operatorId:s.operator.id,defectType:s.damageReport.damageType,severity:s.damageReport.severity,affectedPieces:s.damageReport.affectedPieces,totalPieces:s.workItem.totalPieces,customerOrder:s.workItem.isCustomerOrder||!1});return e.context.qualityDecision=i,this.addNotification(e,"info",`Quality action: ${i.action}`),{success:!0,data:i};case"process_payment_impact":const n=R.paymentLogic.calculateDamageAwarePayment({rate:s.workItem.ratePerPiece,totalPieces:s.workItem.totalPieces},{piecesCompleted:s.workItem.completedPieces,efficiency:s.operator.averageEfficiency,qualityScore:s.operator.qualityScore},[s.damageReport]);return e.context.paymentCalculation=n,{success:!0,data:n};case"create_damage_report":return await D.quality.processDamageReport({workItemId:s.workItem.id,operatorId:s.operator.id,supervisorId:s.supervisor.id,damageType:s.damageReport.damageType,severity:s.damageReport.severity,affectedPieces:s.damageReport.affectedPieces,description:s.damageReport.description,operatorFault:s.damageReport.operatorFault});default:return{success:!1,error:`Unknown quality control step: ${t.id}`}}}async executeDamageResolutionStep(e,t){return{success:!0,data:`Damage resolution step ${t.id} executed`}}async executePaymentProcessingStep(e,t){return{success:!0,data:`Payment processing step ${t.id} executed`}}async executeOperatorOnboardingStep(e,t){const{context:s}=e;switch(t.id){case"validate_operator_data":const r=I.validateOperatorCreation(s.operatorData);return r.isValid?(e.context.validation=r,{success:!0,data:r}):{success:!1,error:r.errors.join(", ")};case"create_operator_account":const i=await D.operator.createOperator(s.operatorData);return i.success?(e.context.operatorId=i.data?.id,{success:!0,data:i.data}):{success:!1,error:i.error};case"assign_training_tasks":const n=I.recommendTraining({...s.operatorData,id:e.context.operatorId});return e.context.trainingTasks=n,this.addNotification(e,"info",`${n.length} training tasks assigned`),{success:!0,data:n};default:return{success:!1,error:`Unknown onboarding step: ${t.id}`}}}getWorkflowName(e){return{work_assignment:"Work Assignment Process",quality_control:"Quality Control Process",damage_resolution:"Damage Resolution Process",payment_processing:"Payment Processing",operator_onboarding:"Operator Onboarding"}[e]||e}getWorkflowSteps(e){return{work_assignment:[{id:"validate_assignment",name:"Validate Assignment",status:"pending",dependencies:[],estimatedDuration:1e3},{id:"check_supervisor_approval",name:"Check Supervisor Approval",status:"pending",dependencies:["validate_assignment"],estimatedDuration:5e3},{id:"assign_work",name:"Assign Work",status:"pending",dependencies:["check_supervisor_approval"],estimatedDuration:2e3},{id:"update_realtime_status",name:"Update Realtime Status",status:"pending",dependencies:["assign_work"],estimatedDuration:1e3}],quality_control:[{id:"assess_damage",name:"Assess Damage Impact",status:"pending",dependencies:[],estimatedDuration:2e3},{id:"determine_supervisor_action",name:"Determine Supervisor Action",status:"pending",dependencies:["assess_damage"],estimatedDuration:3e3},{id:"process_payment_impact",name:"Process Payment Impact",status:"pending",dependencies:["determine_supervisor_action"],estimatedDuration:2e3},{id:"create_damage_report",name:"Create Damage Report",status:"pending",dependencies:["process_payment_impact"],estimatedDuration:1e3}],operator_onboarding:[{id:"validate_operator_data",name:"Validate Operator Data",status:"pending",dependencies:[],estimatedDuration:1e3},{id:"create_operator_account",name:"Create Operator Account",status:"pending",dependencies:["validate_operator_data"],estimatedDuration:3e3},{id:"assign_training_tasks",name:"Assign Training Tasks",status:"pending",dependencies:["create_operator_account"],estimatedDuration:2e3}]}[e]||[]}findNextStep(e){return e.steps.find(t=>t.status==="pending"&&t.dependencies.every(s=>e.steps.find(i=>i.id===s)?.status==="completed"))||null}addNotification(e,t,s,r=[]){e.notifications.push({type:t,message:s,timestamp:new Date,recipients:r,read:!1})}notifyListeners(e,t){(this.listeners.get(e)||[]).forEach(r=>{try{r(t)}catch(i){console.error("Error in workflow listener:",i)}})}getWorkflow(e){return this.workflows.get(e)||null}getAllWorkflows(){return Array.from(this.workflows.values())}subscribeToWorkflow(e,t){return this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t),()=>{const s=this.listeners.get(e)||[],r=s.indexOf(t);r>-1&&s.splice(r,1)}}async cancelWorkflow(e){const t=this.workflows.get(e);return t?(t.status="cancelled",t.updatedAt=new Date,this.addNotification(t,"warning","Workflow cancelled"),this.notifyListeners(e,t),{success:!0}):{success:!1,error:"Workflow not found"}}getWorkflowsByStatus(e){return Array.from(this.workflows.values()).filter(t=>t.status===e)}getWorkflowsByType(e){return Array.from(this.workflows.values()).filter(t=>t.type===e)}cleanup(){this.workflows.clear(),this.transitions.clear(),this.listeners.clear()}}const N=new Be;class Ve{static async createOperator(e){try{const t=await N.startWorkflow("operator_onboarding",{operatorData:e},"normal");return t.success?await this.waitForWorkflowCompletion(t.workflowId):{success:!1,error:t.error,code:"WORKFLOW_START_FAILED"}}catch(t){return console.error("Error in createOperator:",t),{success:!1,error:t instanceof Error?t.message:"Failed to create operator",code:"OPERATOR_CREATION_FAILED"}}}static async getOperatorWithAnalysis(e){try{const t=await D.operator.getOperatorPerformance(e);if(!t.success)return t;const s=t.data?.operator,r=t.data?.performance,i=I.evaluatePromotion(s),n=I.recommendTraining(s);return{success:!0,data:{operator:s,performance:r,promotionEligibility:i,trainingRecommendations:n,analysisTimestamp:new Date().toISOString()}}}catch(t){return console.error("Error getting operator analysis:",t),{success:!1,error:t instanceof Error?t.message:"Failed to get operator analysis",code:"OPERATOR_ANALYSIS_FAILED"}}}static async updateOperator(e,t,s){try{if(t.skillLevel||t.machineTypes||t.maxConcurrentWork){const i={id:e,...t},n=I.validateOperatorCreation(i);if(!n.isValid)return{success:!1,error:n.errors.join(", "),code:"VALIDATION_FAILED",metadata:{warnings:n.warnings}}}return await D.operator.updateOperatorStatus(e,t,s)}catch(r){return console.error("Error updating operator:",r),{success:!1,error:r instanceof Error?r.message:"Failed to update operator",code:"OPERATOR_UPDATE_FAILED"}}}static async processSelfAssignment(e,t,s){try{const r={id:e,machineType:"overlock",priority:"normal"},i={id:t,skillLevel:"intermediate"},n={id:"supervisor_1",supervisorLevel:"senior"},a=await N.startWorkflow("work_assignment",{workItem:r,operator:i,supervisor:n,assignmentRequest:{workItemId:e,operatorId:t,reason:s,requestedAt:new Date}},"normal");return a.success?{success:!0,data:{message:"Assignment workflow started",workflowId:a.workflowId},workflowId:a.workflowId}:{success:!1,error:a.error,code:"WORKFLOW_START_FAILED"}}catch(r){return console.error("Error processing self-assignment:",r),{success:!1,error:r instanceof Error?r.message:"Failed to process assignment",code:"ASSIGNMENT_PROCESSING_FAILED"}}}static async getWorkRecommendations(e){try{const t={id:e,machineTypes:["overlock","flatlock"],skillLevel:"advanced",averageEfficiency:.89,qualityScore:.94,currentAssignments:[]},s=[{id:"work_1",bundleNumber:"BDL-001",operation:"Side Seam",machineType:"overlock",requiredSkillLevel:"intermediate",estimatedDuration:45,priority:"high",complexity:6},{id:"work_2",bundleNumber:"BDL-002",operation:"Hem",machineType:"flatlock",requiredSkillLevel:"advanced",estimatedDuration:30,priority:"normal",complexity:7}],r=s.map(i=>{const n=R.recommendationEngine.generateRecommendations(i,t),a=R.workAssignmentLogic.calculateMatchScore(i,t);return{workItem:i,recommendation:n,matchScore:a,aiScore:n.match,reasons:n.reasons}});return r.sort((i,n)=>n.aiScore-i.aiScore),{success:!0,data:{operatorId:e,recommendations:r.slice(0,10),totalAvailable:s.length,generatedAt:new Date().toISOString()}}}catch(t){return console.error("Error getting work recommendations:",t),{success:!1,error:t instanceof Error?t.message:"Failed to get recommendations",code:"RECOMMENDATIONS_FAILED"}}}static async processDamageReport(e){try{const t={id:e.workItemId,bundleId:"bundle_1",totalPieces:100,completedPieces:80,ratePerPiece:10,isCustomerOrder:!0},s={id:e.operatorId,averageEfficiency:.85,qualityScore:.92},r={id:e.supervisorId,supervisorLevel:"senior"},i=await N.startWorkflow("quality_control",{damageReport:e,workItem:t,operator:s,supervisor:r},"high");return i.success?{success:!0,data:{message:"Quality control workflow started",workflowId:i.workflowId},workflowId:i.workflowId}:{success:!1,error:i.error,code:"WORKFLOW_START_FAILED"}}catch(t){return console.error("Error processing damage report:",t),{success:!1,error:t instanceof Error?t.message:"Failed to process damage report",code:"DAMAGE_PROCESSING_FAILED"}}}static async calculateOperatorPayment(e,t){try{const s=[];let r=0,i=0,n=0;for(const o of t){const c=o.damageReports||[],u=R.paymentLogic.calculateDamageAwarePayment({rate:o.ratePerPiece,totalPieces:o.totalPieces},{piecesCompleted:o.completedPieces,efficiency:o.efficiency,qualityScore:o.qualityScore},c);s.push({workItemId:o.workItemId,bundleNumber:o.bundleNumber,calculation:u}),r+=u.basePayment,i+=u.bonuses,n+=u.penalties}const a=r+i-n;return{success:!0,data:{operatorId:e,period:{startDate:new Date(Date.now()-10080*60*1e3),endDate:new Date},summary:{totalBasePayment:r,totalBonuses:i,totalPenalties:n,finalPayment:a,workItemsCompleted:t.length},calculations:s,generatedAt:new Date().toISOString()}}}catch(s){return console.error("Error calculating payment:",s),{success:!1,error:s instanceof Error?s.message:"Failed to calculate payment",code:"PAYMENT_CALCULATION_FAILED"}}}static async processAssignmentApproval(e,t,s,r){try{return await D.supervisor.processAssignmentApproval(e,t,s,r)}catch(i){return console.error("Error processing assignment approval:",i),{success:!1,error:i instanceof Error?i.message:"Failed to process approval",code:"APPROVAL_PROCESSING_FAILED"}}}static async getSupervisorDashboard(e){try{const t={id:e,supervisorLevel:"senior",teamMembers:["op1","op2","op3"],responsibleLines:["line1","line2"]},s=[{id:"op1",averageEfficiency:.85,qualityScore:.9},{id:"op2",averageEfficiency:.78,qualityScore:.88},{id:"op3",averageEfficiency:.92,qualityScore:.95}],r=Y.analyzeTeamProductivity(t,s,{completedWork:[],qualityIncidents:[],onTimeDeliveries:45,totalDeliveries:50});return{success:!0,data:{supervisor:t,teamProductivity:r,pendingApprovals:[],teamSize:s.length,dashboardGeneratedAt:new Date().toISOString()}}}catch(t){return console.error("Error getting supervisor dashboard:",t),{success:!1,error:t instanceof Error?t.message:"Failed to get dashboard",code:"DASHBOARD_FETCH_FAILED"}}}static async analyzeCompanyPerformance(){try{const e={totalOperators:50,activeOperators:45,averageEfficiency:.82,qualityScore:.88,onTimeDelivery:.91,customerSatisfactionScore:4.2},t={revenue:25e5,costs:18e5,profitMargin:.28,budgetUtilization:.85},s={marketShare:.15,competitorAnalysis:.72,growthRate:.08,customerRetentionRate:.89},r={efficiencyTrend:"up",qualityTrend:"stable",profitabilityTrend:"up"};return{success:!0,data:{performanceAnalysis:Ce.analyzeCompanyPerformance(e,t,s,r),rawData:{operational:e,financial:t,market:s,trends:r},analysisDate:new Date().toISOString()}}}catch(e){return console.error("Error analyzing company performance:",e),{success:!1,error:e instanceof Error?e.message:"Failed to analyze performance",code:"PERFORMANCE_ANALYSIS_FAILED"}}}static async waitForWorkflowCompletion(e,t=3e4){return new Promise(s=>{const r=Date.now(),i=()=>{const n=N.getWorkflow(e);if(!n){s({success:!1,error:"Workflow not found",code:"WORKFLOW_NOT_FOUND"});return}if(n.status==="completed"){s({success:!0,data:n.context,workflowId:e});return}if(n.status==="failed"){s({success:!1,error:"Workflow failed",code:"WORKFLOW_FAILED",data:n.context});return}if(Date.now()-r>t){s({success:!1,error:"Workflow timeout",code:"WORKFLOW_TIMEOUT"});return}setTimeout(i,100)};i()})}static getWorkflowStatus(e){const t=N.getWorkflow(e);return t?{success:!0,data:t}:{success:!1,error:"Workflow not found",code:"WORKFLOW_NOT_FOUND"}}static subscribeToWorkflow(e,t){return N.subscribeToWorkflow(e,t)}static getActiveWorkflows(){return{success:!0,data:N.getWorkflowsByStatus("running")}}}const ne=Ve;class W{static instance;connectionState={firestore:"disconnected",realtimedb:"disconnected",auth:"disconnected",lastCheck:new Date,isOnline:navigator.onLine};listeners=[];healthCheckInterval;reconnectTimeout;reconnectAttempts=0;maxReconnectAttempts=5;isEnablingNetwork=!1;isNetworkEnabled=!0;constructor(){this.initializeConnectionMonitoring()}static getInstance(){return W.instance||(W.instance=new W),W.instance}initializeConnectionMonitoring(){window.addEventListener("online",this.handleOnline.bind(this)),window.addEventListener("offline",this.handleOffline.bind(this)),this.startHealthCheck(),this.checkConnections()}handleOnline(){console.log("🌐 Network connection restored"),this.connectionState.isOnline=!0,this.attemptReconnection()}handleOffline(){console.log("📴 Network connection lost"),this.connectionState.isOnline=!1,this.updateConnectionState("firestore","disconnected"),this.updateConnectionState("realtimedb","disconnected"),this.updateConnectionState("auth","disconnected")}startHealthCheck(){this.healthCheckInterval=setInterval(()=>{this.checkConnections()},re.heartbeatInterval)}async checkConnections(){this.connectionState.lastCheck=new Date;try{!this.isEnablingNetwork&&!this.isNetworkEnabled&&(this.isEnablingNetwork=!0,await Q(h),this.isNetworkEnabled=!0,this.isEnablingNetwork=!1),this.updateConnectionState("firestore","connected"),this.reconnectAttempts=0}catch(e){this.isEnablingNetwork=!1,console.error("Firestore connection check failed:",e),this.updateConnectionState("firestore","error"),this.handleConnectionError("firestore")}try{const e=A(S,".info/connected");z(e,t=>{t.val()===!0?(this.updateConnectionState("realtimedb","connected"),this.reconnectAttempts=0):this.updateConnectionState("realtimedb","disconnected")})}catch(e){console.error("Realtime Database connection check failed:",e),this.updateConnectionState("realtimedb","error"),this.handleConnectionError("realtimedb")}try{be.currentUser!==void 0?this.updateConnectionState("auth","connected"):this.updateConnectionState("auth","disconnected")}catch(e){console.error("Auth connection check failed:",e),this.updateConnectionState("auth","error")}}updateConnectionState(e,t){this.connectionState[e]=t,this.notifyListeners()}handleConnectionError(e){this.reconnectAttempts<this.maxReconnectAttempts?this.scheduleReconnection():console.error(`⚠️ Max reconnection attempts reached for ${e}`)}scheduleReconnection(){this.reconnectTimeout&&clearTimeout(this.reconnectTimeout);const e=Math.min(re.retryDelay*Math.pow(2,this.reconnectAttempts),3e4);console.log(`🔄 Scheduling reconnection in ${e}ms (attempt ${this.reconnectAttempts+1})`),this.reconnectTimeout=setTimeout(()=>{this.attemptReconnection()},e)}async attemptReconnection(){if(!this.connectionState.isOnline){console.log("📴 Cannot reconnect: offline");return}this.reconnectAttempts++,console.log(`🔄 Attempting reconnection (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);try{!this.isEnablingNetwork&&!this.isNetworkEnabled&&(this.isEnablingNetwork=!0,await Q(h),this.isNetworkEnabled=!0,this.isEnablingNetwork=!1),ie(S),await this.checkConnections(),console.log("✅ Reconnection successful")}catch(e){this.isEnablingNetwork=!1,console.error("❌ Reconnection failed:",e),this.handleConnectionError("reconnection")}}getConnectionState(){return{...this.connectionState}}isConnected(){return this.connectionState.firestore==="connected"&&this.connectionState.realtimedb==="connected"}onConnectionChange(e){return this.listeners.push(e),e(this.getConnectionState()),()=>{const t=this.listeners.indexOf(e);t>-1&&this.listeners.splice(t,1)}}notifyListeners(){this.listeners.forEach(e=>{try{e(this.getConnectionState())}catch(t){console.error("Error in connection state listener:",t)}})}async forceReconnect(){console.log("🔄 Force reconnect requested"),this.reconnectAttempts=0,await this.attemptReconnection()}async goOffline(){console.log("📴 Going offline manually");try{this.isNetworkEnabled&&(await we(h),this.isNetworkEnabled=!1),Ae(S),this.updateConnectionState("firestore","disconnected"),this.updateConnectionState("realtimedb","disconnected")}catch(e){console.error("Error going offline:",e)}}async goOnline(){console.log("🌐 Going online manually");try{!this.isEnablingNetwork&&!this.isNetworkEnabled&&(this.isEnablingNetwork=!0,await Q(h),this.isNetworkEnabled=!0,this.isEnablingNetwork=!1),ie(S),await this.checkConnections()}catch(e){this.isEnablingNetwork=!1,console.error("Error going online:",e)}}cleanup(){this.healthCheckInterval&&clearInterval(this.healthCheckInterval),this.reconnectTimeout&&clearTimeout(this.reconnectTimeout),window.removeEventListener("online",this.handleOnline.bind(this)),window.removeEventListener("offline",this.handleOffline.bind(this)),this.listeners=[]}async connectToEmulators(){}getHealthMetrics(){return{uptime:Date.now()-this.connectionState.lastCheck.getTime(),reconnectAttempts:this.reconnectAttempts,lastSuccessfulConnection:this.connectionState.lastCheck,isHealthy:this.isConnected()&&this.connectionState.isOnline}}}const q=W.getInstance();class ze extends L{constructor(){super("users")}async getUserProfile(e){return this.getById(e)}async updateUserProfile(e,t){return await this.logUserActivity(e,"profile_update","User updated their profile",{updatedFields:Object.keys(t)}),this.update(e,t)}async getUsersByRole(e){return this.getWhere({field:"role",operator:"==",value:e},{orderByField:"name",orderDirection:"asc"})}async getAllUsers(e){try{const t=await this.getAll({orderByField:"name",orderDirection:"asc"});if(!t.success||!t.data)return t;let s=t.data;if(e&&(e.role&&(s=s.filter(r=>r.role===e.role)),e.department&&(s=s.filter(r=>r.department===e.department)),e.active!==void 0&&(s=s.filter(r=>r.active===e.active)),e.searchTerm)){const r=e.searchTerm.toLowerCase();s=s.filter(i=>i.name.toLowerCase().includes(r)||i.username.toLowerCase().includes(r)||i.email?.toLowerCase().includes(r)||i.department?.toLowerCase().includes(r))}return{success:!0,data:s}}catch(t){return console.error("Error filtering users:",t),{success:!1,error:t instanceof Error?t.message:"Unknown error occurred"}}}async createUser(e){const t={...e,active:!0,settings:{theme:"system",language:"en",notifications:{email:!0,push:!0,workAssignment:!0,qualityIssues:!0},...e.settings},activity:{lastSeen:new Date,totalLogins:0,workHours:0,completedTasks:0,...e.activity}};return await this.logSystemActivity("user_creation",`New user created: ${e.name}`,{newUserId:e.username,role:e.role}),this.create(t)}async deactivateUser(e,t){const s=await this.update(e,{active:!1});return s.success&&await this.logUserActivity(e,"account_deactivated","User account deactivated",{reason:t}),{success:s.success,error:s.error}}async activateUser(e){const t=await this.update(e,{active:!0});return t.success&&await this.logUserActivity(e,"account_activated","User account activated"),{success:t.success,error:t.error}}async updateUserRole(e,t,s){const r=await this.update(e,{role:t,permissions:s});return r.success&&await this.logUserActivity(e,"role_changed",`User role changed to ${t}`,{newRole:t,permissions:s}),{success:r.success,error:r.error}}async getUserActivity(e,t=50){return new L("user_activities").getWhere({field:"userId",operator:"==",value:e},{orderByField:"timestamp",orderDirection:"desc",limitCount:t})}async logUserActivity(e,t,s,r){try{const i=new L("user_activities"),n=await this.getById(e),a=n.success&&n.data?n.data.name:"Unknown User";await i.create({userId:e,userName:a,action:t,description:s,metadata:r,timestamp:se.now(),ipAddress:"unknown",userAgent:"unknown"})}catch(i){console.error("Error logging user activity:",i)}}async logSystemActivity(e,t,s){try{await new L("system_activities").create({action:e,description:t,metadata:s,timestamp:se.now()})}catch(r){console.error("Error logging system activity:",r)}}async getUserStats(){try{const e=await this.getAll();if(!e.success||!e.data)return{success:!1,error:"Failed to fetch users"};const t=e.data,r=await new L("user_activities").getAll({orderByField:"timestamp",orderDirection:"desc",limitCount:20});return{success:!0,data:{totalUsers:t.length,activeUsers:t.filter(n=>n.active).length,usersByRole:t.reduce((n,a)=>(n[a.role]=(n[a.role]||0)+1,n),{}),recentActivity:r.success?r.data||[]:[]}}}catch(e){return console.error("Error getting user stats:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error occurred"}}}async updateLastSeen(e){try{await this.update(e,{activity:{lastSeen:new Date}})}catch(t){console.error("Error updating last seen:",t)}}async searchUsers(e,t=20){const s=await this.getAllUsers({searchTerm:e});return s.success&&s.data?{success:!0,data:s.data.slice(0,t)}:s}subscribeToUser(e,t){return this.subscribeToDocument(e,t)}subscribeToAllUsers(e){return this.subscribeToCollection(e,void 0,{orderByField:"name",orderDirection:"asc"})}async bulkUpdateUsers(e,t){try{const s=e.map(a=>this.update(a,t)),r=await Promise.allSettled(s),i=r.filter(a=>a.status==="rejected").length,n=r.length-i;return i>0?{success:!1,error:`${i} out of ${r.length} updates failed`}:(await this.logSystemActivity("bulk_user_update",`Bulk updated ${n} users`,{userIds:e,updates:Object.keys(t)}),{success:!0})}catch(s){return console.error("Error in bulk user update:",s),{success:!1,error:s instanceof Error?s.message:"Unknown error occurred"}}}}new ze;class $e{apiEndpoint="/api/errors";performanceEndpoint="/api/performance";sessionId;userId;userRole;errorQueue=[];performanceQueue=[];isOnline=!0;maxQueueSize=100;flushInterval=1e4;errorEndpointAvailable=!0;performanceEndpointAvailable=!0;constructor(){this.sessionId=this.generateSessionId(),this.setupGlobalErrorHandlers(),this.setupPerformanceMonitoring(),this.setupNetworkStatusListener(),this.startPeriodicFlush()}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}setUser(e){this.userId=e.id,this.userRole=e.role}async captureException(e,t){const s=`error_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,r={id:s,message:e.message,name:e.name,stack:e.stack,timestamp:new Date().toISOString(),sessionId:this.sessionId,url:window.location.href,userAgent:navigator.userAgent,viewport:{width:window.innerWidth,height:window.innerHeight},user:{id:this.userId,role:this.userRole},level:t?.level||"error",contexts:{browser:{name:this.getBrowserName(),version:this.getBrowserVersion(),language:navigator.language,cookieEnabled:navigator.cookieEnabled,onLine:navigator.onLine},os:{platform:navigator.platform},device:{pixelRatio:window.devicePixelRatio,memory:navigator.deviceMemory,cores:navigator.hardwareConcurrency},performance:this.getPerformanceSnapshot(),...t?.contexts},tags:{environment:"production",version:"1.0.0",component:"frontend",...t?.tags},fingerprint:t?.fingerprint||[e.name,e.message],extra:t?.extra||{}};return this.queueError(r),s}captureMessage(e,t="info",s){const r={id:`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,message:e,level:t,timestamp:new Date().toISOString(),sessionId:this.sessionId,url:window.location.href,user:{id:this.userId,role:this.userRole},contexts:s?.contexts||{},tags:{environment:"production",version:"1.0.0",...s?.tags},extra:s?.extra||{}};this.queueError(r)}trackUserAction(e){const t={...e,sessionId:this.sessionId,userId:this.userId,userRole:this.userRole};this.sendUserAction(t)}recordPerformanceMetric(e){this.performanceQueue.push({...e,timestamp:new Date,tags:{sessionId:this.sessionId,userId:this.userId||"anonymous",...e.tags}}),this.performanceQueue.length>=this.maxQueueSize&&this.flushPerformanceMetrics()}recordWebVitals(){if(!("web-vital"in window)){if(window["web-vital"]=!0,"PerformanceObserver"in window)try{new PerformanceObserver(i=>{const n=i.getEntries(),a=n[n.length-1];this.recordPerformanceMetric({name:"largest-contentful-paint",value:a.startTime,unit:"ms",timestamp:new Date,tags:{metric:"core-web-vital"}})}).observe({type:"largest-contentful-paint",buffered:!0}),new PerformanceObserver(i=>{i.getEntries().forEach(a=>{this.recordPerformanceMetric({name:"first-input-delay",value:a.processingStart-a.startTime,unit:"ms",timestamp:new Date,tags:{metric:"core-web-vital"}})})}).observe({type:"first-input",buffered:!0});let s=0;new PerformanceObserver(i=>{i.getEntries().forEach(a=>{a.hadRecentInput||(s+=a.value)}),this.recordPerformanceMetric({name:"cumulative-layout-shift",value:s,unit:"score",timestamp:new Date,tags:{metric:"core-web-vital"}})}).observe({type:"layout-shift",buffered:!0})}catch(e){console.warn("Failed to set up Performance Observer:",e)}window.addEventListener("load",()=>{setTimeout(()=>{const e=performance.getEntriesByType("navigation")[0];e&&(this.recordPerformanceMetric({name:"page-load-time",value:e.loadEventEnd-e.loadEventStart,unit:"ms",timestamp:new Date}),this.recordPerformanceMetric({name:"dom-content-loaded",value:e.domContentLoadedEventEnd-e.domContentLoadedEventStart,unit:"ms",timestamp:new Date}),this.recordPerformanceMetric({name:"time-to-first-byte",value:e.responseStart-e.requestStart,unit:"ms",timestamp:new Date}))},0)})}}trackNetworkError(e,t,s,r){this.captureMessage(`Network Error: ${s} ${e} - ${t}`,"warning",{tags:{type:"network-error",url:e,method:s,status:t.toString()},extra:{error:r?.message,stack:r?.stack}})}setupGlobalErrorHandlers(){window.addEventListener("error",t=>{this.captureException(t.error||new Error(t.message),{contexts:{error_event:{filename:t.filename,lineno:t.lineno,colno:t.colno}},tags:{source:"window.onerror"}})}),window.addEventListener("unhandledrejection",t=>{const s=t.reason instanceof Error?t.reason:new Error(t.reason);this.captureException(s,{tags:{source:"unhandled-promise-rejection"},extra:{reason:t.reason}})});const e=window.fetch;window.fetch=async(...t)=>{const s=performance.now();try{const r=await e(...t),n=performance.now()-s;return this.recordPerformanceMetric({name:"api-call-duration",value:n,unit:"ms",timestamp:new Date,tags:{url:typeof t[0]=="string"?t[0]:t[0].url,method:t[1]?.method||"GET",status:r.status.toString()}}),r.ok||this.trackNetworkError(typeof t[0]=="string"?t[0]:t[0].url,r.status,t[1]?.method||"GET"),r}catch(r){const n=performance.now()-s;throw this.recordPerformanceMetric({name:"api-call-duration",value:n,unit:"ms",timestamp:new Date,tags:{url:typeof t[0]=="string"?t[0]:t[0].url,method:t[1]?.method||"GET",status:"error"}}),this.trackNetworkError(typeof t[0]=="string"?t[0]:t[0].url,0,t[1]?.method||"GET",r),r}}}setupPerformanceMonitoring(){if("PerformanceObserver"in window)try{new PerformanceObserver(t=>{t.getEntries().forEach(r=>{this.recordPerformanceMetric({name:"long-task",value:r.duration,unit:"ms",timestamp:new Date,tags:{type:"performance-issue"}})})}).observe({type:"longtask",buffered:!0})}catch(e){console.warn("Long task monitoring not supported:",e)}this.recordWebVitals()}setupNetworkStatusListener(){window.addEventListener("online",()=>{this.isOnline=!0,this.flushAllQueues()}),window.addEventListener("offline",()=>{this.isOnline=!1})}startPeriodicFlush(){setInterval(()=>{this.isOnline&&this.flushAllQueues()},this.flushInterval)}queueError(e){this.errorQueue.push(e),this.errorQueue.length>=this.maxQueueSize&&this.flushErrors()}async flushErrors(){if(this.errorQueue.length===0||!this.isOnline||!this.errorEndpointAvailable)return;const e=this.errorQueue.splice(0,this.maxQueueSize);try{const t=await fetch(this.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({errors:e})});if(t.status===404){this.errorEndpointAvailable=!1,H.logging.debugMode;return}if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`)}catch(t){t instanceof TypeError||t?.message?.includes("fetch")?(this.errorQueue.unshift(...e),console.error("Failed to send error reports (network error):",t)):this.errorEndpointAvailable=!1}}async flushPerformanceMetrics(){if(this.performanceQueue.length===0||!this.isOnline||!this.performanceEndpointAvailable)return;const e=this.performanceQueue.splice(0,this.maxQueueSize);try{const t=await fetch(this.performanceEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({metrics:e})});if(t.status===404){this.performanceEndpointAvailable=!1,H.logging.debugMode;return}if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`)}catch(t){t instanceof TypeError||t?.message?.includes("fetch")?(this.performanceQueue.unshift(...e),console.error("Failed to send performance metrics (network error):",t)):this.performanceEndpointAvailable=!1}}async sendUserAction(e){if(this.isOnline)try{const t=await fetch("/api/analytics/actions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(t.status===404&&H.logging.debugMode,!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`)}catch{}}flushAllQueues(){this.flushErrors(),this.flushPerformanceMetrics()}getBrowserName(){const e=navigator.userAgent;return e.includes("Chrome")?"Chrome":e.includes("Firefox")?"Firefox":e.includes("Safari")?"Safari":e.includes("Edge")?"Edge":"Unknown"}getBrowserVersion(){const t=navigator.userAgent.match(/(?:Chrome|Firefox|Safari|Edge)\/(\d+)/);return t?t[1]:"Unknown"}getPerformanceSnapshot(){return performance.memory?{memory:{used:performance.memory.usedJSHeapSize,total:performance.memory.totalJSHeapSize,limit:performance.memory.jsHeapSizeLimit},timing:performance.timing,navigation:performance.navigation}:{}}destroy(){this.flushAllQueues()}}const Qe=new $e;typeof window<"u"&&window.addEventListener("beforeunload",()=>{Qe.destroy()});class He extends L{constructor(){super("workAssignments")}static async atomicSelfAssign(e,t,s){const r=A(S,`${k.AVAILABLE_WORK}/${e}`);try{const i=await Ee(r,n=>{if(n&&!(n.assigned&&n.assignedTo)&&n.status==="available")return{...n,assigned:!0,assignedTo:t,assignedAt:_(),operatorName:s.name,operatorMachine:s.machineType,status:"assigned",assignmentMethod:"self-assign"}});return i.committed?(this.updateOperatorAssignment(t,e,i.snapshot.val()),{success:!0,workData:i.snapshot.val(),message:"Work assigned successfully"}):{success:!1,error:"Work already assigned to another operator",message:"Someone else got this work first!",code:"ASSIGNMENT_CONFLICT"}}catch(i){return console.error("Atomic assignment failed:",i),{success:!1,error:i instanceof Error?i.message:"Assignment failed",message:"Assignment failed due to system error",code:"SYSTEM_ERROR"}}}static async updateOperatorAssignment(e,t,s){try{const r=A(S,`${k.OPERATOR_STATUS}/${e}`);await U(r,{status:"working",currentWork:t,assignedAt:_(),workData:{workId:t,bundleId:s.bundleId,operation:s.operation,pieces:s.pieces},lastActivity:_()})}catch(r){console.error("Failed to update operator status:",r)}}static async releaseWork(e,t){try{const s=A(S,`${k.AVAILABLE_WORK}/${e}`);await U(s,{assigned:!1,assignedTo:null,assignedAt:null,operatorName:null,operatorMachine:null,status:"available",assignmentMethod:null,releasedAt:_(),releasedBy:t});const r=A(S,`${k.OPERATOR_STATUS}/${t}`);return await U(r,{status:"idle",currentWork:null,lastActivity:_()}),{success:!0,message:"Work released successfully"}}catch(s){return console.error("Failed to release work:",s),{success:!1,error:s instanceof Error?s.message:"Failed to release work",code:"RELEASE_FAILED"}}}static subscribeToAvailableWork(e){const t=A(S,k.AVAILABLE_WORK);return z(t,s=>{const r=s.val()||{},i=Object.entries(r).filter(([n,a])=>a.status==="available"&&!a.assigned).map(([n,a])=>({id:n,...a}));e(i)},s=>{console.error("Error subscribing to available work:",s),e([])})}static async testRaceCondition(e,t){return(await Promise.allSettled(t.map(r=>this.atomicSelfAssign(e,r,{name:`Operator ${r}`,machineType:"overlock"})))).map((r,i)=>({operatorId:t[i],result:r.status==="fulfilled"?r.value:{success:!1,error:r.reason?.message||"Unknown error"}}))}static validateAssignment(e,t){const s=[];let r=50;if(this.checkMachineCompatibility(e.machineType,t.requiredMachine))r+=40,s.push("Machine compatibility confirmed");else return r=10,s.push("Machine incompatibility detected"),{canAssign:!1,reasons:s,score:r};return(e.currentAssignments?.length||0)<3?(r+=10,s.push("Workload within limits")):s.push("Maximum workload reached"),{canAssign:r>=60,reasons:s,score:Math.min(r,100)}}static checkMachineCompatibility(e,t){const s={overlock:["overlock","ओभरलक","Overlock","OVERLOCK"],flatlock:["flatlock","फ्ल्यालक","Flatlock","FLATLOCK"],singleNeedle:["singleNeedle","single_needle","एकल सुई","Single Needle"],buttonhole:["buttonhole","बटनहोल","Buttonhole","BUTTONHOLE"],buttonAttach:["buttonAttach","button_attach","बटन जोड्ने"],iron:["iron","pressing","इस्त्री प्रेस"],cutting:["cutting","काट्ने मेसिन"],embroidery:["embroidery","कसिदाकारी मेसिन"],manual:["manual","हस्तकला काम"]};if(e==="multi-skill")return!0;for(const[r,i]of Object.entries(s))if(i.includes(e)&&i.includes(t))return!0;return!1}}new He;var Ge={};const B={breakpoints:{mobile:"320px",tablet:"768px",desktop:"1024px",widescreen:"1440px"},touch:{minTouchTarget:44,touchPadding:8,swipeThreshold:50,longPressDelay:500,doubleTapDelay:300,dragStartDelay:150,dragScrollThreshold:20,mobileSpacing:{xs:"4px",sm:"8px",md:"16px",lg:"24px",xl:"32px"}},performance:{lazyLoading:{rootMargin:"50px",threshold:.1,maxRetries:3},virtualScroll:{itemHeight:80,bufferSize:5,threshold:100},codeSplitting:{chunkSize:25e4,maxChunks:10,cacheGroups:{vendor:!0,common:!0,features:!0}},images:{lazyLoad:!0,webpSupport:!0,placeholder:"blur",sizes:{thumbnail:150,small:300,medium:600,large:1200},quality:{thumbnail:70,standard:85,high:95}},cache:{images:"7d",api:"5m",static:"1y",sw:"24h"}},i18n:{defaultLocale:"en",supportedLocales:["en","ne"],fallbackLocale:"en",nepali:{dateFormat:"ne-NP",numberFormat:"ne-NP",currency:"NPR",calendar:"nepali",direction:"ltr"},namespaces:["common","navigation","operators","work-assignment","production","quality","reports","settings"],loadPath:"/locales/{{lng}}/{{ns}}.json",interpolation:{escapeValue:!1}},notifications:{push:{vapidKey:Ge.REACT_APP_VAPID_KEY,serviceWorkerPath:"/sw.js",maxNotifications:10,defaultIcon:"/icons/notification-192x192.png",badge:"/icons/badge-72x72.png"},toast:{position:"top-right",duration:5e3,maxToasts:5,animation:"slide-down",closeButton:!0,pauseOnHover:!0},inApp:{maxVisible:3,grouping:!0,sound:!0,vibration:[200,100,200],priority:{critical:1,high:2,medium:3,low:4}},types:{system:{icon:"bell",color:"blue",sound:"notification.mp3"},assignment:{icon:"briefcase",color:"green",sound:"assignment.mp3"},quality:{icon:"shield-check",color:"orange",sound:"alert.mp3"},break:{icon:"coffee",color:"purple",sound:"gentle.mp3"},achievement:{icon:"trophy",color:"gold",sound:"success.mp3"}}},pwa:{manifest:{name:"TSA ERP - Work Management",shortName:"TSA ERP",description:"Complete work management system for TSA garment factory",startUrl:"/",display:"standalone",orientation:"portrait-primary",themeColor:"#2563eb",backgroundColor:"#ffffff",categories:["productivity","business","utilities"]},icons:[{src:"/icons/icon-72x72.png",sizes:"72x72",type:"image/png"},{src:"/icons/icon-96x96.png",sizes:"96x96",type:"image/png"},{src:"/icons/icon-128x128.png",sizes:"128x128",type:"image/png"},{src:"/icons/icon-144x144.png",sizes:"144x144",type:"image/png"},{src:"/icons/icon-152x152.png",sizes:"152x152",type:"image/png"},{src:"/icons/icon-192x192.png",sizes:"192x192",type:"image/png"},{src:"/icons/icon-384x384.png",sizes:"384x384",type:"image/png"},{src:"/icons/icon-512x512.png",sizes:"512x512",type:"image/png"}],offline:{cacheStrategy:"NetworkFirst",cacheName:"tsa-erp-v1",maxEntries:100,maxAgeSeconds:86400,precacheRoutes:["/","/operators","/work-assignments","/dashboard"],runtimeCaching:{api:"NetworkFirst",images:"CacheFirst",static:"StaleWhileRevalidate"}},updates:{checkInterval:36e5,showUpdatePrompt:!0,autoUpdate:!1,skipWaiting:!1}},accessibility:{keyboard:{enabled:!0,trapFocus:!0,skipLinks:!0,shortcuts:{search:["ctrl+k","cmd+k"],home:["ctrl+h","cmd+h"],assignments:["ctrl+a","cmd+a"],operators:["ctrl+o","cmd+o"],settings:["ctrl+,","cmd+,"],help:["?","f1"]}},screenReader:{announcements:!0,liveRegions:!0,skipToContent:!0,labelledBy:!0,describedBy:!0},colorBlind:{highContrast:!1,reducedMotion:!1,alternativeColors:!0,patterns:!0},textScaling:{minSize:12,maxSize:24,lineHeight:1.5,letterSpacing:.1}},animations:{respectReducedMotion:!0,durations:{fast:150,normal:300,slow:500,verySlow:800},easings:{easeOut:"cubic-bezier(0.25, 0.46, 0.45, 0.94)",easeIn:"cubic-bezier(0.55, 0.055, 0.675, 0.19)",easeInOut:"cubic-bezier(0.645, 0.045, 0.355, 1)",bounce:"cubic-bezier(0.68, -0.55, 0.265, 1.55)"},gestures:{swipe:{threshold:50,velocity:.3,duration:200},drag:{damping:.9,stiffness:300,mass:1}}},layout:{containers:{xs:"100%",sm:"540px",md:"720px",lg:"960px",xl:"1140px",xxl:"1320px"},grid:{columns:12,gutter:"24px",mobileGutter:"16px"},header:{height:"64px",mobileHeight:"56px",sticky:!0,shadow:!0},sidebar:{width:"280px",mobileWidth:"100%",collapsedWidth:"72px",breakpoint:"md"},content:{padding:"24px",mobilePadding:"16px",maxWidth:"1200px"}},theme:{colorModes:["light","dark","auto"],defaultMode:"light",colors:{primary:"#2563eb",secondary:"#64748b",success:"#10b981",warning:"#f59e0b",error:"#ef4444",info:"#3b82f6"},typography:{fontFamily:{sans:["Inter","system-ui","sans-serif"],mono:["JetBrains Mono","monospace"],nepali:["Noto Sans Devanagari","sans-serif"]},fontSize:{xs:"0.75rem",sm:"0.875rem",base:"1rem",lg:"1.125rem",xl:"1.25rem","2xl":"1.5rem","3xl":"1.875rem","4xl":"2.25rem"},fontWeight:{light:300,normal:400,medium:500,semibold:600,bold:700}}},search:{debounceDelay:300,minQueryLength:2,maxResults:50,highlightMatches:!0,scopes:[{id:"all",label:"All",icon:"search"},{id:"operators",label:"Operators",icon:"users"},{id:"work-items",label:"Work Items",icon:"briefcase"},{id:"bundles",label:"Bundles",icon:"package"},{id:"reports",label:"Reports",icon:"chart-bar"}],filters:{dateRange:!0,status:!0,priority:!0,tags:!0},recentSearches:{enabled:!0,maxItems:10,storageKey:"tsa-erp-recent-searches"}},loading:{skeletons:{enabled:!0,animation:"pulse",baseColor:"#f3f4f6",highlightColor:"#e5e7eb",borderRadius:"4px"},spinners:{size:{small:"16px",medium:"24px",large:"32px"},strokeWidth:2,color:"primary"},progress:{height:"4px",color:"primary",backgroundColor:"#e5e7eb",animation:!0}}};class je{swRegistration=null;installPrompt=null;isOnline=navigator.onLine;offlineQueue=[];syncInProgress=!1;constructor(){this.initializeEventListeners(),this.loadOfflineQueue()}async initialize(){try{if("serviceWorker"in navigator){if(window.location.hostname==="localhost"||window.location.port==="3000"){console.log("Development mode: Skipping Service Worker registration to avoid cache issues");const t=await navigator.serviceWorker.getRegistrations();for(const s of t)console.log("Unregistering existing service worker:",s.scope),await s.unregister();if("caches"in window){const s=await caches.keys();for(const r of s)console.log("Clearing cache:",r),await caches.delete(r)}return}this.swRegistration=await navigator.serviceWorker.register("/sw.js",{scope:"/"}),console.log("Service Worker registered:",this.swRegistration),this.swRegistration.addEventListener("updatefound",()=>{const t=this.swRegistration?.installing;t&&t.addEventListener("statechange",()=>{t.state==="installed"&&navigator.serviceWorker.controller&&this.notifyAppUpdate()})})}"Notification"in window&&Notification.permission==="default"&&await Notification.requestPermission(),console.log("PWA Service initialized successfully")}catch(e){throw console.error("PWA Service initialization failed:",e),e}}initializeEventListeners(){window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),this.installPrompt=e,console.log("Install prompt available")}),window.addEventListener("online",()=>{this.isOnline=!0,console.log("App is online"),this.syncOfflineQueue()}),window.addEventListener("offline",()=>{this.isOnline=!1,console.log("App is offline"),this.showOfflineNotification()}),window.addEventListener("appinstalled",()=>{console.log("App installed successfully"),this.installPrompt=null}),document.addEventListener("visibilitychange",()=>{!document.hidden&&this.isOnline&&this.offlineQueue.length>0&&this.syncOfflineQueue()})}canInstall(){return this.installPrompt!==null}async showInstallPrompt(){if(!this.installPrompt)return console.warn("Install prompt not available"),null;try{await this.installPrompt.prompt();const e=await this.installPrompt.userChoice;return console.log("Install prompt result:",e),e.outcome==="accepted"&&(this.installPrompt=null),e}catch(e){return console.error("Install prompt failed:",e),null}}isInstalled(){return window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0||document.referrer.includes("android-app://")}async showNotification(e){if(!this.swRegistration)throw new Error("Service Worker not registered");if(Notification.permission!=="granted"&&await Notification.requestPermission()!=="granted")throw new Error("Notification permission denied");const t={icon:B.pwa.icons.find(s=>s.sizes==="192x192")?.src||"/icons/icon-192x192.png",badge:"/icons/badge-72x72.png",vibrate:[200,100,200],requireInteraction:!1,...e};await this.swRegistration.showNotification(e.title,t)}async subscribeToPush(){if(!this.swRegistration)throw new Error("Service Worker not registered");const e=B.notifications.push.vapidKey;if(!e)return console.warn("VAPID key not configured"),null;try{const t=await this.swRegistration.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.urlBase64ToUint8Array(e)});return console.log("Push subscription created:",t),await this.sendSubscriptionToServer(t),t}catch(t){throw console.error("Push subscription failed:",t),t}}async unsubscribeFromPush(){if(!this.swRegistration)throw new Error("Service Worker not registered");const e=await this.swRegistration.pushManager.getSubscription();e&&(await e.unsubscribe(),console.log("Unsubscribed from push notifications"))}addToOfflineQueue(e,t="GET",s,r={}){const i={id:Date.now().toString()+Math.random().toString(36).substr(2,9),url:e,method:t,headers:r,body:s,timestamp:Date.now(),retries:0};this.offlineQueue.push(i),this.saveOfflineQueue(),console.log("Added to offline queue:",i),this.isOnline&&this.syncOfflineQueue()}async syncOfflineQueue(){if(this.syncInProgress||this.offlineQueue.length===0||!this.isOnline)return;this.syncInProgress=!0,console.log("Syncing offline queue:",this.offlineQueue.length,"items");const e=3,t=[];for(const s of this.offlineQueue)try{const r=await fetch(s.url,{method:s.method,headers:{"Content-Type":"application/json",...s.headers},body:s.body});if(r.ok)t.push(s.id),console.log("Synced offline item:",s.id);else throw new Error(`HTTP ${r.status}: ${r.statusText}`)}catch(r){console.error("Failed to sync offline item:",s.id,r),s.retries++,s.retries>=e&&(t.push(s.id),console.warn("Max retries reached, removing item:",s.id))}this.offlineQueue=this.offlineQueue.filter(s=>!t.includes(s.id)),this.saveOfflineQueue(),this.syncInProgress=!1,t.length>0&&this.showNotification({title:"Data Synchronized",body:`${t.length} offline actions have been synchronized.`,tag:"sync-complete"})}async requestBackgroundSync(e){if(!this.swRegistration)throw new Error("Service Worker not registered");if("sync"in this.swRegistration)try{await this.swRegistration.sync.register(e),console.log("Background sync registered:",e)}catch(t){throw console.error("Background sync registration failed:",t),t}else console.warn("Background sync not supported")}getOfflineQueueStatus(){const e=this.offlineQueue.filter(s=>s.retries>=3).length,t=localStorage.getItem("pwa-last-sync");return{pending:this.offlineQueue.length-e,failed:e,lastSync:t?new Date(parseInt(t)):null}}isOnlineStatus(){return this.isOnline}getAppInfo(){return{isInstalled:this.isInstalled(),canInstall:this.canInstall(),version:"1.0.0",isOnline:this.isOnline,swStatus:this.swRegistration?.active?"active":"inactive"}}urlBase64ToUint8Array(e){const t="=".repeat((4-e.length%4)%4),s=(e+t).replace(/-/g,"+").replace(/_/g,"/"),r=window.atob(s),i=new Uint8Array(r.length);for(let n=0;n<r.length;++n)i[n]=r.charCodeAt(n);return i}async sendSubscriptionToServer(e){try{if(!(await fetch("/api/notifications/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).ok)throw new Error("Failed to send subscription to server");console.log("Subscription sent to server successfully")}catch(t){console.error("Failed to send subscription to server:",t)}}saveOfflineQueue(){try{localStorage.setItem("pwa-offline-queue",JSON.stringify(this.offlineQueue))}catch(e){console.error("Failed to save offline queue:",e)}}loadOfflineQueue(){try{const e=localStorage.getItem("pwa-offline-queue");e&&(this.offlineQueue=JSON.parse(e),console.log("Loaded offline queue:",this.offlineQueue.length,"items"))}catch(e){console.error("Failed to load offline queue:",e),this.offlineQueue=[]}}notifyAppUpdate(){this.showNotification({title:"App Update Available",body:"A new version of TSA ERP is available. Restart the app to update.",tag:"app-update",actions:[{action:"update",title:"Update Now"},{action:"later",title:"Later"}],requireInteraction:!0})}showOfflineNotification(){this.showNotification({title:"You're Offline",body:"TSA ERP is now working in offline mode. Your data will sync when you're back online.",tag:"offline-mode"})}async updateServiceWorker(){if(!this.swRegistration)throw new Error("Service Worker not registered");try{await this.swRegistration.update(),console.log("Service Worker updated"),this.swRegistration.waiting&&(this.swRegistration.waiting.postMessage({type:"SKIP_WAITING"}),window.location.reload())}catch(e){throw console.error("Service Worker update failed:",e),e}}destroy(){this.syncInProgress=!1,this.saveOfflineQueue(),console.log("PWA Service destroyed")}}const Z=new je;typeof window<"u"&&Z.initialize().catch(console.error);class Ke{notifications=[];toastQueue=[];settings;subscribers=new Map;toastSubscribers=new Set;constructor(){this.settings=this.loadSettings(),this.initializeFirebaseListener(),this.registerServiceWorkerListeners()}async initialize(){try{if("Notification"in window&&Notification.permission==="default"){const e=await Notification.requestPermission();this.settings.pushEnabled=e==="granted",this.saveSettings()}await this.loadNotifications(),this.settings.pushEnabled&&await this.subscribeToPush(),console.log("Notification service initialized")}catch(e){throw console.error("Failed to initialize notification service:",e),e}}async sendNotification(e){const t={...e,id:this.generateNotificationId(),timestamp:new Date,read:!1};if(this.isNotificationEnabled(t)){if(this.isInQuietHours()){console.log("Notification suppressed due to quiet hours"),await this.saveNotificationToFirebase(t);return}await this.saveNotificationToFirebase(t),this.addNotification(t),this.settings.pushEnabled&&"serviceWorker"in navigator&&await this.sendPushNotification(t),!("serviceWorker"in navigator)&&"Notification"in window&&Notification.permission==="granted"&&await this.showBrowserNotification(t),this.settings.soundEnabled&&this.playNotificationSound(t.type),this.settings.vibrationEnabled&&"vibrate"in navigator&&this.vibrateDevice(t.priority),this.notifySubscribers(t)}}showToast(e){const t={...e,id:this.generateNotificationId(),duration:e.duration||B.notifications.toast.duration};this.toastQueue.push(t),this.notifyToastSubscribers(t),setTimeout(()=>{this.removeToast(t.id)},t.duration)}getNotifications(e){let t=[...this.notifications];return e&&(e.type&&(t=t.filter(s=>s.type===e.type)),e.read!==void 0&&(t=t.filter(s=>s.read===e.read)),e.priority&&(t=t.filter(s=>s.priority===e.priority)),e.limit&&(t=t.slice(0,e.limit))),t.sort((s,r)=>r.timestamp.getTime()-s.timestamp.getTime())}markAsRead(e){const t=this.notifications.find(s=>s.id===e);t&&!t.read&&(t.read=!0,this.saveNotifications())}markAllAsRead(e){let t=!1;this.notifications.forEach(s=>{!s.read&&(!e||s.type===e)&&(s.read=!0,t=!0)}),t&&this.saveNotifications()}deleteNotification(e){const t=this.notifications.findIndex(s=>s.id===e);t>-1&&(this.notifications.splice(t,1),this.saveNotifications())}clearNotifications(e){e?this.notifications=this.notifications.filter(t=>t.type!==e):this.notifications=[],this.saveNotifications()}getUnreadCount(e){return this.notifications.filter(t=>!t.read&&(!e||t.type===e)).length}subscribe(e,t){return this.subscribers.set(e,t),()=>{this.subscribers.delete(e)}}subscribeToToasts(e){return this.toastSubscribers.add(e),()=>{this.toastSubscribers.delete(e)}}updateSettings(e){this.settings={...this.settings,...e},this.saveSettings(),e.pushEnabled&&!this.settings.pushEnabled&&this.subscribeToPush()}getSettings(){return{...this.settings}}async testNotification(){await this.sendNotification({type:"system",title:"Test Notification",message:"This is a test notification to verify the system is working correctly.",priority:"medium"})}generateNotificationId(){return`notification_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}addNotification(e){this.notifications.unshift(e),this.notifications.length>100&&(this.notifications=this.notifications.slice(0,100)),this.saveNotifications()}isNotificationEnabled(e){return this.settings.inAppEnabled?this.settings.categories[e.type]!==!1:!1}isInQuietHours(){if(!this.settings.quietHours.enabled)return!1;const e=new Date,t=e.getHours()*60+e.getMinutes(),s=this.settings.quietHours.start.split(":"),r=this.settings.quietHours.end.split(":"),i=parseInt(s[0])*60+parseInt(s[1]),n=parseInt(r[0])*60+parseInt(r[1]);return i<=n?t>=i&&t<=n:t>=i||t<=n}async sendPushNotification(e){try{await Z.showNotification({title:e.title,body:e.message,icon:this.getNotificationIcon(e.type),badge:"/icons/badge-72x72.png",tag:e.type,data:e.data,actions:e.actions?.map(t=>({action:t.id,title:t.title}))})}catch(t){console.error("Failed to send push notification:",t)}}async showBrowserNotification(e){try{const t=new Notification(e.title,{body:e.message,icon:this.getNotificationIcon(e.type),badge:"/icons/badge-72x72.png",tag:e.type,data:e.data,requireInteraction:e.priority==="critical"});t.onclick=()=>{e.actionUrl&&window.open(e.actionUrl,"_blank"),t.close()},e.priority!=="critical"&&setTimeout(()=>{t.close()},5e3)}catch(t){console.error("Failed to show browser notification:",t)}}getNotificationIcon(e){const t=B.notifications.types[e];return t?`/icons/${t.icon}.png`:"/icons/notification-192x192.png"}playNotificationSound(e){try{const s=B.notifications.types[e]?.sound||"notification.mp3",r=new Audio(`/sounds/${s}`);r.volume=.5,r.play().catch(console.warn)}catch(t){console.warn("Failed to play notification sound:",t)}}vibrateDevice(e){const t={low:[100],medium:[200,100,200],high:[300,100,300,100,300],critical:[500,200,500,200,500]},s=t[e]||t.medium;navigator.vibrate(s)}notifySubscribers(e){this.subscribers.forEach(t=>{try{t(e)}catch(s){console.error("Notification subscriber error:",s)}})}notifyToastSubscribers(e){this.toastSubscribers.forEach(t=>{try{t(e)}catch(s){console.error("Toast subscriber error:",s)}})}removeToast(e){const t=this.toastQueue.findIndex(s=>s.id===e);t>-1&&this.toastQueue.splice(t,1)}async subscribeToPush(){try{await Z.subscribeToPush()}catch(e){console.error("Failed to subscribe to push notifications:",e)}}initializeFirebaseListener(){this.subscribeToFirebaseNotifications()}async saveNotificationToFirebase(e){try{console.log("Notification saved locally (Firebase disabled in development)")}catch(t){console.error("Failed to save notification to Firebase:",t)}}subscribeToFirebaseNotifications(){try{console.log("Firebase notification listener - using local mode for development")}catch(e){console.error("Failed to initialize Firebase notification listener:",e)}}registerServiceWorkerListeners(){"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("message",e=>{if(e.data&&e.data.type==="NOTIFICATION_CLICK"){const t=e.data.notification;this.handleNotificationClick(t)}})}handleNotificationClick(e){e.actionUrl&&window.open(e.actionUrl,"_blank");const t=this.notifications.find(s=>s.id===e.id);t&&this.markAsRead(t.id)}saveNotifications(){try{localStorage.setItem("tsa-erp-notifications",JSON.stringify(this.notifications.map(e=>({...e,timestamp:e.timestamp.toISOString()}))))}catch(e){console.error("Failed to save notifications:",e)}}async loadNotifications(){try{const e=localStorage.getItem("tsa-erp-notifications");if(e){const t=JSON.parse(e);this.notifications=t.map(s=>({...s,timestamp:new Date(s.timestamp)}))}}catch(e){console.error("Failed to load notifications:",e),this.notifications=[]}}saveSettings(){try{localStorage.setItem("tsa-erp-notification-settings",JSON.stringify(this.settings))}catch(e){console.error("Failed to save notification settings:",e)}}loadSettings(){try{const e=localStorage.getItem("tsa-erp-notification-settings");if(e)return{...this.getDefaultSettings(),...JSON.parse(e)}}catch(e){console.error("Failed to load notification settings:",e)}return this.getDefaultSettings()}getDefaultSettings(){return{pushEnabled:!1,emailEnabled:!0,inAppEnabled:!0,soundEnabled:!0,vibrationEnabled:!0,categories:{system:!0,assignment:!0,quality:!0,break:!0,achievement:!0,alert:!0},quietHours:{enabled:!1,start:"22:00",end:"08:00"}}}destroy(){this.subscribers.clear(),this.toastSubscribers.clear(),this.saveNotifications(),this.saveSettings(),console.log("Notification service destroyed")}}const Je=new Ke;typeof window<"u"&&Je.initialize().catch(console.error);const m={OPERATOR_VIEW_DASHBOARD:{id:"operator.view.dashboard",name:"View Operator Dashboard",description:"Can view operator dashboard with personal metrics",resource:"dashboard",action:"view"},OPERATOR_VIEW_WORK_ASSIGNMENTS:{id:"operator.view.work-assignments",name:"View Work Assignments",description:"Can view assigned work items",resource:"work-assignments",action:"view"},OPERATOR_SELF_ASSIGN_WORK:{id:"operator.assign.work.self",name:"Self-Assign Work",description:"Can assign work to themselves",resource:"work-assignments",action:"self-assign"},OPERATOR_VIEW_PERFORMANCE:{id:"operator.view.performance",name:"View Personal Performance",description:"Can view their own performance metrics",resource:"performance",action:"view"},OPERATOR_UPDATE_STATUS:{id:"operator.update.status",name:"Update Work Status",description:"Can update work item status and progress",resource:"work-items",action:"update-status"},SUPERVISOR_VIEW_DASHBOARD:{id:"supervisor.view.dashboard",name:"View Supervisor Dashboard",description:"Can view supervisor dashboard with team metrics",resource:"dashboard",action:"view"},SUPERVISOR_VIEW_TEAM:{id:"supervisor.view.team",name:"View Team Members",description:"Can view team member information and status",resource:"team",action:"view"},SUPERVISOR_ASSIGN_WORK:{id:"supervisor.assign.work",name:"Assign Work to Team",description:"Can assign work items to team members",resource:"work-assignments",action:"assign"},SUPERVISOR_APPROVE_ASSIGNMENTS:{id:"supervisor.approve.assignments",name:"Approve Work Assignments",description:"Can approve or reject work assignment requests",resource:"work-assignments",action:"approve"},SUPERVISOR_VIEW_TEAM_PERFORMANCE:{id:"supervisor.view.team-performance",name:"View Team Performance",description:"Can view performance metrics for team members",resource:"performance",action:"view-team"},SUPERVISOR_MANAGE_TEAM_SCHEDULE:{id:"supervisor.manage.schedule",name:"Manage Team Schedule",description:"Can manage team work schedules",resource:"schedule",action:"manage"},ADMIN_VIEW_DASHBOARD:{id:"admin.view.dashboard",name:"View Admin Dashboard",description:"Can view administrative dashboard with company-wide metrics",resource:"dashboard",action:"view"},ADMIN_MANAGE_USERS:{id:"admin.manage.users",name:"Manage Users",description:"Can create, update, and delete user accounts",resource:"users",action:"manage"},ADMIN_MANAGE_ROLES:{id:"admin.manage.roles",name:"Manage Roles",description:"Can create and modify user roles and permissions",resource:"roles",action:"manage"},ADMIN_VIEW_ALL_PERFORMANCE:{id:"admin.view.all-performance",name:"View All Performance Data",description:"Can view performance data for all users and departments",resource:"performance",action:"view-all"},ADMIN_MANAGE_PRODUCTION:{id:"admin.manage.production",name:"Manage Production",description:"Can manage production lines, machines, and workflows",resource:"production",action:"manage"},ADMIN_GENERATE_REPORTS:{id:"admin.generate.reports",name:"Generate Reports",description:"Can generate and export system reports",resource:"reports",action:"generate"},ADMIN_MANAGE_NOTIFICATIONS:{id:"admin.manage.notifications",name:"Manage Notifications",description:"Can send system-wide notifications and manage notification settings",resource:"notifications",action:"manage"},ADMIN_VIEW_ANALYTICS:{id:"admin.view.analytics",name:"View System Analytics",description:"Can view detailed system analytics and insights",resource:"analytics",action:"view"}},ae={OPERATOR:{id:"operator",name:"Operator",description:"Production line operator with basic permissions",permissions:[m.OPERATOR_VIEW_DASHBOARD,m.OPERATOR_VIEW_WORK_ASSIGNMENTS,m.OPERATOR_SELF_ASSIGN_WORK,m.OPERATOR_VIEW_PERFORMANCE,m.OPERATOR_UPDATE_STATUS]},SUPERVISOR:{id:"supervisor",name:"Supervisor",description:"Team supervisor with team management permissions",permissions:[m.SUPERVISOR_VIEW_DASHBOARD,m.SUPERVISOR_VIEW_TEAM,m.SUPERVISOR_ASSIGN_WORK,m.SUPERVISOR_APPROVE_ASSIGNMENTS,m.SUPERVISOR_VIEW_TEAM_PERFORMANCE,m.SUPERVISOR_MANAGE_TEAM_SCHEDULE,m.OPERATOR_VIEW_WORK_ASSIGNMENTS,m.OPERATOR_VIEW_PERFORMANCE,m.OPERATOR_UPDATE_STATUS]},ADMIN:{id:"admin",name:"Administrator",description:"System administrator with full permissions",permissions:[m.ADMIN_VIEW_DASHBOARD,m.ADMIN_MANAGE_USERS,m.ADMIN_MANAGE_ROLES,m.ADMIN_VIEW_ALL_PERFORMANCE,m.ADMIN_MANAGE_PRODUCTION,m.ADMIN_GENERATE_REPORTS,m.ADMIN_MANAGE_NOTIFICATIONS,m.ADMIN_VIEW_ANALYTICS,m.SUPERVISOR_VIEW_DASHBOARD,m.SUPERVISOR_VIEW_TEAM,m.SUPERVISOR_ASSIGN_WORK,m.SUPERVISOR_APPROVE_ASSIGNMENTS,m.SUPERVISOR_VIEW_TEAM_PERFORMANCE,m.SUPERVISOR_MANAGE_TEAM_SCHEDULE,m.OPERATOR_VIEW_DASHBOARD,m.OPERATOR_VIEW_WORK_ASSIGNMENTS,m.OPERATOR_SELF_ASSIGN_WORK,m.OPERATOR_VIEW_PERFORMANCE,m.OPERATOR_UPDATE_STATUS]}};class Ye{userPermissions=new Map;hasPermission(e,t){const s=this.userPermissions.get(e);if(!s)return!1;const r=s.role.permissions.some(n=>n.id===t),i=s.customPermissions?.some(n=>n.id===t)||!1;return r||i}hasAnyPermission(e,t){return t.some(s=>this.hasPermission(e,s))}hasAllPermissions(e,t){return t.every(s=>this.hasPermission(e,s))}getUserRole(e){return this.userPermissions.get(e)?.role||null}setUserPermissions(e,t,s){this.userPermissions.set(e,{userId:e,role:t,customPermissions:s})}setUserRole(e,t){const s=ae[t];s&&this.setUserPermissions(e,s)}getUserPermissions(e){const t=this.userPermissions.get(e);if(!t)return[];const s=t.role.permissions,r=t.customPermissions||[];return[...s,...r].filter((a,o,c)=>c.findIndex(u=>u.id===a.id)===o)}canAccessDashboard(e,t){switch(t){case"operator":return this.hasPermission(e,m.OPERATOR_VIEW_DASHBOARD.id);case"supervisor":return this.hasPermission(e,m.SUPERVISOR_VIEW_DASHBOARD.id);case"admin":return this.hasPermission(e,m.ADMIN_VIEW_DASHBOARD.id);default:return!1}}getPreferredDashboard(e){return this.canAccessDashboard(e,"admin")?"admin":this.canAccessDashboard(e,"supervisor")?"supervisor":this.canAccessDashboard(e,"operator")?"operator":null}async loadUserPermissions(e){try{const t=localStorage.getItem(`user-permissions-${e}`);if(t){const s=JSON.parse(t),r=ae[s.roleId];r&&this.setUserPermissions(e,r,s.customPermissions)}}catch(t){console.error("Failed to load user permissions:",t)}}async saveUserPermissions(e){try{const t=this.userPermissions.get(e);if(t){const s={roleId:t.role.id,customPermissions:t.customPermissions};localStorage.setItem(`user-permissions-${e}`,JSON.stringify(s))}}catch(t){console.error("Failed to save user permissions:",t)}}initializeDemoPermissions(){this.setUserRole("operator-001","OPERATOR"),this.setUserRole("operator","OPERATOR"),this.setUserRole("op-maya-001","OPERATOR"),this.setUserRole("supervisor-001","SUPERVISOR"),this.setUserRole("supervisor","SUPERVISOR"),this.setUserRole("sup","SUPERVISOR"),this.setUserRole("sup-john-001","SUPERVISOR"),this.setUserRole("admin-001","ADMIN"),this.setUserRole("admin","ADMIN"),this.setUserRole("administrator","ADMIN"),this.setUserRole("mgr-admin-001","ADMIN")}}const Xe=new Ye;typeof window<"u"&&Xe.initializeDemoPermissions();const ot={processAssignmentApproval:ne.processAssignmentApproval,getDashboard:ne.getSupervisorDashboard};q.getConnectionState,q.isConnected,q.forceReconnect,q.goOffline,q.goOnline;export{m as P,ot as a,R as b,I as o,Xe as p,Y as s,N as w};
