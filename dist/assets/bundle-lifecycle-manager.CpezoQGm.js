import{j as e}from"./query-vendor.BbCCZTU0.js";import{r as S}from"./react-vendor.BcnQP8kQ.js";import{C,d as q,e as F,a as O,B as f,f as W,g as z}from"./index.BnZjV7b3.js";import{I as D}from"./Input.D8gd7mOf.js";import{L as g}from"./label.BNDYRuzi.js";import{S as L,a as I,b as M,c as R,d as u}from"./select.BqvOc8nJ.js";import"./separator.DoYDqNAe.js";import{P as se,a as ne,b as re,C as ie}from"./popover.Bs9O0IEU.js";import{e as le,c as Y,s as w,q as k,o as oe,w as $,l as ce,a as de,d as A,g as ue,u as V,f as me}from"./firebase-vendor.BZUNkHzc.js";import{d as b}from"./firebase.BVb4kvNg.js";import{t as B}from"./index.wyP5CHuk.js";import{P as J,A as X,a as Z,C as U,b as he,c as pe,S as ge,d as ye,e as xe,f as je,U as ve,g as fe,h as we}from"./ui-vendor.B7YYMSVe.js";import{e as K,f as be}from"./utils-vendor.B0NEtgzl.js";import"./utils.k9sMftog.js";import"./index.D7kpLDHr.js";class Ne{collection="bundles";async createBundle(s,t){try{const r={bundleNumber:s.bundleNumber,description:s.description,quantity:s.quantity,unitPrice:s.unitPrice,totalValue:s.quantity*s.unitPrice,status:"planning",priority:s.priority,startDate:null,dueDate:s.dueDate,completionDate:null,assignedOperators:[],currentOperatorId:null,completedQuantity:0,defectQuantity:0,qualityScore:0,estimatedHours:s.estimatedHours,actualHours:0,workSessions:[],qualityChecks:[],createdAt:new Date,updatedAt:new Date,createdBy:t,notes:s.notes||"",attachments:[],tags:s.tags||[]};return(await le(Y(b,this.collection),{...r,createdAt:w(),updatedAt:w()})).id}catch(r){throw console.error("Error creating bundle:",r),r}}async getBundles(s){try{let t=k(Y(b,this.collection),oe("createdAt","desc"));return s?.status&&(t=k(t,$("status","==",s.status))),s?.assignedTo&&(t=k(t,$("assignedOperators","array-contains",s.assignedTo))),s?.priority&&(t=k(t,$("priority","==",s.priority))),s?.limit&&(t=k(t,ce(s.limit))),(await de(t)).docs.map(n=>({id:n.id,...n.data(),createdAt:n.data().createdAt?.toDate()||new Date,updatedAt:n.data().updatedAt?.toDate()||new Date,startDate:n.data().startDate?n.data().startDate.toDate():null,dueDate:n.data().dueDate.toDate(),completionDate:n.data().completionDate?n.data().completionDate.toDate():null}))}catch(t){throw console.error("Error getting bundles:",t),t}}async getBundleLifecycle(s){const t=await this.getBundleById(s);return t?{id:t.id,bundleId:t.bundleNumber,description:t.description,totalQuantity:t.quantity,completedQuantity:Math.floor(t.quantity*.3),currentStage:{id:"stage_1",name:"Cutting",nameNepali:"काट्ने",sequence:1,status:"in_progress",requiredQuantity:t.quantity,completedQuantity:Math.floor(t.quantity*.3)},stages:[{id:"stage_1",name:"Cutting",nameNepali:"काट्ने",sequence:1,status:"in_progress",requiredQuantity:t.quantity,completedQuantity:Math.floor(t.quantity*.3),machineType:"cutting_machine",estimatedHours:8,actualHours:3},{id:"stage_2",name:"Sewing",nameNepali:"सिलाई",sequence:2,status:"pending",requiredQuantity:t.quantity,completedQuantity:0,machineType:"sewing_machine",estimatedHours:16}],priority:t.priority,status:t.status==="planning"?"draft":"active",createdAt:t.createdAt,targetCompletionDate:t.dueDate,estimatedCompletionDate:t.dueDate,assignedOperators:t.assignedTo?[t.assignedTo]:[],notes:`Bundle ${t.bundleNumber} - ${t.description}`,qualityRequirements:[],costBreakdown:{materialCost:t.unitPrice*.6,laborCost:t.unitPrice*.3,overheadCost:t.unitPrice*.1,totalCost:t.unitPrice},attachments:[]}:null}async createBundleLifecycle(s){const t={bundleNumber:s.bundleId||`BDL${Date.now()}`,description:s.description||"New Bundle",quantity:s.totalQuantity||1,unitPrice:s.costBreakdown?.totalCost||0,priority:s.priority||"medium",dueDate:s.targetCompletionDate||new Date},r=await this.createBundle(t,"system");return this.getBundleLifecycle(r)}async updateBundleLifecycle(s,t){const r={description:t.description,quantity:t.totalQuantity,priority:t.priority,status:t.status==="draft"?"planning":"in-progress",dueDate:t.targetCompletionDate};return await this.updateBundle(s,r),this.getBundleLifecycle(s)}async getBundleById(s){try{const t=A(b,this.collection,s),r=await ue(t);if(!r.exists())return null;const n=r.data();return{id:r.id,...n,createdAt:n.createdAt?.toDate()||new Date,updatedAt:n.updatedAt?.toDate()||new Date,startDate:n.startDate?n.startDate.toDate():null,dueDate:n.dueDate.toDate(),completionDate:n.completionDate?n.completionDate.toDate():null}}catch(t){throw console.error("Error getting bundle:",t),t}}async updateBundle(s,t){try{const r=A(b,this.collection,s);await V(r,{...t,updatedAt:w(),...t.quantity&&t.unitPrice&&{totalValue:t.quantity*t.unitPrice}})}catch(r){throw console.error("Error updating bundle:",r),r}}async startWork(s,t,r){try{const n=A(b,this.collection,s),c=await this.getBundleById(s);if(!c)throw new Error("Bundle not found");const m={id:`session-${Date.now()}`,operatorId:t,operatorName:r,startTime:new Date,endTime:null,duration:0,quantityCompleted:0,defectQuantity:0,notes:"",isActive:!0},x=[...c.workSessions||[],m],y=Array.from(new Set([...c.assignedOperators,t]));await V(n,{status:"in-progress",startDate:c.startDate||w(),currentOperatorId:t,assignedOperators:y,workSessions:x,updatedAt:w()})}catch(n){throw console.error("Error starting work:",n),n}}async endWork(s,t,r,n=0,c=""){try{const m=await this.getBundleById(s);if(!m)throw new Error("Bundle not found");const x=m.workSessions.map(j=>{if(j.id===t&&j.isActive){const h=new Date,N=Math.round((h.getTime()-j.startTime.getTime())/(1e3*60));return{...j,endTime:h,duration:N,quantityCompleted:r,defectQuantity:n,notes:c,isActive:!1}}return j}),y=m.completedQuantity+r,d=m.defectQuantity+n,p=x.reduce((j,h)=>j+h.duration,0)/60,v=y>=m.quantity?"completed":"in-progress",P=v==="completed"?new Date:null,T=y>0?Math.max(0,100-d/y*100):100,H=A(b,this.collection,s);await V(H,{workSessions:x,completedQuantity:y,defectQuantity:d,actualHours:p,qualityScore:Math.round(T),status:v,completionDate:P?w():null,currentOperatorId:v==="completed"?null:m.currentOperatorId,updatedAt:w()})}catch(m){throw console.error("Error ending work:",m),m}}async deleteBundle(s){try{const t=A(b,this.collection,s);await me(t)}catch(t){throw console.error("Error deleting bundle:",t),t}}async getBundleAnalytics(){try{const s=await this.getBundles(),t=s.length,r=s.filter(d=>d.status==="completed").length,n=s.filter(d=>d.status==="in-progress").length,c=s.filter(d=>d.status==="completed"&&d.completionDate&&d.startDate),m=c.length>0?c.reduce((d,p)=>{const v=p.completionDate.getTime()-p.startDate.getTime();return d+v/(1e3*60*60*24)},0)/c.length:0,x=s.length>0?s.reduce((d,p)=>d+p.qualityScore,0)/s.length:100,y=s.reduce((d,p)=>d+p.totalValue,0);return{totalBundles:t,completedBundles:r,inProgressBundles:n,averageCompletionTime:Math.round(m*100)/100,averageQualityScore:Math.round(x),totalValue:y}}catch(s){throw console.error("Error getting bundle analytics:",s),s}}}const Q=new Ne,Ce=[{name:"Cutting",nameNepali:"काट्ने",machineType:"cutting",estimatedHours:2},{name:"Overlock",nameNepali:"ओभरलक",machineType:"overlock",estimatedHours:1.5},{name:"Flatlock",nameNepali:"फ्ल्यालक",machineType:"flatlock",estimatedHours:2},{name:"Button Hole",nameNepali:"बटन होल",machineType:"buttonhole",estimatedHours:3},{name:"Button Attach",nameNepali:"बटन लगाउने",machineType:"button_attach",estimatedHours:1},{name:"Quality Check",nameNepali:"गुणस्तर जाँच",machineType:"quality_check",estimatedHours:.5},{name:"Finishing",nameNepali:"फिनिशिङ",machineType:"finishing",estimatedHours:1},{name:"Pressing",nameNepali:"प्रेसिङ",machineType:"pressing",estimatedHours:.5}],De={draft:{label:"Draft",color:"bg-gray-100 text-gray-800",icon:ge},active:{label:"Active",color:"bg-blue-100 text-blue-800",icon:pe},on_hold:{label:"On Hold",color:"bg-yellow-100 text-yellow-800",icon:he},completed:{label:"Completed",color:"bg-green-100 text-green-800",icon:U},cancelled:{label:"Cancelled",color:"bg-red-100 text-red-800",icon:Z},archived:{label:"Archived",color:"bg-gray-100 text-gray-800",icon:X}},Be={low:{label:"Low",color:"bg-green-100 text-green-800"},medium:{label:"Medium",color:"bg-yellow-100 text-yellow-800"},high:{label:"High",color:"bg-orange-100 text-orange-800"},urgent:{label:"Urgent",color:"bg-red-100 text-red-800"}},Re=({mode:i,bundleId:s,onSave:t,onCancel:r})=>{const[n,c]=S.useState(null),[m,x]=S.useState(!1),[y,d]=S.useState(!1),[p,v]=S.useState("overview");S.useEffect(()=>{i!=="create"&&s?P():i==="create"&&T()},[i,s]);const P=async()=>{if(!s){i==="view"&&T();return}try{x(!0);const a=await Q.getBundleLifecycle(s);c(a)}catch(a){console.error("Error loading bundle:",a),B.error("Failed to load bundle data"),T()}finally{x(!1)}},T=()=>{const a={id:"",bundleId:`BDL${Date.now()}`,orderNumber:"",client:"",garmentType:"",totalQuantity:0,completedQuantity:0,currentStage:null,stages:Ce.map((o,l)=>({id:`stage_${l+1}`,name:o.name,nameNepali:o.nameNepali,sequence:l+1,status:"pending",requiredQuantity:0,completedQuantity:0,machineType:o.machineType,estimatedHours:o.estimatedHours,qualityCheckpoint:o.machineType==="quality_check",dependencies:l>0?[`stage_${l}`]:[],notes:""})),priority:"medium",status:"draft",createdAt:new Date,targetCompletionDate:K(new Date,7),estimatedCompletionDate:K(new Date,7),assignedOperators:[],notes:"",qualityRequirements:[],costBreakdown:{materialCost:0,laborCost:0,overheadCost:0,totalCost:0,profitMargin:0,sellingPrice:0},attachments:[]};c(a)},H=async()=>{if(n)try{d(!0);let a;i==="create"?(a=await Q.createBundleLifecycle(n),B.success("Bundle created successfully")):(a=await Q.updateBundleLifecycle(n.id,n),B.success("Bundle updated successfully")),c(a),t?.(a)}catch(a){console.error("Error saving bundle:",a),B.error("Failed to save bundle")}finally{d(!1)}},j=async()=>{if(n)try{const a={...n,id:"",bundleId:`BDL${Date.now()}`,status:"draft",completedQuantity:0,createdAt:new Date,startedAt:void 0,actualCompletionDate:void 0,stages:n.stages.map(l=>({...l,status:"pending",completedQuantity:0,startDate:void 0,endDate:void 0,actualHours:void 0}))},o=await Q.createBundleLifecycle(a);B.success("Bundle cloned successfully"),c(o)}catch{B.error("Failed to clone bundle")}},h=(a,o)=>{n&&c(l=>l?{...l,[a]:o}:null)},N=(a,o)=>{n&&c(l=>l?{...l,stages:l.stages.map(E=>E.id===a?{...E,...o}:E)}:null)},ee=()=>{if(!n)return;const a={id:`stage_${Date.now()}`,name:"New Stage",nameNepali:"नयाँ चरण",sequence:n.stages.length+1,status:"pending",requiredQuantity:n.totalQuantity,completedQuantity:0,machineType:"manual",estimatedHours:1,qualityCheckpoint:!1,dependencies:[],notes:""};c(o=>o?{...o,stages:[...o.stages,a]}:null)},te=a=>{n&&c(o=>o?{...o,stages:o.stages.filter(l=>l.id!==a)}:null)};if(m)return e.jsx(C,{children:e.jsx(q,{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})})});if(!n)return e.jsx(C,{children:e.jsxs(q,{className:"text-center py-8",children:[e.jsx(J,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Bundle Not Found"}),e.jsx("p",{className:"text-muted-foreground",children:"Unable to load bundle data"})]})});const _=De[n.status],G=Be[n.priority],ae=_.icon;return e.jsxs("div",{className:"space-y-6",children:[e.jsx(C,{children:e.jsx(F,{children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h2",{className:"text-2xl font-bold",children:n.bundleId}),e.jsxs(O,{className:_.color,children:[e.jsx(ae,{className:"h-4 w-4 mr-1"}),_.label]}),e.jsx(O,{className:G.color,children:G.label})]}),e.jsx("p",{className:"text-muted-foreground",children:i==="create"?"Create new bundle lifecycle":i==="edit"?"Edit bundle details and stages":"View bundle lifecycle and progress"})]}),e.jsxs("div",{className:"flex space-x-2",children:[i!=="create"&&e.jsxs(e.Fragment,{children:[e.jsxs(f,{variant:"outline",onClick:j,children:[e.jsx(ye,{className:"h-4 w-4 mr-2"}),"Clone"]}),n.status==="completed"&&e.jsxs(f,{variant:"outline",onClick:()=>h("status","archived"),children:[e.jsx(X,{className:"h-4 w-4 mr-2"}),"Archive"]})]}),i!=="view"&&e.jsxs(e.Fragment,{children:[e.jsx(f,{variant:"outline",onClick:r,children:"Cancel"}),e.jsxs(f,{onClick:H,disabled:y,children:[y?e.jsx(xe,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(U,{className:"h-4 w-4 mr-2"}),i==="create"?"Create Bundle":"Save Changes"]})]})]})]})})}),e.jsx(C,{children:e.jsx(q,{className:"pt-6",children:e.jsx("div",{className:"flex space-x-1 border-b",children:[{id:"overview",label:"Overview",icon:J},{id:"stages",label:"Stages",icon:je},{id:"quality",label:"Quality",icon:U},{id:"costs",label:"Costs",icon:ve}].map(a=>{const o=a.icon;return e.jsxs("button",{onClick:()=>v(a.id),className:`flex items-center space-x-2 px-4 py-2 rounded-t-lg transition-colors ${p===a.id?"bg-primary text-primary-foreground border-b-2 border-primary":"hover:bg-muted"}`,children:[e.jsx(o,{className:"h-4 w-4"}),e.jsx("span",{children:a.label})]},a.id)})})})}),p==="overview"&&e.jsxs(C,{children:[e.jsxs(F,{children:[e.jsx(W,{children:"Bundle Overview"}),e.jsx(z,{children:"Basic information and settings"})]}),e.jsxs(q,{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"orderNumber",children:"Order Number"}),e.jsx(D,{id:"orderNumber",value:n.orderNumber,onChange:a=>h("orderNumber",a.target.value),disabled:i==="view"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"client",children:"Client"}),e.jsx(D,{id:"client",value:n.client,onChange:a=>h("client",a.target.value),disabled:i==="view"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"garmentType",children:"Garment Type"}),e.jsx(D,{id:"garmentType",value:n.garmentType,onChange:a=>h("garmentType",a.target.value),disabled:i==="view"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"totalQuantity",children:"Total Quantity"}),e.jsx(D,{id:"totalQuantity",type:"number",value:n.totalQuantity,onChange:a=>h("totalQuantity",parseInt(a.target.value)),disabled:i==="view"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{children:"Priority"}),e.jsxs(L,{value:n.priority,onValueChange:a=>h("priority",a),disabled:i==="view",children:[e.jsx(I,{children:e.jsx(M,{})}),e.jsxs(R,{children:[e.jsx(u,{value:"low",children:"Low"}),e.jsx(u,{value:"medium",children:"Medium"}),e.jsx(u,{value:"high",children:"High"}),e.jsx(u,{value:"urgent",children:"Urgent"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{children:"Status"}),e.jsxs(L,{value:n.status,onValueChange:a=>h("status",a),disabled:i==="view",children:[e.jsx(I,{children:e.jsx(M,{})}),e.jsxs(R,{children:[e.jsx(u,{value:"draft",children:"Draft"}),e.jsx(u,{value:"active",children:"Active"}),e.jsx(u,{value:"on_hold",children:"On Hold"}),e.jsx(u,{value:"completed",children:"Completed"}),e.jsx(u,{value:"cancelled",children:"Cancelled"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{children:"Target Completion Date"}),e.jsxs(se,{children:[e.jsx(ne,{asChild:!0,children:e.jsxs(f,{variant:"outline",disabled:i==="view",children:[e.jsx(fe,{className:"h-4 w-4 mr-2"}),be(new Date(n.targetCompletionDate),"PPP")]})}),e.jsx(re,{className:"w-auto p-0",children:e.jsx(ie,{selected:new Date(n.targetCompletionDate),onSelect:a=>a&&h("targetCompletionDate",a),mode:"single"})})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"notes",children:"Notes"}),e.jsx("textarea",{id:"notes",className:"w-full min-h-[100px] p-3 border rounded-md",value:n.notes,onChange:a=>h("notes",a.target.value),disabled:i==="view",placeholder:"Add any additional notes or instructions..."})]})]})]}),p==="stages"&&e.jsxs(C,{children:[e.jsx(F,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(W,{children:"Production Stages"}),e.jsx(z,{children:"Configure the manufacturing workflow"})]}),i!=="view"&&e.jsxs(f,{onClick:ee,children:[e.jsx(we,{className:"h-4 w-4 mr-2"}),"Add Stage"]})]})}),e.jsx(q,{children:e.jsx("div",{className:"space-y-4",children:n.stages.map((a,o)=>e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-primary text-primary-foreground flex items-center justify-center text-sm font-bold",children:a.sequence}),e.jsxs("div",{children:[e.jsxs("h4",{className:"font-semibold",children:[a.name," (",a.nameNepali,")"]}),e.jsx(O,{className:a.status==="completed"?"bg-green-100 text-green-800":a.status==="in_progress"?"bg-blue-100 text-blue-800":a.status==="blocked"?"bg-red-100 text-red-800":"bg-gray-100 text-gray-800",children:a.status.replace("_"," ").toUpperCase()})]})]}),i!=="view"&&e.jsx(f,{variant:"ghost",size:"sm",onClick:()=>te(a.id),children:e.jsx(Z,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{children:"Stage Name"}),e.jsx(D,{value:a.name,onChange:l=>N(a.id,{name:l.target.value}),disabled:i==="view"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{children:"Machine Type"}),e.jsxs(L,{value:a.machineType,onValueChange:l=>N(a.id,{machineType:l}),disabled:i==="view",children:[e.jsx(I,{children:e.jsx(M,{})}),e.jsxs(R,{children:[e.jsx(u,{value:"cutting",children:"Cutting"}),e.jsx(u,{value:"overlock",children:"Overlock"}),e.jsx(u,{value:"flatlock",children:"Flatlock"}),e.jsx(u,{value:"buttonhole",children:"Buttonhole"}),e.jsx(u,{value:"button_attach",children:"Button Attach"}),e.jsx(u,{value:"embroidery",children:"Embroidery"}),e.jsx(u,{value:"quality_check",children:"Quality Check"}),e.jsx(u,{value:"finishing",children:"Finishing"}),e.jsx(u,{value:"pressing",children:"Pressing"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{children:"Estimated Hours"}),e.jsx(D,{type:"number",step:"0.5",value:a.estimatedHours,onChange:l=>N(a.id,{estimatedHours:parseFloat(l.target.value)}),disabled:i==="view"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx(g,{children:"Notes"}),e.jsx("textarea",{className:"w-full mt-1 p-2 border rounded",rows:2,value:a.notes,onChange:l=>N(a.id,{notes:l.target.value}),disabled:i==="view",placeholder:"Stage-specific notes or instructions..."})]})]},a.id))})})]})]})};export{Re as BundleLifecycleManager,Re as default};
