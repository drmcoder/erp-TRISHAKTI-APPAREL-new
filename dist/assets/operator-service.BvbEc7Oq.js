import{T as u,m as l,s as h,k as g,d as f,v as S,x as T}from"./firebase-vendor.BZUNkHzc.js";import{B as E}from"./base-service.9pve6B0A.js";import{C as d,d as m,r as c,a as o,R as n,s as p,b as y,o as A,l as O}from"./firebase.BVb4kvNg.js";const _=[{machineType:"overlock",displayName:"Overlock",nepaliName:"ओभरलक",category:"stitching",skillRequired:"intermediate",compatibleWith:["overlock","OVERLOCK"]},{machineType:"flatlock",displayName:"Flatlock",nepaliName:"फ्ल्यालक",category:"stitching",skillRequired:"intermediate",compatibleWith:["flatlock","FLATLOCK"]},{machineType:"singleNeedle",displayName:"Single Needle",nepaliName:"एकल सुई",category:"stitching",skillRequired:"beginner",compatibleWith:["singleNeedle","single_needle","Single Needle"]},{machineType:"buttonhole",displayName:"Buttonhole",nepaliName:"बटनहोल",category:"finishing",skillRequired:"advanced",compatibleWith:["buttonhole","Buttonhole","BUTTONHOLE"]},{machineType:"buttonAttach",displayName:"Button Attach",nepaliName:"बटन जोड्ने",category:"finishing",skillRequired:"intermediate",compatibleWith:["buttonAttach","button_attach"]},{machineType:"iron",displayName:"Iron/Press",nepaliName:"इस्त्री प्रेस",category:"pressing",skillRequired:"beginner",compatibleWith:["iron","pressing"]},{machineType:"cutting",displayName:"Cutting Machine",nepaliName:"काट्ने मेसिन",category:"cutting",skillRequired:"advanced",compatibleWith:["cutting"]},{machineType:"embroidery",displayName:"Embroidery Machine",nepaliName:"कसिदाकारी मेसिन",category:"finishing",skillRequired:"expert",compatibleWith:["embroidery"]},{machineType:"manual",displayName:"Manual Work",nepaliName:"हस्तकला काम",category:"manual",skillRequired:"beginner",compatibleWith:["manual"]}],I=[{value:"beginner",label:"Beginner",nepaliLabel:"शुरुवाती",experienceMonths:0},{value:"intermediate",label:"Intermediate",nepaliLabel:"मध्यम",experienceMonths:6},{value:"advanced",label:"Advanced",nepaliLabel:"उन्नत",experienceMonths:18},{value:"expert",label:"Expert",nepaliLabel:"विशेषज्ञ",experienceMonths:36}],L={working:{color:"green",label:"Working",nepaliLabel:"काम गर्दै",icon:"⚡"},break:{color:"yellow",label:"On Break",nepaliLabel:"विश्राममा",icon:"☕"},offline:{color:"gray",label:"Offline",nepaliLabel:"अफलाइन",icon:"⭕"},idle:{color:"blue",label:"Available",nepaliLabel:"उपलब्ध",icon:"✅"}};class b extends E{constructor(){super(d.OPERATORS)}async createOperator(r){try{const e=this.validateOperatorData(r);if(!e.isValid)return{success:!1,error:e.errors.join(", "),code:"VALIDATION_ERROR"};const t=await this.checkDuplicates(r.username,r.employeeId);if(!t.isValid)return{success:!1,error:t.error,code:"DUPLICATE_ERROR"};const a={...r,role:"operator",averageEfficiency:0,qualityScore:0,completedBundles:0,totalPieces:0,totalEarnings:0,isActive:!0,availabilityStatus:"available",currentAssignments:[],maxConcurrentWork:r.maxConcurrentWork||3,createdAt:u.now(),updatedAt:u.now()},s=await this.create(a);return s.success&&s.data&&(await this.initializeOperatorStatus(s.data.id,r.primaryMachine),await this.logActivity(s.data.id,"operator_created","Operator account created")),s}catch(e){return console.error("Error creating operator:",e),{success:!1,error:e instanceof Error?e.message:"Failed to create operator",code:"CREATION_FAILED"}}}async getOperatorWithStatus(r){try{const e=await this.getById(r);if(!e.success||!e.data)return e;const t=await this.getOperatorRealtimeStatus(r);return{success:!0,data:{...e.data,realtimeStatus:t}}}catch(e){return console.error("Error getting operator with status:",e),{success:!1,error:e instanceof Error?e.message:"Failed to get operator",code:"FETCH_FAILED"}}}async getOperatorsSummary(){try{const r=await this.getAll();return!r.success||!r.data?r:{success:!0,data:await Promise.all(r.data.map(async t=>{const a=await this.getOperatorRealtimeStatus(t.id);return{id:t.id,name:t.name,employeeId:t.employeeId,primaryMachine:t.primaryMachine,currentStatus:a.status,efficiency:t.averageEfficiency,qualityScore:t.qualityScore,currentWork:a.currentWork,avatar:t.avatar}}))}}catch(r){return console.error("Error getting operators summary:",r),{success:!1,error:r instanceof Error?r.message:"Failed to get operators",code:"FETCH_FAILED"}}}async updateOperator(r,e){try{if(e.username||e.employeeId){const a=await this.checkDuplicates(e.username,e.employeeId,r);if(!a.isValid)return{success:!1,error:a.error,code:"DUPLICATE_ERROR"}}const t=await this.update(r,{...e,updatedAt:u.now()});return t.success&&await this.logActivity(r,"profile_updated",`Profile updated: ${Object.keys(e).join(", ")}`),t}catch(t){return console.error("Error updating operator:",t),{success:!1,error:t instanceof Error?t.message:"Failed to update operator",code:"UPDATE_FAILED"}}}async updateOperatorStats(r,e){try{const t={};e.efficiency!==void 0&&(t.averageEfficiency=e.efficiency),e.qualityScore!==void 0&&(t.qualityScore=e.qualityScore),e.completedPieces!==void 0&&(t.totalPieces=l(e.completedPieces),t.completedBundles=l(1)),e.earnings!==void 0&&(t.totalEarnings=l(e.earnings)),t.updatedAt=h();const a=await this.update(r,t);return a.success&&await this.logActivity(r,"stats_updated",`Statistics updated: ${Object.keys(e).join(", ")}`),a}catch(t){return console.error("Error updating operator stats:",t),{success:!1,error:t instanceof Error?t.message:"Failed to update statistics",code:"STATS_UPDATE_FAILED"}}}async assignWork(r,e){try{const t=await this.getById(r);if(!t.success||!t.data)return{success:!1,error:"Operator not found",code:"OPERATOR_NOT_FOUND"};if(t.data.currentAssignments.length>=t.data.maxConcurrentWork)return{success:!1,error:`Operator at maximum capacity (${t.data.maxConcurrentWork} assignments)`,code:"CAPACITY_EXCEEDED"};const a=g(m),s=f(m,d.OPERATORS,r);a.update(s,{currentAssignments:S(e.bundleId),updatedAt:h()});const i=c(o,`${n.OPERATOR_STATUS}/${r}`);return await p(i,{status:"working",currentWork:e.workItemId,lastActivity:y(),machineStatus:"running"}),await a.commit(),await this.logActivity(r,"work_assigned",`Work assigned: ${e.bundleId} (${e.assignmentMethod})`),{success:!0,message:"Work assigned successfully"}}catch(t){return console.error("Error assigning work:",t),{success:!1,error:t instanceof Error?t.message:"Failed to assign work",code:"ASSIGNMENT_FAILED"}}}async completeWork(r,e){try{const t=g(m),a=f(m,d.OPERATORS,r);t.update(a,{currentAssignments:T(e.bundleId),totalPieces:l(e.completedPieces),completedBundles:l(1),updatedAt:h()});const s=c(o,`${n.OPERATOR_STATUS}/${r}`);return await p(s,{status:"idle",currentWork:null,lastActivity:y(),machineStatus:"stopped"}),await t.commit(),await this.updateOperatorStats(r,{efficiency:e.efficiency,qualityScore:e.qualityScore,completedPieces:e.completedPieces}),await this.logActivity(r,"work_completed",`Work completed: ${e.bundleId}, Pieces: ${e.completedPieces}, Quality: ${e.qualityScore}%`),{success:!0,message:"Work completed successfully"}}catch(t){return console.error("Error completing work:",t),{success:!1,error:t instanceof Error?t.message:"Failed to complete work",code:"COMPLETION_FAILED"}}}async getOperatorsByMachine(r){try{const e={field:"machineTypes",operator:"array-contains",value:r};return await this.getWhere(e,{orderByField:"averageEfficiency",orderDirection:"desc"})}catch(e){return console.error("Error getting operators by machine:",e),{success:!1,error:e instanceof Error?e.message:"Failed to get operators",code:"FETCH_FAILED"}}}async getOperatorsBySkill(r){try{const e={field:"skillLevel",operator:"==",value:r};return await this.getWhere(e,{orderByField:"qualityScore",orderDirection:"desc"})}catch(e){return console.error("Error getting operators by skill:",e),{success:!1,error:e instanceof Error?e.message:"Failed to get operators",code:"FETCH_FAILED"}}}async updateOperatorStatus(r,e){try{const t=c(o,`${n.OPERATOR_STATUS}/${r}`);return await p(t,{...e,lastActivity:y()}),{success:!0,message:"Status updated successfully"}}catch(t){return console.error("Error updating operator status:",t),{success:!1,error:t instanceof Error?t.message:"Failed to update status",code:"STATUS_UPDATE_FAILED"}}}subscribeToOperatorStatus(r,e){const t=c(o,`${n.OPERATOR_STATUS}/${r}`);return A(t,a=>{const s=a.exists()?a.val():null;e(s)},a=>{console.error("Error subscribing to operator status:",a),e(null)}),()=>O(t)}async getOperatorRealtimeStatus(r){return new Promise(e=>{const t=c(o,`${n.OPERATOR_STATUS}/${r}`);A(t,a=>{const s=a.exists()?a.val():{status:"offline",currentWork:null,lastActivity:Date.now(),machineStatus:"stopped"};e(s)},{onlyOnce:!0})})}async initializeOperatorStatus(r,e){const t=c(o,`${n.OPERATOR_STATUS}/${r}`);await p(t,{status:"offline",currentWork:null,lastActivity:y(),machineStatus:"stopped",primaryMachine:e})}validateOperatorData(r){const e=[];return(!r.username||r.username.length<3)&&e.push("Username must be at least 3 characters"),/^[a-zA-Z0-9_]+$/.test(r.username)||e.push("Username can only contain letters, numbers, and underscores"),(!r.name||r.name.length<2)&&e.push("Name must be at least 2 characters"),(!r.employeeId||!/^[A-Z0-9]+$/.test(r.employeeId))&&e.push("Employee ID must contain only uppercase letters and numbers"),r.email&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r.email)&&e.push("Invalid email format"),r.primaryMachine||e.push("Primary machine is required"),(!r.machineTypes||r.machineTypes.length===0)&&e.push("At least one machine type is required"),r.skillLevel||e.push("Skill level is required"),r.shift||e.push("Shift is required"),{isValid:e.length===0,errors:e}}async checkDuplicates(r,e,t){try{const a=await this.getWhere({field:"username",operator:"==",value:r});if(a.success&&a.data&&a.data.length>0){const i=a.data[0];if(!t||i.id!==t)return{isValid:!1,error:"Username already exists"}}const s=await this.getWhere({field:"employeeId",operator:"==",value:e});if(s.success&&s.data&&s.data.length>0){const i=s.data[0];if(!t||i.id!==t)return{isValid:!1,error:"Employee ID already exists"}}return{isValid:!0}}catch(a){return console.error("Error checking duplicates:",a),{isValid:!1,error:"Validation error"}}}async logActivity(r,e,t,a){try{const s=new E(d.USER_ACTIVITIES),i={operatorId:r,activityType:e,description:t,metadata:a,timestamp:u.now()};await s.create(i)}catch(s){console.error("Error logging activity:",s)}}}const N=new b;export{_ as M,I as S,L as a,N as o};
